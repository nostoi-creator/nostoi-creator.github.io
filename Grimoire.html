<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>NÃ³stoi â€” Grimoire</title>
<style>
:root {
  --bg:#0e0c09; --bg2:#161310; --bg3:#1c1814;
  --parchment:#c8b89a; --parchment-dim:#8a7a66; --parchment-dk:#4a3f32;
  --ink:#e8dece; --ink-dim:#a89880;
  --accent:#b87333; --accent2:#7a9e7e; --accent-glow:rgba(184,115,51,0.25);
  --danger:#8b2020; --border:rgba(184,115,51,0.22); --border-hi:rgba(184,115,51,0.55);
  --font-serif:'Noto Serif JP','Yu Mincho','YuMincho','æ¸¸æ˜æœ',serif;
  --font-display:'Cormorant Garamond','Yu Mincho',serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:#1a0a03;
  background-image:
    radial-gradient(ellipse at 50% 120%, rgba(255,95,5,0.45) 0%, rgba(200,65,5,0.25) 20%, rgba(120,40,5,0.1) 40%, transparent 60%),
    radial-gradient(ellipse at 10% 110%, rgba(200,65,5,0.2) 0%, transparent 35%),
    radial-gradient(ellipse at 90% 110%, rgba(200,65,5,0.2) 0%, transparent 35%),
    radial-gradient(ellipse at 50% 50%, #2e1206 0%, #1a0a03 70%);
  color:var(--ink);font-family:var(--font-serif);min-height:100vh;font-size:14px;overflow-x:hidden;
  padding-bottom:calc(60px + env(safe-area-inset-bottom));}
body.offline{
  background:#000;
  background-image:none;
  /* ãƒ†ã‚­ã‚¹ãƒˆç³»ã‚’å¯’è‰²ï¼ˆæ°´è‰²ãƒ»å½©åº¦30%æ¸›ï¼‰ã«ä¸Šæ›¸ã */
  --ink:#c2cdd8;
  --ink-dim:#8898a8;
  --parchment:#a8b8c8;
  --parchment-dim:#7a8898;
  --parchment-dk:#435870;
  --accent:#6a84a0;
  --accent2:#527068;
  --accent-glow:rgba(106,132,160,0.2);
  --border:rgba(106,132,160,0.22);
  --border-hi:rgba(106,132,160,0.5);
}
/* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®æ­»äº¡å‡¦ç†ãƒ»ç‰¹æ®Šè¡¨ç¤ºã¯è¦–èªæ€§ã®é«˜ã„ç´«ã« */
body.offline .char-name-lost{color:#b088e8 !important;}
body.offline .char-detail-name-lost{color:#b088e8 !important;}
body.offline .lost-badge{
  background:rgba(80,40,140,0.35);
  border-color:rgba(176,136,232,0.45);
  color:#b088e8;
}
/* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã‚‚ç´«ã« */
body.offline .btn-d{border-color:rgba(128,80,200,0.6);color:#b088e8;}
body.offline .btn-d:hover{background:rgba(100,60,180,0.4);color:#c8a8f8;}

/* â”€â”€ èƒŒæ™¯ç”»åƒãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå°†æ¥ç”¨ï¼‰ â”€â”€ */
#bg-image{
  position:fixed;inset:0;pointer-events:none;z-index:0;
  background-size:cover;background-position:center;background-repeat:no-repeat;
  opacity:1;transition:filter 1.2s;
}
body.offline #bg-image{filter:brightness(0.5);}

/* â”€â”€ Canvas â”€â”€ */
#particle-canvas{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:0;transition:opacity 1s;}
#particle-canvas.visible{opacity:1;}
#offline-overlay{
  position:fixed;inset:0;pointer-events:none;z-index:1;
  background:
    radial-gradient(ellipse at 50% 30%, rgba(30,70,160,0.22) 0%, transparent 70%),
    radial-gradient(ellipse at 0% 60%,  rgba(15,45,110,0.18) 0%, transparent 55%),
    radial-gradient(ellipse at 100% 60%,rgba(15,45,110,0.18) 0%, transparent 55%),
    rgba(5,15,40,0.45);
  opacity:0;transition:opacity 1.2s;
}
#offline-overlay.visible{opacity:1;}

/* â•â• ã‚¿ã‚¤ãƒˆãƒ« â•â• */
#title-screen{
  position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column;
  transition:opacity 0.8s;
  background:#000;
}
#title-screen.fade-out{opacity:0;pointer-events:none;}
.title-nostoi{
  font-family:var(--font-display);font-size:clamp(3.5rem,12vw,7rem);font-weight:300;letter-spacing:0.15em;
  color:var(--parchment);line-height:1;text-align:center;
  text-shadow:0 0 40px rgba(184,115,51,0.5),0 0 12px rgba(0,0,0,0.9),0 3px 16px rgba(0,0,0,0.8);
}
.title-grimoire{
  font-family:var(--font-display);font-size:clamp(1.15rem,4.2vw,2.2rem);font-weight:400;letter-spacing:0.55em;
  color:var(--parchment);text-align:center;margin-top:0.55rem;text-transform:uppercase;
  text-shadow:0 0 28px rgba(184,115,51,0.75),0 0 8px rgba(184,115,51,0.4),0 2px 8px rgba(0,0,0,0.7);
}
.title-sub-jp{
  font-family:var(--font-serif);font-size:clamp(0.6rem,1.8vw,0.85rem);letter-spacing:0.4em;
  color:var(--parchment-dk);text-align:center;margin-top:0.8rem;
  -webkit-text-stroke:0.6px rgba(255,255,255,0.85);
  text-shadow:0 0 6px rgba(255,255,255,0.15),0 1px 4px rgba(0,0,0,0.9);
}
#title-start{margin-top:clamp(3rem,8vh,5rem);cursor:pointer;user-select:none;}
.blink-text{font-family:var(--font-display);font-size:clamp(0.75rem,2vw,0.95rem);letter-spacing:0.5em;color:var(--parchment-dim);text-transform:uppercase;animation:blink 3s ease-in-out infinite;display:inline-block;padding:0.5rem 1.5rem;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.2;}}
#title-start:hover .blink-text{color:var(--parchment);animation-play-state:paused;opacity:1;}
#title-mode{display:none;flex-direction:column;align-items:center;gap:1rem;margin-top:clamp(3rem,8vh,5rem);animation:fadeInUp 0.5s ease forwards;}
@keyframes fadeInUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.mode-btn{background:rgba(14,12,9,0.72);border:1px solid var(--border-hi);color:var(--parchment);font-family:var(--font-display);font-size:clamp(0.8rem,2.2vw,1rem);letter-spacing:0.5em;text-transform:uppercase;padding:0.75rem 2.5rem;cursor:pointer;transition:all 0.25s;width:240px;text-align:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);}
.mode-btn:hover{border-color:var(--accent);color:var(--parchment);background:rgba(184,115,51,0.18);box-shadow:0 0 16px rgba(184,115,51,0.2);}
#title-loading{display:none;margin-top:1.5rem;font-size:0.7rem;letter-spacing:0.3em;color:var(--parchment-dk);text-transform:uppercase;animation:blink 1.2s ease-in-out infinite;}

/* â•â• ã‚¢ãƒ—ãƒª â•â• */
#app{display:none;opacity:0;transition:opacity 0.6s;position:relative;z-index:1;}
#app.visible{opacity:1;}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
.app-header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 1rem;height:52px;display:flex;align-items:center;gap:0.8rem;position:sticky;top:0;z-index:50;}
.app-title{font-family:var(--font-display);font-size:1rem;font-weight:300;letter-spacing:0.3em;color:var(--parchment);text-transform:uppercase;}
.app-title span{font-size:0.65rem;color:var(--parchment-dk);letter-spacing:0.15em;margin-left:0.5rem;}
.header-actions{margin-left:auto;display:flex;gap:0.5rem;align-items:center;}
.header-icon-btn{background:none;border:1px solid var(--border);color:var(--ink-dim);font-size:1rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:1px;transition:all 0.15s;}
.header-icon-btn:hover{border-color:var(--border-hi);color:var(--ink);}

/* â”€â”€ ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãƒãƒ¼ â”€â”€ */
/* â”€â”€ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†…ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãƒãƒŠãƒ¼ â”€â”€ */
.ann-status{font-size:0.72rem;color:var(--parchment-dk);letter-spacing:0.08em;padding:0.4rem 0;margin-bottom:0.8rem;}
.ann-banner{position:relative;overflow:hidden;border-radius:2px;margin-bottom:1.2rem;cursor:pointer;animation:annBannerIn 0.5s cubic-bezier(0.22,1,0.36,1) both;}
@keyframes annBannerIn{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}
.ann-banner-bg{position:absolute;inset:0;background:linear-gradient(135deg,rgba(184,115,51,0.18) 0%,rgba(74,63,50,0.12) 60%,rgba(139,32,32,0.08) 100%);pointer-events:none;}
.ann-banner.urgent .ann-banner-bg{background:linear-gradient(135deg,rgba(139,32,32,0.22) 0%,rgba(80,20,20,0.12) 60%,rgba(184,115,51,0.06) 100%);}
.ann-banner-border{position:absolute;inset:0;border:1px solid var(--border-hi);border-radius:2px;pointer-events:none;}
.ann-banner.urgent .ann-banner-border{border-color:rgba(139,32,32,0.55);}
.ann-banner-inner{position:relative;padding:1rem 1.2rem;}
.ann-banner-eyebrow{font-size:0.58rem;letter-spacing:0.35em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem;}
.ann-banner.urgent .ann-banner-eyebrow{color:#d47070;}
.ann-badge-new{display:inline-block;font-size:0.55rem;letter-spacing:0.2em;padding:0.1rem 0.4rem;background:var(--accent);color:var(--bg);border-radius:1px;font-weight:600;vertical-align:middle;animation:annPulse 1.8s ease-in-out infinite;}
.ann-banner.urgent .ann-badge-new{background:#8b2020;}
@keyframes annPulse{0%,100%{opacity:1;}50%{opacity:0.6;}}
.ann-banner-title{font-family:var(--font-display);font-size:clamp(1rem,3.5vw,1.3rem);font-weight:300;letter-spacing:0.12em;color:var(--parchment);line-height:1.3;margin-bottom:0.4rem;}
.ann-banner-meta{font-size:0.68rem;color:var(--parchment-dk);}
.ann-banner-more{position:absolute;right:1rem;bottom:1rem;font-size:0.65rem;color:var(--accent);letter-spacing:0.1em;}
.ann-banner.urgent .ann-banner-more{color:#d47070;}
.ann-banner-unread{font-size:0.62rem;color:var(--parchment-dk);margin-left:auto;}

/* â”€â”€ ãƒœãƒˆãƒ ãƒŠãƒ“ â”€â”€ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);display:flex;z-index:50;height:calc(52px + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);}
.bnav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.15rem;cursor:pointer;border:none;background:transparent;color:var(--ink-dim);transition:all 0.15s;font-family:var(--font-serif);border-top:2px solid transparent;}
.bnav-item:hover{color:var(--ink);background:rgba(184,115,51,0.04);}
.bnav-item.active{color:var(--accent);border-top-color:var(--accent);}
.bnav-item.disabled{color:var(--parchment-dk) !important;opacity:0.45;cursor:not-allowed;pointer-events:none;}
.bnav-icon{font-size:1.1rem;}
.bnav-label{font-size:0.58rem;letter-spacing:0.08em;}
.bnav-icon-archive{filter:saturate(0.3) brightness(0.7);}
#bnav-archive.active .bnav-icon-archive{filter:saturate(0.55) brightness(0.85);}
.bnav-icon-analyze{filter:saturate(0) brightness(0.65) sepia(0.25);}
#bnav-analyze.active .bnav-icon-analyze{filter:saturate(0.4) brightness(0.95) sepia(0.5);}

/* â”€â”€ ãƒšãƒ¼ã‚¸ â”€â”€ */
.page{display:none;padding:1.2rem 1rem;max-width:760px;margin:0 auto;}
.page.active{display:block;}

/* â”€â”€ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ™ãƒ« â”€â”€ */
.sec-label{font-size:0.62rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;display:flex;align-items:center;gap:0.6rem;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ â”€â”€ */
label.fl{display:block;font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);margin-bottom:0.35rem;margin-top:1rem;}
input[type="text"],input[type="number"],input[type="password"],select,textarea{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:2px;color:var(--ink);font-family:var(--font-serif);font-size:0.85rem;padding:0.6rem 0.8rem;outline:none;transition:border-color 0.2s;}
input:focus,select:focus,textarea:focus{border-color:var(--border-hi);box-shadow:0 0 8px var(--accent-glow);}
input::placeholder,textarea::placeholder{color:var(--parchment-dk);}
textarea{resize:vertical;line-height:1.8;}
select option{background:var(--bg2);}

/* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€ */
.btn{font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.1em;padding:0.6rem 1.2rem;cursor:pointer;border-radius:1px;transition:all 0.2s;border:1px solid;}
.btn-p{background:transparent;border-color:var(--accent);color:var(--accent);}
.btn-p:hover{background:var(--accent);color:var(--bg);}
.btn-g{background:transparent;border-color:var(--border);color:var(--ink-dim);}
.btn-g:hover{border-color:var(--border-hi);color:var(--ink);}
.btn-d{background:transparent;border-color:var(--danger);color:#d47070;}
.btn-d:hover{background:var(--danger);color:#fff;}
.btn-revive{background:transparent;border-color:#3a7a4a;color:#6ab87a;}
.btn-revive:hover{background:#3a7a4a;color:#fff;}
/* å‰Šé™¤æœ€çµ‚ç¢ºèªãƒœã‚¿ãƒ³ï¼šç„¡åŠ¹â†’3ç§’å¾Œãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ç‚¹ç¯ */
#btn-delete-final{opacity:0.3;pointer-events:none;transition:opacity 0.8s ease;}
#btn-delete-final.armed{opacity:1;pointer-events:auto;}
.btn:disabled{opacity:0.4;cursor:not-allowed;}
.btn-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem;align-items:center;}
.btn-sm{font-size:0.7rem;padding:0.3rem 0.7rem;}

/* â”€â”€ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.char-card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:1rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s;}
.char-card:hover{border-color:var(--border-hi);background:var(--bg3);}
.char-card-header{display:flex;align-items:center;gap:0.7rem;}
.char-tag{font-size:0.68rem;color:var(--accent);letter-spacing:0.05em;font-family:var(--font-display);}
.char-name{font-size:0.92rem;color:var(--ink);}
.char-meta{font-size:0.68rem;color:var(--ink-dim);margin-top:0.3rem;letter-spacing:0.05em;}
.char-role-count{font-size:0.65rem;color:var(--parchment-dk);margin-left:auto;}
.char-name-lost{color:#d47070 !important;}
.char-detail-name-lost{color:#d47070 !important;}
.lost-badge{display:inline-block;font-size:0.58rem;letter-spacing:0.18em;padding:0.1rem 0.45rem;background:rgba(139,32,32,0.35);border:1px solid rgba(212,112,112,0.45);color:#d47070;border-radius:1px;vertical-align:middle;margin-left:0.4rem;}

/* â”€â”€ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ“ãƒ¥ãƒ¼ â”€â”€ */
#char-detail-view{display:none;}
.char-detail-header{display:flex;align-items:center;gap:0.7rem;padding:1rem;background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:1rem;}
.char-detail-name{font-family:var(--font-display);font-size:1.1rem;font-weight:300;letter-spacing:0.2em;color:var(--parchment);}
.char-detail-sub{font-size:0.7rem;color:var(--ink-dim);margin-top:0.2rem;}

/* â”€â”€ ãƒ­ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.role-card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:0.9rem 1rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s;}
.role-card:hover{border-color:var(--border-hi);background:var(--bg3);}
.role-card.selected{border-color:var(--accent);background:rgba(184,115,51,0.05);}
.role-card-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.4rem;}
.role-type-badge{font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;padding:0.15rem 0.45rem;border:1px solid;border-radius:1px;}
.badge-opp{border-color:rgba(122,158,126,0.5);color:var(--accent2);}
.badge-self{border-color:rgba(184,115,51,0.5);color:var(--accent);}
.role-session{font-size:0.68rem;color:var(--ink-dim);}
.role-date{font-size:0.65rem;color:var(--parchment-dk);margin-left:auto;}
.role-preview{font-size:0.8rem;color:var(--ink-dim);line-height:1.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.role-tags{display:flex;gap:0.3rem;flex-wrap:wrap;margin-top:0.5rem;}
.tag-chip{font-size:0.62rem;padding:0.1rem 0.4rem;background:rgba(184,115,51,0.1);border:1px solid var(--border);color:var(--parchment-dim);border-radius:1px;}
.detail-view{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:1.2rem;margin-top:0.8rem;animation:fadeIn 0.25s ease;}
.detail-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem;padding-bottom:0.8rem;border-bottom:1px solid var(--border);}
.detail-body{font-size:0.86rem;line-height:2;white-space:pre-wrap;word-break:break-word;color:var(--ink);}
.detail-analysis{margin-top:1rem;padding:0.9rem 1rem;background:var(--bg3);border:1px solid var(--border);border-radius:2px;}
.detail-analysis-label{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;}
.detail-analysis-text{font-size:0.8rem;line-height:1.9;color:var(--ink-dim);white-space:pre-wrap;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

/* â”€â”€ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ  â”€â”€ */
.sheet-section{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:1rem;margin-bottom:0.8rem;}
.sheet-section-title{font-size:0.65rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:0.8rem;padding-bottom:0.5rem;border-bottom:1px solid var(--border);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;}
@media(max-width:500px){.form-row{grid-template-columns:1fr;}}
.field-warn{font-size:0.65rem;color:#d47070;letter-spacing:0.05em;margin-top:0.2rem;min-height:1em;}

/* å‹•çš„ã‚¢ã‚¤ãƒ†ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.dynamic-item{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.8rem;margin-bottom:0.5rem;position:relative;}
.dynamic-item-del{position:absolute;top:0.5rem;right:0.5rem;background:none;border:none;color:var(--parchment-dk);cursor:pointer;font-size:0.8rem;padding:0.2rem 0.4rem;}
.dynamic-item-del:hover{color:#d47070;}

/* ã‚·ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
.sheet-preview{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:1rem 1.2rem;font-size:0.78rem;line-height:2;color:var(--ink-dim);white-space:pre-wrap;word-break:break-word;max-height:400px;overflow-y:auto;font-family:'Courier New',monospace;}

/* â”€â”€ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆä¸–ç•Œè¦³è³‡æ–™ï¼‰ â”€â”€ */
.archive-announce-card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;overflow:hidden;margin-bottom:0.5rem;}
.archive-announce-card.urgent{border-color:rgba(139,32,32,0.4);}
.archive-announce-card.important{border-color:rgba(184,115,51,0.5);}
.archive-announce-card-header{display:flex;align-items:center;gap:0.6rem;padding:0.8rem 1rem;cursor:pointer;transition:background 0.15s;}
.archive-announce-card-header:hover{background:var(--bg3);}
.archive-announce-card-dot{width:6px;height:6px;border-radius:50%;background:var(--parchment-dk);flex-shrink:0;}
.archive-announce-card.urgent .archive-announce-card-dot{background:#d47070;}
.archive-announce-card.important .archive-announce-card-dot{background:var(--accent);}
.archive-announce-card-title{font-size:0.88rem;color:var(--ink);flex:1;}
.archive-announce-card-date{font-size:0.65rem;color:var(--parchment-dk);}
.archive-announce-card-arrow{font-size:0.65rem;color:var(--parchment-dk);transition:transform 0.2s;}
.archive-announce-card-arrow.open{transform:rotate(90deg);}
.archive-announce-card-body{display:none;padding:0.8rem 1rem 1rem;border-top:1px solid var(--border);font-size:0.82rem;color:var(--ink-dim);line-height:2;white-space:pre-wrap;}
.archive-announce-card-body.open{display:block;}
.archive-announce-empty{font-size:0.75rem;color:var(--parchment-dk);letter-spacing:0.1em;padding:0.5rem 0;}background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:0.9rem 1rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s;}
.db-entry-card:hover{border-color:var(--border-hi);}
.db-entry-title{font-size:0.88rem;color:var(--ink);}
.db-entry-meta{font-size:0.68rem;color:var(--ink-dim);margin-top:0.25rem;}
.db-entry-body{font-size:0.82rem;line-height:1.9;color:var(--ink-dim);margin-top:0.7rem;white-space:pre-wrap;word-break:break-word;display:none;}
.db-entry-body.open{display:block;}
.search-bar{display:flex;gap:0.5rem;margin-bottom:1rem;}
.search-bar input{flex:1;}

/* â”€â”€ ãƒ­ãƒƒã‚¯ â”€â”€ */
.locked-section{background:rgba(184,115,51,0.08);border:1px dashed var(--border);border-radius:2px;padding:1.5rem;text-align:center;margin-top:1.5rem;}
.locked-icon{font-size:1.5rem;margin-bottom:0.6rem;opacity:0.5;}
.locked-title{font-size:0.85rem;color:var(--parchment-dim);letter-spacing:0.1em;margin-bottom:0.4rem;}
.locked-desc{font-size:0.72rem;color:var(--parchment-dk);line-height:1.8;margin-bottom:1rem;}

/* â”€â”€ ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ â”€â”€ */
#help-page{position:fixed;inset:0;background:var(--bg);z-index:80;display:none;overflow-y:auto;padding-bottom:calc(60px + env(safe-area-inset-bottom));transform:translateX(100%);transition:transform 0.3s;}
#help-page.open{display:block;transform:translateX(0);}
.help-body{padding:1.5rem 1rem;max-width:600px;margin:0 auto;}
.help-section{margin-bottom:2rem;}
.help-section-title{font-size:0.62rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:1rem;display:flex;align-items:center;gap:0.6rem;}
.help-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.help-item{background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:0.5rem;overflow:hidden;}
.help-item-header{padding:0.8rem 1rem;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background 0.15s;}
.help-item-header:hover{background:var(--bg3);}
.help-item-title{font-size:0.85rem;color:var(--ink);letter-spacing:0.05em;}
.help-item-arrow{font-size:0.7rem;color:var(--parchment-dk);transition:transform 0.2s;}
.help-item-arrow.open{transform:rotate(90deg);}
.help-item-body{display:none;padding:0.8rem 1rem 1rem;border-top:1px solid var(--border);font-size:0.8rem;color:var(--ink-dim);line-height:2;}
.help-item-body.open{display:block;}
.help-item-body p{margin-bottom:0.6rem;}
.help-item-body p:last-child{margin-bottom:0;}
.help-tag{display:inline-block;font-size:0.65rem;padding:0.1rem 0.4rem;border:1px solid var(--border);border-radius:1px;color:var(--accent);margin:0 0.15rem;font-family:var(--font-display);letter-spacing:0.1em;}
#options-page{position:fixed;inset:0;background:var(--bg);z-index:80;display:none;overflow-y:auto;padding-bottom:calc(60px + env(safe-area-inset-bottom));transform:translateX(100%);transition:transform 0.3s;}
#options-page.open{display:block;transform:translateX(0);}
.options-header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 1rem;height:52px;display:flex;align-items:center;gap:0.8rem;position:sticky;top:0;z-index:5;}
.options-title{font-family:var(--font-display);font-size:0.9rem;font-weight:300;letter-spacing:0.3em;color:var(--parchment);text-transform:uppercase;}
.options-body{padding:1.5rem 1rem;max-width:600px;margin:0 auto;}
.options-section{margin-bottom:2rem;}
.options-section-title{font-size:0.62rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:1rem;display:flex;align-items:center;gap:0.6rem;}
.options-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:0.8rem 1rem;background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:0.5rem;}
.toggle-label{font-size:0.82rem;color:var(--ink-dim);}
.toggle-desc{font-size:0.68rem;color:var(--parchment-dk);margin-top:0.2rem;}
.toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--parchment-dk);border-radius:11px;cursor:pointer;transition:background 0.2s;}
.toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform 0.2s;}
.toggle-switch input:checked+.toggle-slider{background:var(--accent);}
.toggle-switch input:checked+.toggle-slider::before{transform:translateX(18px);}
/* ã‚«ã‚¹ã‚¿ãƒ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.cb-wrap{display:flex;align-items:center;gap:0.5rem;cursor:pointer;user-select:none;white-space:nowrap;}
.cb-wrap input[type="checkbox"]{display:none;}
.cb-box{width:16px;height:16px;flex-shrink:0;background:var(--bg3);border:1px solid var(--border);border-radius:2px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.cb-wrap input[type="checkbox"]:checked+.cb-box{background:var(--accent);border-color:var(--accent);}
.cb-box::after{content:'';width:5px;height:9px;border:2px solid #0e0c09;border-top:none;border-left:none;transform:rotate(45deg) translateY(-1px);opacity:0;transition:opacity 0.15s;}
.cb-wrap input[type="checkbox"]:checked+.cb-box::after{opacity:1;}
.cb-label{font-size:0.72rem;color:var(--ink-dim);}
/* å¹´é½¢ãƒ­ãƒƒã‚¯æ™‚ã®æ–œç·š */
input[type="number"].locked{
  pointer-events:none;color:var(--parchment-dk);
  background:repeating-linear-gradient(135deg,var(--bg3) 0px,var(--bg3) 6px,rgba(74,63,50,0.35) 6px,rgba(74,63,50,0.35) 8px);
  border-color:rgba(184,115,51,0.12);
}
.volume-row{padding:0.8rem 1rem;background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:0.5rem;}
.volume-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem;}
.volume-label{font-size:0.82rem;color:var(--ink-dim);}
.volume-value{font-size:0.72rem;color:var(--accent);}
input[type="range"]{width:100%;height:3px;-webkit-appearance:none;background:linear-gradient(to right,var(--accent) 0%,var(--accent) var(--val,70%),var(--parchment-dk) var(--val,70%));border-radius:2px;outline:none;cursor:pointer;}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--parchment);border-radius:50%;border:1px solid var(--accent);}

/* â”€â”€ ã‚«ãƒãƒ³ãƒãƒƒãƒ— â”€â”€ */
#bag-btn{position:fixed;right:1rem;bottom:calc(72px + env(safe-area-inset-bottom));z-index:60;width:46px;height:46px;background:var(--bg2);border:1px solid var(--border-hi);border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem;box-shadow:0 2px 12px rgba(0,0,0,0.5);transition:all 0.2s;}
#bag-btn.visible{display:flex;}
#bag-btn:hover{border-color:var(--accent);box-shadow:0 2px 16px var(--accent-glow);}
#bag-btn.open{background:var(--accent);border-color:var(--accent);}
#bag-menu{position:fixed;right:1rem;bottom:calc(126px + env(safe-area-inset-bottom));z-index:60;display:flex;flex-direction:column;gap:0.4rem;align-items:flex-end;pointer-events:none;opacity:0;transform:translateY(8px);transition:all 0.2s;}
#bag-menu.open{pointer-events:all;opacity:1;transform:translateY(0);}
.bag-menu-item{background:var(--bg2);border:1px solid var(--border-hi);border-radius:2px;padding:0.4rem 0.8rem;font-size:0.75rem;letter-spacing:0.1em;color:var(--parchment);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:0.5rem;transition:all 0.15s;}
.bag-menu-item:hover{border-color:var(--accent);color:var(--accent);}
/* ã‚«ãƒãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */
.bag-modal{background:var(--bg2);border:1px solid var(--border-hi);border-radius:2px;width:100%;max-width:420px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;animation:fadeIn 0.2s ease;}
.bag-modal-header{display:flex;align-items:center;padding:0.8rem 1rem;border-bottom:1px solid var(--border);flex-shrink:0;}
.bag-modal-title{font-family:var(--font-display);font-size:1rem;font-weight:300;letter-spacing:0.2em;color:var(--parchment);flex:1;}
.bag-modal-close{background:none;border:none;color:var(--parchment-dk);font-size:1rem;cursor:pointer;padding:0.2rem 0.4rem;}
.bag-modal-body{overflow-y:auto;padding:1rem;flex:1;}
/* é›»å“ */
.calc-display{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.8rem 1rem;text-align:right;margin-bottom:0.8rem;}
.calc-expr{font-size:0.72rem;color:var(--parchment-dk);min-height:1.2em;letter-spacing:0.05em;}
.calc-val{font-size:1.6rem;color:var(--ink);letter-spacing:0.05em;font-family:'Courier New',monospace;}
.calc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.4rem;}
.calc-btn{background:var(--bg3);border:1px solid var(--border);color:var(--ink-dim);font-family:var(--font-serif);font-size:0.9rem;padding:0.7rem;cursor:pointer;border-radius:2px;transition:all 0.1s;text-align:center;}
.calc-btn:hover{border-color:var(--border-hi);color:var(--ink);}
.calc-btn.op{color:var(--accent);}
.calc-btn.eq{background:rgba(184,115,51,0.15);border-color:var(--accent);color:var(--accent);}
.calc-btn.eq:hover{background:var(--accent);color:var(--bg);}
.calc-btn.cl{color:#d47070;}
/* ãƒ¡ãƒ¢å¸³ */
.memo-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:0.8rem;}
.memo-tab{flex:1;padding:0.5rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.75rem;letter-spacing:0.1em;color:var(--ink-dim);cursor:pointer;transition:all 0.15s;}
.memo-tab.active{border-bottom-color:var(--accent);color:var(--accent);}
/* ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ— */
#mindmap-canvas{width:100%;height:340px;background:var(--bg3);border:1px solid var(--border);border-radius:2px;cursor:default;touch-action:none;}
.mindmap-toolbar{display:flex;gap:0.4rem;margin-bottom:0.5rem;flex-wrap:wrap;}
/* ãƒ€ã‚¤ã‚¹ */
.dice-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-bottom:1rem;}
.dice-btn{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.7rem;text-align:center;cursor:pointer;transition:all 0.15s;}
.dice-btn:hover{border-color:var(--border-hi);}
.dice-label{font-size:0.68rem;color:var(--accent);letter-spacing:0.1em;}
.dice-icon{font-size:1.4rem;margin:0.3rem 0;}
.dice-result-area{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:1rem;text-align:center;min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.dice-result-num{font-family:var(--font-display);font-size:2.5rem;font-weight:300;color:var(--parchment);line-height:1;}
.dice-result-label{font-size:0.7rem;color:var(--ink-dim);margin-top:0.3rem;letter-spacing:0.1em;}
.dice-result-roll-off{animation:diceRoll 0.3s ease;}
.dice-result-roll-spin{animation:diceSpin 1.4s cubic-bezier(0.25,0.46,0.45,0.94);}
.dice-result-roll-shake{animation:diceShake 1.1s ease;}
@keyframes diceRoll{0%{transform:scale(1.3);opacity:0.5;}100%{transform:scale(1);opacity:1;}}
@keyframes diceSpin{
  0%  {transform:scale(0.5) rotate(0deg);   opacity:0.3;}
  30% {transform:scale(1.2) rotate(180deg); opacity:0.9;}
  60% {transform:scale(0.95)rotate(320deg); opacity:1;}
  80% {transform:scale(1.05)rotate(355deg); opacity:1;}
  100%{transform:scale(1)   rotate(360deg); opacity:1;}
}
@keyframes diceShake{
  0%  {transform:translateX(0)    rotate(0deg);}
  10% {transform:translateX(-8px) rotate(-15deg);}
  20% {transform:translateX(8px)  rotate(15deg);}
  30% {transform:translateX(-6px) rotate(-10deg);}
  40% {transform:translateX(6px)  rotate(10deg);}
  55% {transform:translateX(-3px) rotate(-5deg);}
  65% {transform:translateX(3px)  rotate(5deg) scale(1.1);}
  80% {transform:translateX(0)    rotate(0deg) scale(1.05);}
  90% {transform:translateY(-4px) scale(1.02);}
  100%{transform:translateY(0)    scale(1);}
}

/* ãƒ€ã‚¤ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚·ã‚§ã‚¤ã‚¯ */
.dice-icon-anim-shake{animation:diceIconShake 1.1s ease;}
.dice-icon-anim-spin {animation:diceIconSpin  1.4s ease;}
@keyframes diceIconShake{
  0%,100%{transform:rotate(0);}
  15%{transform:rotate(-20deg) scale(1.2);}
  30%{transform:rotate(20deg)  scale(1.2);}
  45%{transform:rotate(-15deg) scale(1.15);}
  60%{transform:rotate(15deg)  scale(1.1);}
  75%{transform:rotate(-8deg)  scale(1.05);}
  88%{transform:rotate(8deg)   scale(1.02);}
}
@keyframes diceIconSpin{
  0%  {transform:rotate(0)    scale(1);}
  40% {transform:rotate(540deg) scale(1.3);}
  70% {transform:rotate(900deg) scale(1.1);}
  100%{transform:rotate(1080deg) scale(1);}
}
/* â”€â”€ å™è¿°ãƒãƒ£ãƒƒãƒˆ â”€â”€ */
.chat-bubble{max-width:88%;padding:0.7rem 0.9rem;border-radius:2px;font-size:0.85rem;line-height:1.9;white-space:pre-wrap;word-break:break-word;animation:fadeIn 0.2s ease;}
.chat-bubble.user{align-self:flex-end;background:rgba(184,115,51,0.15);border:1px solid var(--border-hi);color:var(--ink);}
.chat-bubble.ai{align-self:flex-start;background:var(--bg2);border:1px solid var(--border);color:var(--ink-dim);}
.chat-bubble.ai.loading{color:var(--parchment-dk);font-style:italic;}
.chat-sender{font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:0.3rem;color:var(--parchment-dk);}
#apanel-chat.active-panel{display:flex;}
.page{backface-visibility:hidden;transform-style:preserve-3d;}
.page.flip-out{animation:flipOut 0.22s ease-in forwards;}
.page.flip-in {animation:flipIn  0.22s ease-out forwards;}
@keyframes flipOut{
  0%  {transform:perspective(1200px) rotateY(0deg)   scale(1);   opacity:1;}
  100%{transform:perspective(1200px) rotateY(-90deg) scale(0.95);opacity:0;}
}
@keyframes flipIn{
  0%  {transform:perspective(1200px) rotateY(90deg)  scale(0.95);opacity:0;}
  100%{transform:perspective(1200px) rotateY(0deg)   scale(1);   opacity:1;}
}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;padding:1rem;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border-hi);border-radius:2px;padding:2rem;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;animation:fadeIn 0.25s ease;}
.modal-title{font-family:var(--font-display);font-size:1.2rem;font-weight:300;letter-spacing:0.2em;color:var(--parchment);margin-bottom:1.2rem;}
.modal-step{display:flex;gap:0.8rem;margin-bottom:0.8rem;align-items:flex-start;}
.step-num{width:20px;height:20px;border-radius:50%;background:rgba(184,115,51,0.2);border:1px solid var(--border-hi);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:var(--accent);flex-shrink:0;margin-top:0.1rem;}
.step-text{font-size:0.8rem;color:var(--ink-dim);line-height:1.8;}
.step-link{color:var(--accent);text-decoration:underline;cursor:pointer;}
.caution-box{background:rgba(139,32,32,0.1);border:1px solid rgba(139,32,32,0.3);border-radius:2px;padding:0.8rem 1rem;margin:1rem 0;font-size:0.75rem;color:#c87070;line-height:1.8;}
.announce-modal-list{display:flex;flex-direction:column;gap:0.7rem;}
.announce-modal-item{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.9rem 1rem;}
.announce-modal-header{display:flex;align-items:baseline;gap:0.7rem;margin-bottom:0.4rem;}
.announce-modal-title{font-size:0.88rem;color:var(--ink);}
.announce-modal-date{font-size:0.65rem;color:var(--parchment-dk);margin-left:auto;}
.announce-modal-body{font-size:0.8rem;color:var(--ink-dim);line-height:1.9;white-space:pre-wrap;}
.level-badge{font-size:0.58rem;padding:0.1rem 0.4rem;border-radius:1px;border:1px solid;}
.level-normal{border-color:var(--border);color:var(--ink-dim);}
.level-important{border-color:rgba(184,115,51,0.5);color:var(--accent);}
.level-urgent{border-color:rgba(139,32,32,0.5);color:#d47070;}

/* â”€â”€ ç©ºçŠ¶æ…‹ â”€â”€ */
.empty{text-align:center;padding:3rem 1rem;color:var(--parchment-dk);}
.empty-icon{font-size:2rem;margin-bottom:0.6rem;opacity:0.4;}
.empty-text{font-size:0.8rem;letter-spacing:0.1em;}
.sep{border:none;border-top:1px solid var(--border);margin:1.5rem 0;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--parchment-dk);border-radius:2px;}
@media(min-width:600px){.page{padding:1.5rem;}.app-header{padding:0 1.5rem;}.options-body{padding:1.5rem;}}
@media(min-width:768px){
  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã‚’åºƒã’ã‚‹ */
  .page{max-width:860px;padding:2rem 2.5rem;}
  .help-body,.options-body{max-width:720px;padding:2rem 2.5rem;}
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .app-header{padding:0 2rem;}
  .app-title{font-size:1.1rem;}
  /* ãƒœãƒˆãƒ ãƒŠãƒ“ã‚’ä¸­å¤®å¯„ã›ãƒ»å¹…åˆ¶é™ã—ã¦PCã§ã‚‚ä½¿ã„ã‚„ã™ã */
  .bottom-nav{max-width:540px;left:50%;transform:translateX(-50%);border-radius:4px 4px 0 0;border-left:1px solid var(--border);border-right:1px solid var(--border);}
  /* ãƒ•ã‚©ãƒ³ãƒˆãƒ»ä½™ç™½èª¿æ•´ */
  body{font-size:15px;}
  .modal{max-width:580px;padding:2.5rem;}
  .bag-modal{max-width:500px;}
  /* ãƒ›ãƒãƒ¼æ“ä½œã‚’å°‘ã—å¼·èª¿ */
  .char-card:hover{border-color:var(--border-hi);transform:translateY(-1px);transition:all 0.15s;}
  .role-card:hover{border-color:var(--border-hi);transform:translateY(-1px);}
}
</style>
</head>
<body>
<div id="bg-image"></div>
<canvas id="particle-canvas"></canvas>
<div id="offline-overlay"></div>

<!-- â•â• ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ â•â• -->
<div id="title-screen">
  <div style="text-align:center;user-select:none;">
    <div class="title-nostoi">NÃ³stoi</div>
    <div class="title-grimoire">Grimoire</div>
    <div class="title-sub-jp">ãƒã‚¹ãƒˆã‚¤å™äº‹è©©ç’°</div>
  </div>
  <div id="title-start" onclick="playSETitle();onStartClick()"><span class="blink-text">START</span></div>
  <div id="title-mode">
    <button class="mode-btn" onclick="playSETitle();selectMode('online')">ONLINE</button>
    <button class="mode-btn" onclick="playSETitle();selectMode('offline')">OFFLINE</button>
  </div>
  <div id="title-loading">Loadingâ€¦</div>
</div>

<!-- â•â• ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª â•â• -->
<div id="app">
  <div class="app-header">
    <span class="app-title">Grimoire <span>NÃ³stoi</span></span>
    <div class="header-actions">
      <button class="header-icon-btn" onclick="openHelp()">?</button>
      <button class="header-icon-btn" onclick="openOptions()">âš™</button>

    </div>
  </div>


  <!-- â”€â”€ ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒšãƒ¼ã‚¸ â”€â”€ -->
  <div class="page active" id="page-roleplay">

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ -->
    <div id="char-list-view">
      <div class="search-bar">
        <input type="text" id="char-search" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ¤œç´¢â€¦" oninput="renderCharList()">
      </div>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-p" onclick="showCharCreate()">ï¼‹ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œæˆ</button>
      </div>
      <div id="char-list" style="margin-top:1rem;"></div>
    </div>

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ“ãƒ¥ãƒ¼ -->
    <div id="char-detail-view">
      <!-- ä¸Šæ®µï¼šã‚­ãƒ£ãƒ©å -->
      <div style="margin-bottom:0.5rem;">
        <div class="char-detail-name" id="detail-char-name"></div>
        <div class="char-detail-sub" id="detail-char-sub"></div>
      </div>
      <!-- ä¸‹æ®µï¼šæ“ä½œãƒœã‚¿ãƒ³ -->
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
        <button class="btn btn-g btn-sm" onclick="backToCharList()">â† ä¸€è¦§</button>
        <button class="btn btn-g btn-sm" onclick="showCharSheet()">ã‚·ãƒ¼ãƒˆ</button>
        <button class="btn btn-g btn-sm" onclick="showCharEdit()">ç·¨é›†</button>
        <button class="btn btn-d btn-sm" id="btn-lost-char" onclick="openLostModal()">æ­»äº¡</button>
        <button class="btn btn-d btn-sm" onclick="openDeleteCharModal(currentCharId)">å‰Šé™¤</button>
      </div>
      <div class="search-bar">
        <input type="text" id="role-search" placeholder="ãƒ­ãƒ¼ãƒ«ã‚’æ¤œç´¢â€¦" oninput="renderRoles()">
        <select id="role-filter-type" onchange="renderRoles()" style="width:auto;">
          <option value="">ã™ã¹ã¦</option><option value="opp">ç›¸æ‰‹</option><option value="self">è‡ªåˆ†</option>
        </select>
      </div>
      <div class="sec-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
      <div id="session-list" style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-bottom:0.8rem;"></div>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-p" onclick="openModal('modal-new-role')">ï¼‹ ãƒ­ãƒ¼ãƒ«ã‚’è¨˜éŒ²</button>
      </div>
      <div id="role-list" style="margin-top:1rem;"></div>
    </div>

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="char-form-view" style="display:none;">
      <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem;">
        <button class="btn btn-g btn-sm" onclick="cancelCharForm()">â† æˆ»ã‚‹</button>
        <span style="font-size:0.85rem;color:var(--parchment);letter-spacing:0.1em;" id="char-form-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆ</span>
      </div>

      <!-- åŸºæœ¬æƒ…å ± -->
      <div class="sheet-section">
        <div class="sheet-section-title">åŸºæœ¬æƒ…å ±</div>
        <label class="fl" style="margin-top:0;">è­˜åˆ¥ã‚¿ã‚° â€»</label>
        <input type="text" id="sf-tag" placeholder="#ã‚¿ã‚°">
        <label class="fl">åå‰ â€»</label>
        <input type="text" id="sf-name" placeholder="">
        <div class="form-row" style="margin-top:1rem;">
          <div>
            <label class="fl" style="margin-top:0;">æ€§åˆ¥</label>
            <select id="sf-sex">
              <option value="">æ€§åˆ¥ï¼ˆæœªé¸æŠï¼‰</option>
              <option value="á´á´€ÊŸá´‡">ç”·æ€§ (MALE)</option>
              <option value="Ò“á´‡á´á´€ÊŸá´‡">å¥³æ€§ (FEMALE)</option>
              <option value="á´œÉ´á´‹É´á´á´¡É´">ä¸æ˜ (UNKNOWN)</option>
            </select>
          </div>
          <div>
            <label class="fl" style="margin-top:0;">å¹´é½¢</label>
            <div style="display:flex;gap:0.4rem;align-items:center;">
              <input type="number" id="sf-age" min="0" max="9999" placeholder="" oninput="checkAgeWarn()" style="flex:1;min-width:0;">
              <label class="cb-wrap">
                <input type="checkbox" id="sf-age-unknown" onchange="onAgeUnknown()">
                <span class="cb-box"></span>
                <span class="cb-label">ä¸æ˜</span>
              </label>
            </div>
            <div class="field-warn" id="warn-age"></div>
          </div>
        </div>
        <div class="form-row" style="margin-top:0.8rem;">
          <div>
            <label class="fl" style="margin-top:0;">ç¨®æ—</label>
            <select id="sf-race">
              <option value="">ç¨®æ—ï¼ˆæœªé¸æŠï¼‰</option>
              <option value="á´œÉ´á´‹É´á´á´¡É´">ä¸æ˜ (UNKNOWN)</option>
              <option value="Ê€Éªsá´‡">æºäºº (RISE)</option>
              <option value="á´¡Éªsá´‡">é‹­äºº (WISE)</option>
              <option value="Êœá´€Ê€á´…">å°äºº (HARD)</option>
              <option value="Ê™á´‡á´€sá´›">ç£äºº (BEAST)</option>
              <option value="ÊŸÉªá´¢á´€Ê€á´…">ç«œäººãƒ»èœ¥èœ´ (LIZARD)</option>
              <option value="á´…Ê€á´€á´‹á´‡">ç«œäººãƒ»é¾ (DRAKE)</option>
              <option value="á´É¢Ê€á´‡">é¬¼äºº (OGRE)</option>
            </select>
          </div>
          <div>
            <label class="fl" style="margin-top:0;">èº«é•· / ä½“é‡</label>
            <div style="display:flex;gap:0.4rem;align-items:center;">
              <input type="number" id="sf-height" min="0" max="9999" placeholder="cm" oninput="checkBodyWarn()" style="flex:1;min-width:0;">
              <span style="font-size:0.72rem;color:var(--parchment-dk);">/</span>
              <input type="number" id="sf-weight" min="0" max="9999" placeholder="kg" oninput="checkBodyWarn()" style="flex:1;min-width:0;">
            </div>
            <div class="field-warn" id="warn-body"></div>
          </div>
        </div>
        <label class="fl">ã‚¸ãƒ§ãƒ– â€»</label>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <select id="sf-job-primary" style="flex:1;" onchange="updateJobDisplay()">
            <option value="">ä¸€æ¬¡è·ï¼ˆæœªé¸æŠï¼‰</option>
            <optgroup label="ç‰©ç†è·">
              <option value="á´ á´€É´É¢á´œá´€Ê€á´…">æˆ¦å£« / ãƒ´ã‚¡ãƒ³ã‚¬ãƒ¼ãƒ‰</option>
              <option value="Ê™á´á´¡á´á´€É´">å°„æ‰‹ / ãƒœã‚¦ãƒãƒ³</option>
              <option value="Ê€Éªá´…á´‡Ê€">é¨æ‰‹ / ãƒ©ã‚¤ãƒ€ãƒ¼ (R)</option>
            </optgroup>
            <optgroup label="é­”æ³•è·">
              <option value="á´á´€É¢á´‡">é­”è¡“å¸« / ãƒ¡ã‚¤ã‚¸</option>
              <option value="á´¡ÉªsÊœá´‡Ê€">ç¥ˆç¥·å¸« / ã‚¦ã‚£ãƒƒã‚·ãƒ£ãƒ¼</option>
              <option value="sÊœá´€á´á´€É´">éœŠè¡“å¸« / ã‚·ãƒ£ãƒ¼ãƒãƒ³</option>
              <option value="sá´Ê€á´„á´‡Ê€á´‡Ê€">å‘ªè¡“å¸« / ã‚½ãƒ¼ã‚µãƒ©ãƒ¼</option>
              <option value="á´¡Éªá´¢á´€Ê€á´…">é­”é“å£« / ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰</option>
            </optgroup>
          </select>
          <select id="sf-job-secondary" style="flex:1;" onchange="updateJobDisplay()">
            <option value="">äºŒæ¬¡è·ï¼ˆæœªé¸æŠï¼‰</option>
            <option value="Ê€Éªá´…á´‡Ê€">é¨æ‰‹ / ãƒ©ã‚¤ãƒ€ãƒ¼ (R)</option>
            <optgroup label="é­”æ³•äºŒæ¬¡è·">
              <option value="á´‡É´á´„Êœá´€É´á´›á´‡Ê€">é­”è¡“å¸«Â² / ã‚¨ãƒ³ãƒãƒ£ãƒ³ã‚¿ãƒ¼ (E)</option>
              <option value="á´Ê€á´€á´„ÊŸá´‡">ç¥ˆç¥·å¸«Â² / ã‚ªãƒ©ã‚¯ãƒ« (O)</option>
              <option value="á´„á´É´á´Šá´œÊ€á´‡Ê€">éœŠè¡“å¸«Â² / ã‚³ãƒ³ã‚¸ãƒ¥ãƒ©ãƒ¼ (C)</option>
              <option value="á´¡á´€Ê€ÊŸá´á´„á´‹">å‘ªè¡“å¸«Â² / ã‚¦ã‚©ãƒ¼ãƒ­ãƒƒã‚¯ (W)</option>
              <option value="sá´€É¢á´‡">é­”é“å£«Â² / ã‚»ãƒ¼ã‚¸ (S)</option>
            </optgroup>
          </select>
        </div>
        <div id="sf-job-preview" style="font-size:0.72rem;color:var(--accent);letter-spacing:0.15em;min-height:1.2em;margin-top:0.25rem;"></div>
        <label class="fl">æ‰€å±ã‚®ãƒ«ãƒ‰</label>
        <input type="text" id="sf-guild" placeholder="">
        <label class="fl">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ¦‚è¦ â€»</label>
        <textarea id="sf-overview" rows="5" placeholder="å®¹å§¿ãƒ»æ€§æ ¼ãƒ»çµŒæ­´ãªã©ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
      </div>

      <!-- æ­¦è£… -->
      <div class="sheet-section">
        <div class="sheet-section-title">æ­¦è£… (WEAPON)</div>
        <div id="sf-weapons"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addDynamicItem('weapons','æ­¦å™¨å','è©³ç´°ï¼ˆä»»æ„ï¼‰')">ï¼‹ æ­¦å™¨ã‚’è¿½åŠ </button>
      </div>

      <!-- é˜²å…· -->
      <div class="sheet-section">
        <div class="sheet-section-title">é˜²å…· (ARMOR)</div>
        <div id="sf-armors"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addDynamicItem('armors','é˜²å…·å','è©³ç´°ï¼ˆä»»æ„ï¼‰')">ï¼‹ é˜²å…·ã‚’è¿½åŠ </button>
      </div>

      <!-- ã‚¢ã‚¤ãƒ†ãƒ  -->
      <div class="sheet-section">
        <div class="sheet-section-title">ã‚¢ã‚¤ãƒ†ãƒ  (ITEM)</div>
        <div id="sf-items"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addDynamicItem('items','ã‚¢ã‚¤ãƒ†ãƒ å','è©³ç´°ï¼ˆä»»æ„ï¼‰')">ï¼‹ ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ </button>
      </div>

      <!-- é­”æ³• -->
      <div class="sheet-section">
        <div class="sheet-section-title">é­”æ³• (MAGIC)</div>
        <div id="sf-magics"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addMagicItem()">ï¼‹ é­”æ³•ã‚’è¿½åŠ </button>
      </div>

      <div class="btn-row">
        <button class="btn btn-p" onclick="saveChar()">ä¿å­˜</button>
        <button class="btn btn-g" onclick="cancelCharForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <!-- ã‚·ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div id="char-sheet-view" style="display:none;">
      <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem;">
        <button class="btn btn-g btn-sm" onclick="backToCharDetail()">â† æˆ»ã‚‹</button>
        <span style="font-size:0.85rem;color:var(--parchment);letter-spacing:0.1em;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆ</span>
      </div>
      <div class="sheet-preview" id="sheet-preview-text"></div>
      <div class="btn-row">
        <button class="btn btn-p" onclick="copySheet()">ã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

  </div>

  <!-- â”€â”€ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒšãƒ¼ã‚¸ â”€â”€ -->
  <div class="page" id="page-archive">
    <div id="archive-announce-area" style="margin-bottom:1rem;"></div>
    <div class="search-bar">
      <input type="text" id="db-search" placeholder="è¨˜äº‹ã‚’æ¤œç´¢â€¦" oninput="renderDB()">
      <select id="db-cat-filter" onchange="renderDB()" style="width:auto;"><option value="">ã™ã¹ã¦</option></select>
    </div>
    <div id="db-not-loaded" style="display:none;">
      <div class="empty">
        <div class="empty-icon">ğŸ“š</div>
        <div class="empty-text">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“<br>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
      </div>
    </div>
    <div id="db-content"></div>
  </div>

  <!-- â”€â”€ åˆ†æãƒšãƒ¼ã‚¸ â”€â”€ -->
  <div class="page" id="page-analyze">
    <div class="sec-label">åˆ†ææ©Ÿèƒ½</div>
    <div id="analyze-locked" class="locked-section">
      <div class="locked-icon">ğŸ”’</div>
      <div class="locked-title">åˆ†ææ©Ÿèƒ½ã¯è§£æ”¾ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
      <div class="locked-desc">åˆ†ææ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Anthropic APIã‚­ãƒ¼ã®ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚<br>APIã‚­ãƒ¼ã¯ç„¡æ–™ã§å–å¾—ã§ãã¾ã™ãŒã€ä½¿ç”¨é‡ã«å¿œã˜ãŸè²»ç”¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚</div>
      <button class="btn btn-p" onclick="openModal('modal-api-setup')">APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦è§£æ”¾ã™ã‚‹</button>
    </div>
    <div id="analyze-unlocked" style="display:none;">
      <div style="display:flex;border-bottom:1px solid var(--border);margin-bottom:1.5rem;">
        <button id="atab-opp"    onclick="switchAnalyzeTab('opp')"    style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid var(--accent);font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--accent);cursor:pointer;">ç›¸æ‰‹</button>
        <button id="atab-self"   onclick="switchAnalyzeTab('self')"   style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--ink-dim);cursor:pointer;">è‡ªåˆ†</button>
        <button id="atab-assist" onclick="switchAnalyzeTab('assist')" style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--ink-dim);cursor:pointer;">ä½œæˆè£œåŠ©</button>
        <button id="atab-chat"   onclick="switchAnalyzeTab('chat')"   style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--ink-dim);cursor:pointer;">å™è¿°</button>
      </div>
      <div id="apanel-opp">
        <div class="sec-label">ãƒ­ãƒ¼ãƒ«æœ¬æ–‡</div>
        <textarea id="opp-text" rows="7" placeholder="ç›¸æ‰‹ã®ãƒ­ãƒ¼ãƒ«ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">ä¸–ç•Œè¦³è£œè¶³ï¼ˆä»»æ„ï¼‰</div>
        <textarea id="opp-supp" rows="3" placeholder="ä¸–ç•Œè¦³è³‡æ–™ã®å‚ç…§å†…å®¹ã‚„è£œè¶³æƒ…å ±"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">åˆ†æã‚«ãƒ†ã‚´ãƒª</div>
        <div id="opp-cats" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
        <div class="btn-row"><button class="btn btn-p" id="opp-btn" onclick="doAnalyze('opp')">è§£æ åŸ·è¡Œ</button></div>
        <div id="opp-result"></div>
      </div>
      <div id="apanel-self" style="display:none;">
        <div class="sec-label">ãƒ­ãƒ¼ãƒ«æœ¬æ–‡</div>
        <textarea id="self-text" rows="7" placeholder="è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">ä¸–ç•Œè¦³è£œè¶³ï¼ˆä»»æ„ï¼‰</div>
        <textarea id="self-supp" rows="3" placeholder="ä¸–ç•Œè¦³è³‡æ–™ã®å‚ç…§å†…å®¹ã‚„è£œè¶³æƒ…å ±"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">åˆ†æã‚«ãƒ†ã‚´ãƒª</div>
        <div id="self-cats" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
        <div class="btn-row"><button class="btn btn-p" id="self-btn" onclick="doAnalyze('self')">è§£æ åŸ·è¡Œ</button></div>
        <div id="self-result"></div>
      </div>
      <div id="apanel-assist" style="display:none;">
        <div class="sec-label">çŠ¶æ³ãƒ»æ–‡è„ˆ</div>
        <textarea id="assist-ctx" rows="6" placeholder="ç¾åœ¨ã®çŠ¶æ³ãƒ»ç›´å‰ã®å±•é–‹ãƒ»ç›¸æ‰‹ã®ç›´è¿‘ã®ãƒ­ãƒ¼ãƒ«ãªã©"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ï¼ˆä»»æ„ï¼‰</div>
        <textarea id="assist-chara" rows="3" placeholder="æ€§æ ¼ãƒ»èƒ½åŠ›ãƒ»ç«‹å ´ãƒ»å‹•æ©Ÿãªã©"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">è£œåŠ©ãƒ¢ãƒ¼ãƒ‰</div>
        <div id="assist-modes" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
        <div class="btn-row"><button class="btn btn-p" id="assist-btn" onclick="doAnalyze('assist')">è£œåŠ© åŸ·è¡Œ</button></div>
        <div id="assist-result"></div>
      </div>
      <!-- å™è¿°ãƒãƒ£ãƒƒãƒˆ -->
      <div id="apanel-chat" style="display:none;flex-direction:column;height:calc(100vh - 210px);">
        <div id="chat-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:0.8rem;padding-bottom:0.5rem;min-height:0;"></div>
        <div style="display:flex;gap:0.5rem;align-items:flex-end;padding-top:0.8rem;border-top:1px solid var(--border);margin-top:0.5rem;flex-shrink:0;">
          <textarea id="chat-input" rows="3" placeholder="Claudeã«è©±ã—ã‹ã‘ã‚‹â€¦" style="flex:1;resize:none;font-size:0.85rem;line-height:1.8;" onkeydown="chatKeydown(event)"></textarea>
          <div style="display:flex;flex-direction:column;gap:0.4rem;">
            <button class="btn btn-p btn-sm" id="chat-send-btn" onclick="sendChat()">é€ä¿¡</button>
            <button class="btn btn-g btn-sm" onclick="clearChat()">æ¶ˆå»</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="bnav-item" id="bnav-archive" onclick="switchPage('archive')">
      <span class="bnav-icon bnav-icon-archive">ğŸ“š</span><span class="bnav-label">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</span>
    </button>
    <button class="bnav-item active" id="bnav-roleplay" onclick="switchPage('roleplay')">
      <span class="bnav-icon">âš”</span><span class="bnav-label">ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤</span>
    </button>
    <button class="bnav-item" id="bnav-analyze" onclick="switchPage('analyze')">
      <span class="bnav-icon bnav-icon-analyze">ğŸ‘</span><span class="bnav-label">ã‚°ãƒªãƒ¢ãƒ¯ãƒ¼ãƒ«</span>
    </button>
  </nav>
</div>

<!-- â•â• ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ â•â• -->
<div id="help-page">
  <div class="options-header">
    <button class="header-icon-btn" onclick="closeHelp()">â†</button>
    <span class="options-title">Help</span>
  </div>
  <div class="help-body">

    <div class="help-section">
      <div class="help-section-title">èµ·å‹•</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ONLINE / OFFLINE ã®é•ã„</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p><span class="help-tag">ONLINE</span> ã‚’é¸ã¶ã¨ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ãƒ»ç«ã®ç²‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»BGMãƒ»SEãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚</p>
          <p><span class="help-tag">OFFLINE</span> ã‚’é¸ã¶ã¨ã“ã‚Œã‚‰ã®æ¼”å‡ºãªã—ã§èµ·å‹•ã—ã¾ã™ã€‚æ¥ç¶šãªã—ã§ã‚‚å…¨æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™ã€‚</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œæˆã™ã‚‹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚¿ãƒ–ä¸‹éƒ¨ã® <span class="help-tag">ï¼‹ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œæˆ</span> ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
          <p>è­˜åˆ¥ã‚¿ã‚°ï¼ˆä¾‹ï¼š#ã‚¢ãƒ³ãƒˆã‚¹ï¼‰ã¨åå‰ã¯å¿…é ˆé …ç›®ã§ã™ã€‚æ€§åˆ¥ãƒ»ç¨®æ—ãƒ»ã‚¸ãƒ§ãƒ–ã¯ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰é¸æŠã™ã‚‹ã¨ã€ã‚³ãƒ”ãƒ¼ç”¨ã®ã‚·ãƒ¼ãƒˆæ–‡å­—ï¼ˆá´á´€ÊŸá´‡ç­‰ï¼‰ã«è‡ªå‹•å¤‰æ›ã•ã‚Œã¾ã™ã€‚</p>
          <p>æ­¦è£…ãƒ»é˜²å…·ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ãƒ»é­”æ³•ã¯ <span class="help-tag">ï¼‹</span> ãƒœã‚¿ãƒ³ã§é …ç›®ã‚’è¿½åŠ ã§ãã¾ã™ã€‚ä¿å­˜å¾Œã¯ã„ã¤ã§ã‚‚ç·¨é›†ã§ãã¾ã™ã€‚</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ç”»é¢ã® <span class="help-tag">ã‚·ãƒ¼ãƒˆ</span> ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨LINEç”¨ã®æ•´å½¢ãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          <p><span class="help-tag">ã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼</span> ãƒœã‚¿ãƒ³ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ä¸€æ‹¬ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚ãã®ã¾ã¾LINEã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ãƒ­ãƒ¼ãƒ«ã‚’è¨˜éŒ²ã™ã‚‹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ãŸçŠ¶æ…‹ã§ <span class="help-tag">ï¼‹ ãƒ­ãƒ¼ãƒ«ã‚’è¨˜éŒ²</span> ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
          <p>ç¨®åˆ¥ï¼ˆç›¸æ‰‹ / è‡ªåˆ†ï¼‰ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³åãƒ»ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ã‚¿ã‚°ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›ã§ãã¾ã™ã€‚</p>
          <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³åã¯éå»ã«å…¥åŠ›ã—ãŸã‚‚ã®ãŒè£œå®Œå€™è£œã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèªãƒ»çµã‚Šè¾¼ã‚€</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ãƒ­ãƒ¼ãƒ«ä¸€è¦§ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã”ã¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãƒ»ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç›¸æ‰‹ / è‡ªåˆ†ï¼‰ã§çµã‚Šè¾¼ã‚ã¾ã™ã€‚</p>
          <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³åãƒãƒƒã‚¸ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ã ã‘ã«çµã‚Šè¾¼ã‚ã¾ã™ã€‚</p>
          <p>ãƒ­ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨æœ¬æ–‡ãƒ»ãƒ¡ãƒ¢ãƒ»åˆ†æçµæœãŒå±•é–‹ã•ã‚Œã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã¾ã™ã€‚</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç·¨é›†ãƒ»å‰Šé™¤ã™ã‚‹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ç”»é¢ã® <span class="help-tag">ç·¨é›†</span> ãƒœã‚¿ãƒ³ã‹ã‚‰å†…å®¹ã‚’ä¿®æ­£ã§ãã¾ã™ã€‚</p>
          <p><span class="help-tag">å‰Šé™¤</span> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨é–¢é€£ã™ã‚‹å…¨ãƒ­ãƒ¼ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ä¸–ç•Œè¦³è³‡æ–™ã‚’èª­ã¿è¾¼ã‚€</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”»é¢ã® <span class="help-tag">ä¸–ç•Œè¦³è³‡æ–™</span> ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç®¡ç†äººã«é…å¸ƒã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
          <p>èª­ã¿è¾¼ã‚“ã ä¸–ç•Œè¦³è³‡æ–™ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¿ãƒ–ã§é–²è¦§ã§ãã¾ã™ã€‚ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã‚‹ã®ã§æ¬¡å›ä»¥é™ã®èª­ã¿è¾¼ã¿ã¯ä¸è¦ã§ã™ã€‚</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">è¨˜äº‹ã‚’æ¤œç´¢ãƒ»çµã‚Šè¾¼ã‚€</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ä¸Šéƒ¨ã®æ¤œç´¢ãƒãƒ¼ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ã‚¿ã‚°ã‚’å¯¾è±¡ã«çµã‚Šè¾¼ã‚ã¾ã™ã€‚</p>
          <p>ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ç‰¹å®šã‚«ãƒ†ã‚´ãƒªã®è¨˜äº‹ã ã‘ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚è¨˜äº‹ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨æœ¬æ–‡ãŒå±•é–‹ã•ã‚Œã¾ã™ã€‚</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">åˆ†æ</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">åˆ†ææ©Ÿèƒ½ã‚’è§£æ”¾ã™ã‚‹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>åˆ†ææ©Ÿèƒ½ã«ã¯Anthropicã®APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<span class="help-tag">APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦è§£æ”¾ã™ã‚‹</span> ã‹ã‚‰ç™»éŒ²ç”»é¢ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚</p>
          <p>APIã‚­ãƒ¼ã¯console.anthropic.comã§ç„¡æ–™å–å¾—ã§ãã¾ã™ã€‚ãŸã ã—ä½¿ç”¨é‡ã«å¿œã˜ãŸè²»ç”¨ï¼ˆç›®å®‰ï¼š1å›ã‚ãŸã‚Š0.1ã€œ0.5å††ï¼‰ãŒç™ºç”Ÿã—ã¾ã™ã€‚è²»ç”¨ã®ç®¡ç†ã¯ã”è‡ªèº«ã§è¡Œã£ã¦ãã ã•ã„ã€‚</p>
          <p>ã‚­ãƒ¼ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–ã®ç«¯æœ«ã§ä½¿ã†å ´åˆã¯å†ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">å„åˆ†æãƒ¢ãƒ¼ãƒ‰ã®ä½¿ã„æ–¹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p><span class="help-tag">ç›¸æ‰‹</span> ç›¸æ‰‹ã®ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã‚’è²¼ã‚Šä»˜ã‘ã¦è§£æã—ã¾ã™ã€‚åˆ†æã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã™ã‚‹ã¨è¦³ç‚¹ã‚’æŒ‡å®šã§ãã¾ã™ã€‚</p>
          <p><span class="help-tag">è‡ªåˆ†</span> è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã‚’è²¼ã‚Šä»˜ã‘ã¦å¼·ã¿ã¨èª²é¡Œã‚’è©•ä¾¡ã—ã¾ã™ã€‚</p>
          <p><span class="help-tag">ä½œæˆè£œåŠ©</span> ç¾åœ¨ã®çŠ¶æ³ãƒ»æ–‡è„ˆã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ­ãƒ¼ãƒ«ã®è‰æ¡ˆã‚„æ§‹é€ ææ¡ˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚è£œåŠ©ãƒ¢ãƒ¼ãƒ‰ã§ç”¨é€”ã‚’çµã‚Œã¾ã™ã€‚</p>
          <p>ä¸–ç•Œè¦³è³‡æ–™ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã®å†…å®¹ã«é–¢é€£ã™ã‚‹è¨˜äº‹ã‚’è‡ªå‹•ã§å‚ç…§ã—ã¦åˆ†æç²¾åº¦ã‚’é«˜ã‚ã¾ã™ã€‚</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”»é¢ã® <span class="help-tag">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span> ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ãƒ­ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã›ã¾ã™ã€‚</p>
          <p>æ©Ÿç¨®å¤‰æ›´ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã«å‚™ãˆã¦å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
          <p>ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®çµ±åˆã«ãªã‚Šã¾ã™ã€‚é‡è¤‡ã™ã‚‹IDã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ã€‚</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">APIã‚­ãƒ¼ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹</span>
          <span class="help-item-arrow">â–¶</span>
        </div>
        <div class="help-item-body">
          <p>APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã§å¤±ã‚ã‚Œã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”»é¢ã® <span class="help-tag">APIã‚­ãƒ¼</span> ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç¾åœ¨ã®ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦åˆ¥é€”ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</p>
          <p><span class="help-tag">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«APIã‚­ãƒ¼ã‚’å«ã‚ã‚‹</span> ã‚’ONã«ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã«ã‚­ãƒ¼ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»–è€…ã«æ¸¡ã™éš›ã¯å¿…ãšOFFã«ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â•â• ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ â•â• -->
<div id="options-page">
  <div class="options-header">
    <button class="header-icon-btn" onclick="closeOptions()">â†</button>
    <span class="options-title">Options</span>
    <span id="online-badge" style="margin-left:auto;font-size:0.6rem;letter-spacing:0.2em;color:var(--accent2);text-transform:uppercase;display:none;">â— Online</span>
  </div>
  <div class="options-body">
    <div class="options-section">
      <div class="options-section-title">ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</div>
      <button class="btn btn-g" onclick="returnToTitle()">â†© ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
      <p style="font-size:0.7rem;color:var(--parchment-dk);margin-top:0.5rem;line-height:1.8;">ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«æˆ»ã‚Šã€ONLINE / OFFLINEã‚’é¸ã³ç›´ã›ã¾ã™ã€‚</p>
    </div>
      <div class="options-section-title">è¡¨ç¤º</div>
      <div class="toggle-row">
        <div><div class="toggle-label">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</div><div class="toggle-desc">ç«ã®ç²‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã®ã¿ï¼‰</div></div>
        <label class="toggle-switch"><input type="checkbox" id="opt-animation" checked onchange="onAnimationToggle()"><span class="toggle-slider"></span></label>
      </div>
    </div>
    <div class="options-section" id="opt-sound-section" style="display:none;">
      <div class="options-section-title">ã‚µã‚¦ãƒ³ãƒ‰</div>
      <div class="volume-row">
        <div class="volume-header"><span class="volume-label">SE éŸ³é‡</span><span class="volume-value" id="se-vol-label">70</span></div>
        <input type="range" id="opt-se-vol" min="0" max="100" value="70" oninput="onVolumeChange('se',this.value)" style="--val:70%;">
      </div>
      <div class="volume-row">
        <div class="volume-header"><span class="volume-label">BGM éŸ³é‡</span><span class="volume-value" id="bgm-vol-label">40</span></div>
        <input type="range" id="opt-bgm-vol" min="0" max="100" value="40" oninput="onVolumeChange('bgm',this.value)" style="--val:40%;">
      </div>
    </div>
    <div class="options-section">
      <div class="options-section-title">ãƒ€ã‚¤ã‚¹æ¼”å‡º</div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        <button class="btn btn-g btn-sm" id="dice-anim-shake" onclick="setDiceAnim('shake')">ã‚·ã‚§ã‚¤ã‚¯</button>
        <button class="btn btn-g btn-sm" id="dice-anim-spin"  onclick="setDiceAnim('spin')">ã‚¹ãƒ”ãƒ³</button>
        <button class="btn btn-g btn-sm" id="dice-anim-off"   onclick="setDiceAnim('off')">OFF</button>
      </div>
      <p style="font-size:0.7rem;color:var(--parchment-dk);margin-top:0.5rem;line-height:1.8;">ç¾åœ¨: <span id="dice-anim-current">ã‚·ã‚§ã‚¤ã‚¯</span></p>
    </div>

    <div class="options-section">
      <div class="options-section-title">APIã‚­ãƒ¼</div>
      <div id="api-key-status" style="font-size:0.75rem;color:var(--ink-dim);margin-bottom:1rem;"></div>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-g" onclick="copyApiKey()">ğŸ”‘ APIã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn btn-g" onclick="openModal('modal-api-setup')">å†ç™»éŒ²</button>
      </div>
      <div class="toggle-row" style="margin-top:1rem;">
        <div>
          <div class="toggle-label">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«APIã‚­ãƒ¼ã‚’å«ã‚ã‚‹</div>
          <div class="toggle-desc">OFFã‚’æ¨å¥¨ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»–è€…ã«æ¸¡ã™å ´åˆã¯å¿…ãšOFFã«ã—ã¦ãã ã•ã„ã€‚</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="opt-export-apikey" onchange="onExportApiKeyToggle()">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div id="apikey-export-warning" style="display:none;background:rgba(139,32,32,0.1);border:1px solid rgba(139,32,32,0.3);border-radius:2px;padding:0.8rem 1rem;margin-top:0.5rem;font-size:0.72rem;color:#c87070;line-height:1.9;">
        âš  æ³¨æ„äº‹é …<br>
        Â· APIã‚­ãƒ¼ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆJSONã«å¹³æ–‡ã§è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚<br>
        Â· ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»–è€…ã«é€ä»˜ãƒ»å…±æœ‰ã—ãŸå ´åˆã€ã‚­ãƒ¼ãŒæ¼æ´©ã—ã¾ã™ã€‚<br>
        Â· æ¼æ´©ã—ãŸã‚­ãƒ¼ã¯ç¬¬ä¸‰è€…ã«ç„¡åˆ¶é™ã«ä½¿ç”¨ã•ã‚Œã‚‹æã‚ŒãŒã‚ã‚Šã€<br>
        ã€€ç™ºç”Ÿã—ãŸè²»ç”¨ã¯å…¨ã¦ã”è‡ªèº«ã«è«‹æ±‚ã•ã‚Œã¾ã™ã€‚<br>
        Â· å€‹äººãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å°‚ç”¨ã¨ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
      </div>
    </div>

    <div class="options-section">
      <div class="options-section-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
      <p style="font-size:0.78rem;color:var(--ink-dim);line-height:1.8;margin-bottom:1rem;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ­ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚</p>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-g" onclick="exportData()">ğŸ“¤ æ›¸ãå‡ºã™</button>
        <button class="btn btn-g" onclick="importData()">ğŸ“‚ èª­ã¿è¾¼ã‚€</button>
      </div>
      <hr class="sep">
      <p style="font-size:0.75rem;color:#c87070;line-height:1.8;margin-bottom:0.8rem;">âš  ä»¥ä¸‹ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</p>
      <button class="btn btn-d" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»</button>
    </div>
    <div class="options-section">
      <div class="options-section-title">ä¸–ç•Œè¦³è³‡æ–™</div>
      <div id="db-current-info" style="font-size:0.75rem;color:var(--ink-dim);margin-bottom:1rem;"></div>
      <button class="btn btn-p" onclick="loadDB()">ğŸ“‚ ä¸–ç•Œè¦³è³‡æ–™ã‚’èª­ã¿è¾¼ã‚€</button>
    </div>
  </div>
</div>

<!-- â•â• ãƒ¢ãƒ¼ãƒ€ãƒ« â•â• -->
<div class="modal-overlay" id="modal-new-role">
  <div class="modal">
    <div class="modal-title">ãƒ­ãƒ¼ãƒ«ã‚’è¨˜éŒ²</div>
    <label class="fl" style="margin-top:0;">ç¨®åˆ¥</label>
    <select id="nr-type"><option value="opp">ç›¸æ‰‹ã®ãƒ­ãƒ¼ãƒ«</option><option value="self">è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«</option></select>
    <label class="fl">ã‚»ãƒƒã‚·ãƒ§ãƒ³å</label>
    <input type="text" id="nr-session" placeholder="ä¾‹ï¼šç¬¬3ç«  ç‹éƒ½ã®å¤œ" list="session-datalist">
    <datalist id="session-datalist"></datalist>
    <label class="fl">ãƒ­ãƒ¼ãƒ«æœ¬æ–‡</label>
    <textarea id="nr-body" rows="7" placeholder="ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
    <label class="fl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="nr-memo" rows="2" placeholder="åˆ†æãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³ãƒ»ä¼ç·šãªã©"></textarea>
    <label class="fl">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
    <input type="text" id="nr-tags" placeholder="ä¾‹ï¼šä¼ç·š, é‡è¦, æˆ¦é—˜">
    <div class="btn-row">
      <button class="btn btn-p" onclick="saveRole()">ä¿å­˜</button>
      <button class="btn btn-g" onclick="closeModal('modal-new-role')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-api-setup">
  <div class="modal">
    <div class="modal-title">ğŸ”‘ APIã‚­ãƒ¼ç™»éŒ²</div>
    <p style="font-size:0.8rem;color:var(--ink-dim);line-height:1.9;margin-bottom:1.2rem;">åˆ†ææ©Ÿèƒ½ã¯Anthropicç¤¾ã®AIã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
    <div class="modal-step"><div class="step-num">1</div><div class="step-text"><span class="step-link" onclick="window.open('https://console.anthropic.com','_blank')">ã“ã¡ã‚‰</span>ã‚’é–‹ãAnthropicã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</div></div>
    <div class="modal-step"><div class="step-num">2</div><div class="step-text">ã€ŒAPI Keysã€â†’ã€ŒCreate Keyã€ã§APIã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¦ãã ã•ã„ã€‚</div></div>
    <div class="modal-step"><div class="step-num">3</div><div class="step-text">ç™ºè¡Œã•ã‚ŒãŸã‚­ãƒ¼ï¼ˆ"sk-ant-â€¦"ï¼‰ã‚’ä¸‹ã®æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div></div>
    <div class="caution-box">âš  APIã®ä½¿ç”¨ã¯å¾“é‡åˆ¶ã§ã™ï¼ˆç´„0.1ã€œ0.5å††/å›ï¼‰ã€‚ã‚­ãƒ¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç®¡ç†ãƒ»è²»ç”¨ã¯ã”è‡ªèº«ã®è²¬ä»»ã¨ãªã‚Šã¾ã™ã€‚</div>
    <label class="fl" style="margin-top:0;">APIã‚­ãƒ¼</label>
    <input type="password" id="api-key-input" placeholder="sk-ant-â€¦">
    <div class="btn-row">
      <button class="btn btn-p" onclick="registerApiKey()">ç™»éŒ²ã—ã¦è§£æ”¾</button>
      <button class="btn btn-g" onclick="closeModal('modal-api-setup')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-announce">
  <div class="modal">
    <div class="modal-title">ğŸ“£ ãŠçŸ¥ã‚‰ã›</div>
    <div id="announce-modal-content" class="announce-modal-list"></div>
    <div class="btn-row"><button class="btn btn-g" onclick="closeModal('modal-announce')">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-mode-online">
  <div class="modal">
    <div class="modal-title">ONLINE ãƒ¢ãƒ¼ãƒ‰</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.2rem;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§BGMãƒ»SEã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚APIæ¥ç¶šå¾Œã€AIï¼ˆClaudeï¼‰æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚å„è‡ªéŸ³å£°ã¯ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰èª¿æ•´ãŒå¯èƒ½ã§ã™ã€‚</p>
    <div style="margin-bottom:1.2rem;">
      <label class="cb-wrap">
        <input type="checkbox" id="skip-online-confirm">
        <span class="cb-box"></span>
        <span style="font-size:0.75rem;color:var(--ink-dim);">æ¬¡å›ã‹ã‚‰è¡¨ç¤ºã—ãªã„</span>
      </label>
    </div>
    <div class="btn-row">
      <button class="btn btn-p" onclick="confirmMode('online')">ç¶šè¡Œ</button>
      <button class="btn btn-g" onclick="cancelMode('modal-mode-online')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-mode-offline">
  <div class="modal">
    <div class="modal-title">OFFLINE ãƒ¢ãƒ¼ãƒ‰</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.2rem;">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§Grimoireã‚’ç¶šè¡Œã—ã¾ã™ã€‚AIï¼ˆClaudeï¼‰æ©Ÿèƒ½ãŒã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¸ã®åˆ‡ã‚Šæ›¿ãˆã¯ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€Œã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ã€ã§å†ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§å¯èƒ½ã§ã™ã€‚</p>
    <div style="margin-bottom:1.2rem;">
      <label class="cb-wrap">
        <input type="checkbox" id="skip-offline-confirm">
        <span class="cb-box"></span>
        <span style="font-size:0.75rem;color:var(--ink-dim);">æ¬¡å›ã‹ã‚‰è¡¨ç¤ºã—ãªã„</span>
      </label>
    </div>
    <div class="btn-row">
      <button class="btn btn-p" onclick="confirmMode('offline')">ç¶šè¡Œ</button>
      <button class="btn btn-g" onclick="cancelMode('modal-mode-offline')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- â•â• æ­»äº¡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« â•â• -->
<div class="modal-overlay" id="modal-lost-char">
  <div class="modal">
    <div class="modal-title" id="modal-lost-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ­»äº¡å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.5rem;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åãŒèµ¤æ–‡å­—ã§å¼·èª¿è¡¨ç¤ºã•ã‚Œã€çŠ¶æ…‹ã«ã€Œæ­»äº¡ã€ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ã‹ã‚‰å–ã‚Šæ¶ˆã›ã¾ã™ã€‚</p>
    <div class="btn-row">
      <button class="btn btn-d" onclick="confirmLost()">æ­»äº¡å‡¦ç†</button>
      <button class="btn btn-g" onclick="closeModal('modal-lost-char')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- â•â• è˜‡ç”Ÿç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« â•â• -->
<div class="modal-overlay" id="modal-revive-char">
  <div class="modal">
    <div class="modal-title" id="modal-revive-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è˜‡ç”Ÿã—ã¾ã™ã‹ï¼Ÿ</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.5rem;">æ­»äº¡çŠ¶æ…‹ã‚’è§£é™¤ã—ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’é€šå¸¸è¡¨ç¤ºã«æˆ»ã—ã¾ã™ã€‚</p>
    <div class="btn-row">
      <button class="btn btn-p" onclick="confirmRevive()">è˜‡ç”Ÿ</button>
      <button class="btn btn-g" onclick="closeModal('modal-revive-char')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- â•â• ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ1æ®µéšç›®ï¼‰ â•â• -->
<div class="modal-overlay" id="modal-delete-char">
  <div class="modal">
    <div class="modal-title" id="modal-delete-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.5rem;">å‰Šé™¤ã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ç´ã¥ããƒ­ãƒ¼ãƒ«ã¯å®Œå…¨ã«å¤±ã‚ã‚Œã¾ã™ã€‚</p>
    <div class="btn-row">
      <button class="btn btn-d" onclick="openDeleteFinalModal()">æ¬¡ã¸</button>
      <button class="btn btn-g" onclick="closeModal('modal-delete-char')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- â•â• ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤æœ€çµ‚ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ2æ®µéšç›®ï¼‰ â•â• -->
<div class="modal-overlay" id="modal-delete-final">
  <div class="modal">
    <div class="modal-title">æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.2rem;">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
    <div style="margin-bottom:1.5rem;">
      <label class="cb-wrap">
        <input type="checkbox" id="delete-char-with-roles">
        <span class="cb-box"></span>
        <span style="font-size:0.75rem;color:var(--ink-dim);">å‰Šé™¤å¾Œã«JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã™</span>
      </label>
    </div>
    <div class="btn-row">
      <button class="btn btn-d" id="btn-delete-final" onclick="confirmDeleteChar()" disabled>å‰Šé™¤</button>
      <button class="btn btn-g" onclick="cancelDeleteFinal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- â•â• ã‚«ãƒãƒ³ãƒãƒƒãƒ— â•â• -->
<button id="bag-btn" onclick="toggleBag()">âœ’ï¸</button>
<div id="bag-menu">
  <div class="bag-menu-item" onclick="openBagTool('dice')">ğŸ² ãƒ€ã‚¤ã‚¹</div>
  <div class="bag-menu-item" onclick="openBagTool('memo')">ğŸ“ ãƒ¡ãƒ¢å¸³</div>
  <div class="bag-menu-item" onclick="openBagTool('calc')">ğŸ”¢ é›»å“</div>
</div>

<!-- é›»å“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="modal-calc">
  <div class="bag-modal">
    <div class="bag-modal-header">
      <span class="bag-modal-title">Calculator</span>
      <button class="bag-modal-close" onclick="closeModal('modal-calc')">âœ•</button>
    </div>
    <div class="bag-modal-body">
      <div class="calc-display">
        <div class="calc-expr" id="calc-expr"></div>
        <div class="calc-val" id="calc-val">0</div>
      </div>
      <div class="calc-grid" style="grid-template-columns:repeat(5,1fr);">
        <button class="calc-btn cl" onclick="calcClear()">C</button>
        <button class="calc-btn op" onclick="calcSign()">Â±</button>
        <button class="calc-btn op" onclick="calcPercent()">%</button>
        <button class="calc-btn cl" onclick="calcBack()">âŒ«</button>
        <button class="calc-btn op" onclick="calcOp('/')">Ã·</button>
        <button class="calc-btn" onclick="calcNum('7')">7</button>
        <button class="calc-btn" onclick="calcNum('8')">8</button>
        <button class="calc-btn" onclick="calcNum('9')">9</button>
        <button class="calc-btn op" colspan="2" onclick="calcOp('*')" style="grid-column:span 2;">Ã—</button>
        <button class="calc-btn" onclick="calcNum('4')">4</button>
        <button class="calc-btn" onclick="calcNum('5')">5</button>
        <button class="calc-btn" onclick="calcNum('6')">6</button>
        <button class="calc-btn op" colspan="2" onclick="calcOp('-')" style="grid-column:span 2;">âˆ’</button>
        <button class="calc-btn" onclick="calcNum('1')">1</button>
        <button class="calc-btn" onclick="calcNum('2')">2</button>
        <button class="calc-btn" onclick="calcNum('3')">3</button>
        <button class="calc-btn op" colspan="2" onclick="calcOp('+')" style="grid-column:span 2;">ï¼‹</button>
        <button class="calc-btn" onclick="calcNum('0')" style="grid-column:span 2;">0</button>
        <button class="calc-btn" onclick="calcDot()">.</button>
        <button class="calc-btn eq" onclick="calcEqual()" style="grid-column:span 2;">=</button>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ¡ãƒ¢å¸³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="modal-memo">
  <div class="bag-modal" style="max-width:520px;">
    <div class="bag-modal-header">
      <span class="bag-modal-title">Notepad</span>
      <button class="bag-modal-close" onclick="closeModal('modal-memo')">âœ•</button>
    </div>
    <div class="bag-modal-body">
      <div class="memo-tabs">
        <button class="memo-tab active" id="memo-tab-flat" onclick="switchMemoTab('flat')">ãƒ•ãƒ©ãƒƒãƒˆ</button>
        <button class="memo-tab" id="memo-tab-mind" onclick="switchMemoTab('mind')">ãƒã‚¤ãƒ³ãƒ‰</button>
      </div>
      <div id="memo-flat-panel">
        <textarea id="memo-flat-text" rows="12" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" style="font-size:0.85rem;line-height:1.9;"></textarea>
        <div class="btn-row"><button class="btn btn-g btn-sm" onclick="clearFlatMemo()">ã‚¯ãƒªã‚¢</button><button class="btn btn-g btn-sm" onclick="copyFlatMemo()">ã‚³ãƒ”ãƒ¼</button></div>
      </div>
      <div id="memo-mind-panel" style="display:none;">
        <div class="mindmap-toolbar">
          <button class="btn btn-g btn-sm" onclick="mmAddChild()">ï¼‹ å­ãƒãƒ¼ãƒ‰</button>
          <button class="btn btn-g btn-sm" onclick="mmDeleteNode()">âœ• å‰Šé™¤</button>
          <button class="btn btn-g btn-sm" onclick="mmEditNode()">âœ ç·¨é›†</button>
          <button class="btn btn-g btn-sm" onclick="mmToggleFullscreen()">â›¶ å…¨ç”»é¢</button>
          <button class="btn btn-d btn-sm" onclick="mmClear()">å…¨æ¶ˆå»</button>
        </div>
        <canvas id="mindmap-canvas"></canvas>
        <p style="font-size:0.65rem;color:var(--parchment-dk);margin-top:0.5rem;line-height:1.8;">ãƒãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ â†’ å­ãƒãƒ¼ãƒ‰è¿½åŠ  / ç·¨é›† / å‰Šé™¤</p>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ€ã‚¤ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="modal-dice">
  <div class="bag-modal">
    <div class="bag-modal-header">
      <span class="bag-modal-title">Dice</span>
      <button class="bag-modal-close" onclick="closeModal('modal-dice')">âœ•</button>
    </div>
    <div class="bag-modal-body">
      <div class="dice-grid">
        <div class="dice-btn" onclick="rollDice(4)"><div class="dice-label">D4</div><div class="dice-icon">ğŸ”º</div></div>
        <div class="dice-btn" onclick="rollDice(6)"><div class="dice-label">D6</div><div class="dice-icon">ğŸ²</div></div>
        <div class="dice-btn" onclick="rollDice(8)"><div class="dice-label">D8</div><div class="dice-icon">ğŸ’ </div></div>
        <div class="dice-btn" onclick="rollDice(10)"><div class="dice-label">D10</div><div class="dice-icon">ğŸ”·</div></div>
        <div class="dice-btn" onclick="rollDice(12)"><div class="dice-label">D12</div><div class="dice-icon">ğŸ”¶</div></div>
        <div class="dice-btn" onclick="rollDice(20)"><div class="dice-label">D20</div><div class="dice-icon">â­</div></div>
      </div>
      <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:1rem;">
        <input type="number" id="dice-custom-faces" min="2" max="999" placeholder="é¢æ•°" style="width:80px;">
        <button class="btn btn-g btn-sm" onclick="rollDice(parseInt(document.getElementById('dice-custom-faces').value)||6)">ã‚«ã‚¹ã‚¿ãƒ </button>
      </div>
      <div class="dice-result-area">
        <div class="dice-result-num" id="dice-result">â€”</div>
        <div class="dice-result-label" id="dice-result-label"></div>
      </div>
      <div id="dice-history" style="margin-top:0.8rem;font-size:0.72rem;color:var(--parchment-dk);line-height:2;max-height:80px;overflow-y:auto;"></div>
    </div>
  </div>
</div>

<input type="file" id="import-file" accept=".json" style="display:none;">
<input type="file" id="db-file" accept=".json" style="display:none;">
<audio id="se-page" src="" preload="metadata"></audio>
<audio id="bgm-main" src="" loop preload="metadata"></audio>

<script>
'use strict';
const KEY_CHARS  = 'gm_characters';
const KEY_ROLES  = 'gm_roles';
const KEY_DB     = 'gm_worlddb';
const KEY_ANN    = 'gm_announce_cache';
const KEY_API    = 'gm_apikey';
const KEY_OPTS   = 'gm_options';
const GIST_URL   = '';

const DEFAULT_CATS  = ['æ­´å²ãƒ»æ”¿æ²»','é­”æ³•ãƒ»è¡“å¼','æˆ¦è¡“ãƒ»æˆ¦é—˜','ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¿ƒç†','ä¸–ç•Œè¦³æ•´åˆæ€§'];
const ASSIST_MODES  = [{id:'draft',name:'è¿”ã—ã®è‰æ¡ˆç”Ÿæˆ'},{id:'skeleton',name:'æ§‹é€ ææ¡ˆ'},{id:'emotion',name:'æ„Ÿæƒ…ãƒ»å‹•æ©Ÿã®æ·±æ˜ã‚Š'},{id:'tension',name:'ç·Šå¼µæ„Ÿã®è¨­è¨ˆ'}];

let isOnline=false, characters=[], roles=[], worldDB=null, announces=[], apiKey='';
let options={animation:true,seVol:70,bgmVol:40,exportApiKey:false};
let currentCharId=null, editingCharId=null;
const checkedCats={opp:new Set(),self:new Set()}, checkedModes=new Set();

// â•â• ã‚¿ã‚¤ãƒˆãƒ« â•â•
function onStartClick(){
  const s=document.getElementById('title-start');
  s.style.opacity='0'; s.style.transition='opacity 0.4s';
  setTimeout(()=>{s.style.display='none'; document.getElementById('title-mode').style.display='flex';},400);
}
function selectMode(mode){
  const skipKey = mode==='online' ? 'gm_skip_online_confirm' : 'gm_skip_offline_confirm';
  if(localStorage.getItem(skipKey)==='1'){
    proceedMode(mode);
  } else {
    openModal(mode==='online' ? 'modal-mode-online' : 'modal-mode-offline');
  }
}
async function confirmMode(mode){
  const skipKey = mode==='online' ? 'gm_skip_online_confirm' : 'gm_skip_offline_confirm';
  const skipEl  = document.getElementById(mode==='online' ? 'skip-online-confirm' : 'skip-offline-confirm');
  if(skipEl?.checked) localStorage.setItem(skipKey,'1');
  closeModal(mode==='online' ? 'modal-mode-online' : 'modal-mode-offline');
  await proceedMode(mode);
}
function cancelMode(modalId){
  closeModal(modalId);
}
async function proceedMode(mode){
  isOnline=(mode==='online');
  const loadingEl=document.getElementById('title-loading');
  if(isOnline){
    document.getElementById('title-mode').style.opacity='0';
    document.getElementById('title-mode').style.transition='opacity 0.3s';
    loadingEl.textContent='æ¥ç¶šç¢ºèªä¸­â€¦';
    loadingEl.style.display='block';
    // â”€â”€ ãƒãƒƒãƒˆæ¥ç¶šãƒã‚§ãƒƒã‚¯ â”€â”€
    const connected=checkNetworkConnection();
    if(!connected){
      // æ¥ç¶šä¸å¯ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã—ã¦ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çµŒè·¯ã¸
      isOnline=false;
      loadingEl.style.animation='none';
      loadingEl.style.opacity='1';
      loadingEl.style.color='var(--parchment-dim)';
      loadingEl.style.fontSize='0.75rem';
      loadingEl.style.letterSpacing='0.1em';
      loadingEl.textContent='ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§é–‹å§‹ã—ã¾ã™';
      await new Promise(r=>setTimeout(r,2200));
      loadingEl.style.display='none';
    } else {
      loadingEl.textContent='Loadingâ€¦';
      loadingEl.style.animation='';
      await loadOnlineResources();
    }
  }
  const t=document.getElementById('title-screen');
  t.classList.add('fade-out');
  setTimeout(()=>{t.style.display='none'; launchApp();},800);
}
function checkNetworkConnection(){
  return navigator.onLine;
}
function returnToTitle(){
  closeOptions();
  document.getElementById('offline-overlay').classList.remove('visible');
  document.body.classList.remove('offline');
  document.getElementById('bnav-analyze').classList.remove('disabled');
  const app=document.getElementById('app');
  app.classList.remove('visible');
  setTimeout(()=>{
    app.style.display='none';
    stopParticles();
    const t=document.getElementById('title-screen');
    t.style.display='flex'; t.style.opacity='0';
    t.classList.remove('fade-out');
    document.getElementById('title-start').style.display='none';
    document.getElementById('title-mode').style.display='flex';
    document.getElementById('title-mode').style.opacity='1';
    document.getElementById('title-loading').style.display='none';
    setTimeout(()=>t.style.opacity='1',30);
  },300);
}
async function loadOnlineResources(){
  const l=document.createElement('link'); l.rel='stylesheet';
  l.href='https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=Noto+Serif+JP:wght@300;400;600&display=swap';
  document.head.appendChild(l);
  try{await document.fonts.ready;}catch(e){}
  if(options.animation) initParticles();
  const bgm=document.getElementById('bgm-main');
  if(bgm.src&&bgm.src!==location.href){bgm.volume=options.bgmVol/100; bgm.play().catch(()=>{});}
}
function launchApp(){
  const app=document.getElementById('app');
  app.style.display='block'; setTimeout(()=>app.classList.add('visible'),30);
  const badge=document.getElementById('online-badge');
  if(isOnline){
    badge.style.display='block';
    badge.textContent='â— Online';
    badge.style.color='var(--accent2)';
    document.getElementById('opt-sound-section').style.display='block';
    fetchAnnounce();
  } else {
    badge.style.display='block';
    badge.textContent='â— Offline';
    badge.style.color='var(--parchment-dk)';
    document.getElementById('opt-sound-section').style.display='none';
    document.body.classList.add('offline');
    document.getElementById('bnav-analyze').classList.add('disabled');
    setTimeout(()=>document.getElementById('offline-overlay').classList.add('visible'),100);
  }
  renderCharList();
  showBagBtn();
}

// â•â• ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« â•â•
let particles=[],particleRunning=false,animFrame;
let windX=0, windY=0;
function initParticles(){
  const c=document.getElementById('particle-canvas');
  c.width=window.innerWidth; c.height=window.innerHeight; c.classList.add('visible');
  window.addEventListener('resize',()=>{c.width=window.innerWidth;c.height=window.innerHeight;});
  particleRunning=true; windX=0; windY=0; animFrame=requestAnimationFrame(animateParticles);
}
function stopParticles(){
  particleRunning=false; cancelAnimationFrame(animFrame);
  const c=document.getElementById('particle-canvas'); c.classList.remove('visible');
  c.getContext('2d').clearRect(0,0,c.width,c.height); particles=[]; windX=0; windY=0;
}
function animateParticles(){
  if(!particleRunning)return;
  const c=document.getElementById('particle-canvas'), ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);

  // é¢¨åŠ›æ¸›è¡°ï¼ˆç´„2ç§’ã§ã»ã¼ã‚¼ãƒ­ã¸ï¼‰
  windX *= 0.955;
  if(Math.abs(windX)<0.02) windX=0;
  windY *= 0.955;
  if(Math.abs(windY)<0.02) windY=0;

  // ç”Ÿæˆä¸Šé™ï¼šé¢¨ãŒã‚ã‚‹é–“ã¯å°‘ã—å¤šã‚
  const spawnCap = (windX!==0||windY!==0) ? 65 : 50;
  if(particles.length<spawnCap&&Math.random()<0.3){
    particles.push({
      x:   Math.random()*c.width,
      y:   c.height + Math.random()*10,
      vx:  (Math.random()-0.5)*1.04,
      vy:  -(Math.random()*1.43+0.52),
      life:    0,
      maxLife: Math.random()*240+120,
      size:    Math.random()*2.2+0.6,
      hue:  Math.random()*20+5,
      sat:  95+Math.random()*5,
      lit:  45+Math.random()*15,
      angle: Math.random()*Math.PI*2,
      spin:  (Math.random()-0.5)*0.15,
      rx: 1,
      ry: 1.6+Math.random()*0.8,
    });
  }

  particles=particles.filter(p=>{
    p.life++;
    p.x  += p.vx + Math.sin(p.life*0.04)*0.3;
    p.y  += p.vy;
    p.vy *= 0.994;
    p.vx *= 0.92; // æ¨ªé€Ÿåº¦ã‚’ç´ æ—©ãæ¸›è¡°ã•ã›ã€Œä¸€ç¬ã ã‘å¼·ã„ã€ã«
    p.angle += p.spin;

    const prog  = p.life / p.maxLife;
    const flicker = 0.85 + Math.sin(p.life*0.3)*0.15;
    const alpha = (prog<0.15 ? prog/0.15 : prog>0.7 ? (1-prog)/0.3 : 1) * 0.85 * flicker;
    const hueShift = p.hue + prog*15;
    const litShift = p.lit - prog*30;

    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.angle);

    const grd = ctx.createRadialGradient(0,0,0, 0,0, p.size*p.ry*2.5);
    grd.addColorStop(0,   `hsla(${hueShift},${p.sat}%,${litShift+15}%,${alpha*0.6})`);
    grd.addColorStop(0.4, `hsla(${hueShift},${p.sat}%,${litShift}%,${alpha*0.3})`);
    grd.addColorStop(1,   `hsla(${hueShift},${p.sat}%,${litShift}%,0)`);
    ctx.beginPath();
    ctx.ellipse(0, 0, p.size*p.rx*2.5, p.size*p.ry*2.5, 0, 0, Math.PI*2);
    ctx.fillStyle = grd;
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(0, 0, p.size*p.rx, p.size*p.ry, 0, 0, Math.PI*2);
    ctx.fillStyle = `hsla(${hueShift+5},${p.sat}%,${Math.min(litShift+15,75)}%,${alpha})`;
    ctx.fill();

    ctx.restore();
    return p.life<p.maxLife && p.y>-20 && p.x>-20 && p.x<c.width+20;
  });

  animFrame=requestAnimationFrame(animateParticles);
}

// â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ï¼šå…¨ç²’å­ã«æ–œã‚ä¸Šæ–¹å‘ã®åˆé€Ÿã‚’ä¸€åº¦åŠ ãˆã‚‹ â”€â”€
function burstParticles(fromDir){
  if(!particleRunning)return;
  const dir = fromDir==='left' ? 1 : -1;
  particles.forEach(p=>{
    const m = 0.8 + Math.random()*0.6;
    p.vx += dir  * (3.5 + Math.random()*1.5) * m;
    p.vy += -(2.5 + Math.random()*1.2) * m;
  });
  windX = dir  * (0.6 + Math.random()*0.3);
  windY = -(0.4 + Math.random()*0.2);
}

// â•â• ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª â•â•
function playSE(name){
  if(!isOnline)return;
  const el=document.getElementById(`se-${name}`);
  if(!el||!el.src||el.src===location.href)return;
  el.currentTime=0; el.volume=options.seVol/100; el.play().catch(()=>{});
}
// ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ç”¨ï¼ˆisOnlineå•ã‚ãšé³´ã‚‰ã™ï¼‰
function playSETitle(){
  const el=document.getElementById('se-page');
  if(!el||!el.src||el.src===location.href)return;
  el.currentTime=0; el.volume=options.seVol/100; el.play().catch(()=>{});
}

// â•â• ã‚ªãƒ—ã‚·ãƒ§ãƒ³ â•â•
function loadOptions(){const s=JSON.parse(localStorage.getItem(KEY_OPTS)||'{}'); options.animation=s.animation!==undefined?s.animation:true; options.seVol=s.seVol??70; options.bgmVol=s.bgmVol??40; options.exportApiKey=s.exportApiKey||false;}
function saveOptions(){localStorage.setItem(KEY_OPTS,JSON.stringify(options));}
function openOptions(){
  setDiceAnim(diceAnimMode);
  const p=document.getElementById('options-page'); p.style.display='block'; setTimeout(()=>p.classList.add('open'),10);
  document.getElementById('opt-animation').checked=options.animation;
  const sv=document.getElementById('opt-se-vol'), bv=document.getElementById('opt-bgm-vol');
  sv.value=options.seVol; bv.value=options.bgmVol;
  sv.style.setProperty('--val',options.seVol+'%'); bv.style.setProperty('--val',options.bgmVol+'%');
  document.getElementById('se-vol-label').textContent=options.seVol;
  document.getElementById('bgm-vol-label').textContent=options.bgmVol;
  // APIã‚­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  const statusEl=document.getElementById('api-key-status');
  if(statusEl) statusEl.textContent=apiKey?`ç™»éŒ²æ¸ˆã¿ï¼ˆsk-ant-â€¦${apiKey.slice(-4)}ï¼‰`:'æœªç™»éŒ²';
  const exportToggle=document.getElementById('opt-export-apikey');
  if(exportToggle) exportToggle.checked=options.exportApiKey;
  const warning=document.getElementById('apikey-export-warning');
  if(warning) warning.style.display=options.exportApiKey?'block':'none';
  updateDBInfo();
}
function openHelp(){
  const p=document.getElementById('help-page'); p.style.display='block'; setTimeout(()=>p.classList.add('open'),10);
}
function closeHelp(){
  const p=document.getElementById('help-page'); p.classList.remove('open'); setTimeout(()=>p.style.display='none',300);
}
function toggleHelp(header){
  const arrow=header.querySelector('.help-item-arrow');
  const body=header.nextElementSibling;
  const isOpen=body.classList.contains('open');
  body.classList.toggle('open',!isOpen);
  arrow.classList.toggle('open',!isOpen);
}

function closeOptions(){const p=document.getElementById('options-page');p.classList.remove('open');setTimeout(()=>p.style.display='none',300);}
function onAnimationToggle(){options.animation=document.getElementById('opt-animation').checked;saveOptions();if(!isOnline)return;if(options.animation)initParticles();else stopParticles();}
function onVolumeChange(t,v){
  const n=parseInt(v);
  if(t==='se'){options.seVol=n;document.getElementById('se-vol-label').textContent=n;document.getElementById('opt-se-vol').style.setProperty('--val',n+'%');}
  else{options.bgmVol=n;document.getElementById('bgm-vol-label').textContent=n;document.getElementById('opt-bgm-vol').style.setProperty('--val',n+'%');document.getElementById('bgm-main').volume=n/100;}
  saveOptions();
}

// â•â• ãƒŠãƒ“ â•â•
let currentPage='roleplay';
const PAGE_ORDER=['archive','roleplay','analyze'];
function switchPage(name){
  if(name===currentPage)return;
  if(!isOnline && name==='analyze')return; // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ã‚°ãƒªãƒ¢ãƒ¯ãƒ¼ãƒ«å°é–
  // æ–¹å‘åˆ¤å®šï¼šå³å´ã‚¿ãƒ–ã¸ã®ç§»å‹•ãªã‚‰å·¦ã‹ã‚‰é¢¨ã€å·¦å´ãªã‚‰å³ã‹ã‚‰é¢¨
  const fromIdx=PAGE_ORDER.indexOf(currentPage);
  const toIdx=PAGE_ORDER.indexOf(name);
  const windDir=(toIdx>fromIdx)?'left':'right';
  const outEl=document.getElementById(`page-${currentPage}`);
  const inEl =document.getElementById(`page-${name}`);
  outEl.classList.add('flip-out');
  outEl.addEventListener('animationend',()=>{
    outEl.classList.remove('active','flip-out');
    inEl.classList.add('active','flip-in');
    inEl.addEventListener('animationend',()=>{
      inEl.classList.remove('flip-in');
    },{once:true});
  },{once:true});
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById(`bnav-${name}`).classList.add('active');
  currentPage=name;
  if(name==='archive')renderArchiveArea(!isOnline);
  // ç«ã®ç²‰ãƒãƒ¼ã‚¹ãƒˆï¼ˆã‚¢ãƒ‹ãƒ¡ONæ™‚ã®ã¿ï¼‰
  if(options.animation)burstParticles(windDir);
}
function switchAnalyzeTab(tab){
  ['opp','self','assist','chat'].forEach(t=>{
    const panel=document.getElementById(`apanel-${t}`);
    panel.style.display='none';
    if(t==='chat') panel.classList.remove('active-panel');
    const b=document.getElementById(`atab-${t}`);
    if(b){b.style.borderBottom='2px solid transparent';b.style.color='var(--ink-dim)';}
  });
  const activePanel=document.getElementById(`apanel-${tab}`);
  if(tab==='chat'){activePanel.style.display='flex';activePanel.classList.add('active-panel');}
  else activePanel.style.display='block';
  const activeBtn=document.getElementById(`atab-${tab}`);
  if(activeBtn){activeBtn.style.borderBottom='2px solid var(--accent)';activeBtn.style.color='var(--accent)';}
}

// â”€â”€ å™è¿°ãƒãƒ£ãƒƒãƒˆ â”€â”€
let chatHistory=[];
function chatKeydown(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}
}
async function sendChat(){
  const input=document.getElementById('chat-input');
  const text=input.value.trim();
  if(!text)return;
  if(!apiKey){alert('APIã‚­ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');return;}
  input.value='';
  appendChatBubble('user',text);
  chatHistory.push({role:'user',content:text});
  const loadingId='chat-loading-'+Date.now();
  appendChatBubble('ai','â€¦',true,loadingId);
  const btn=document.getElementById('chat-send-btn');
  btn.disabled=true;

  // ä¸–ç•Œè¦³è³‡æ–™ã‚’è£œè¶³
  let systemPrompt='ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤æ”¯æ´AIã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±ã«è‡ªç„¶ã«å¿œç­”ã—ã¦ãã ã•ã„ã€‚';
  if(worldDB){
    systemPrompt+=`\n\nã€ä¸–ç•Œè¦³è³‡æ–™: ${worldDB.name||''}ã€‘\n`;
    const cats=(worldDB.categories||[]).map(c=>c.name).join('ãƒ»');
    systemPrompt+=`ã‚«ãƒ†ã‚´ãƒª: ${cats}`;
  }

  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1024,
        system:systemPrompt,
        messages:chatHistory
      })
    });
    if(!res.ok){const e=await res.json().catch(()=>{});throw new Error(e?.error?.message||`HTTP ${res.status}`);}
    const data=await res.json();
    const reply=data.content?.map(c=>c.text||'').join('')||'';
    chatHistory.push({role:'assistant',content:reply});
    removeChatBubble(loadingId);
    appendChatBubble('ai',reply);
  }catch(e){
    removeChatBubble(loadingId);
    appendChatBubble('ai',`ã‚¨ãƒ©ãƒ¼: ${e.message}`);
  }finally{
    btn.disabled=false;
  }
}
function appendChatBubble(role,text,loading=false,id=null){
  const area=document.getElementById('chat-messages');
  const wrap=document.createElement('div');
  wrap.style.display='flex';
  wrap.style.flexDirection='column';
  wrap.style.alignItems=role==='user'?'flex-end':'flex-start';
  if(id)wrap.id=id;
  const sender=document.createElement('div');
  sender.className='chat-sender';
  sender.textContent=role==='user'?'You':'Grimoire';
  const bubble=document.createElement('div');
  bubble.className=`chat-bubble ${role}${loading?' loading':''}`;
  bubble.textContent=text;
  wrap.appendChild(sender);
  wrap.appendChild(bubble);
  area.appendChild(wrap);
  area.scrollTop=area.scrollHeight;
}
function removeChatBubble(id){
  const el=document.getElementById(id);
  if(el)el.remove();
}
function clearChat(){
  if(!chatHistory.length)return;
  if(!confirm('ä¼šè©±å±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ'))return;
  chatHistory=[];
  document.getElementById('chat-messages').innerHTML='';
}

// â•â• ãƒ¢ãƒ¼ãƒ€ãƒ« â•â•
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

// â•â• ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç† â•â•
function showView(name){
  ['char-list-view','char-detail-view','char-form-view','char-sheet-view'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.style.display='none';
  });
  document.getElementById(name).style.display='block';
}

function renderCharList(){
  const q=(document.getElementById('char-search')?.value||'').toLowerCase();
  const list=document.getElementById('char-list');
  const filtered=characters.filter(c=>!q||c.name?.toLowerCase().includes(q)||c.tag?.toLowerCase().includes(q));
  if(!filtered.length){list.innerHTML='<div class="empty"><div class="empty-icon">âš”</div><div class="empty-text">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';return;}
  list.innerHTML='';
  filtered.forEach(c=>{
    const roleCount=roles.filter(r=>r.charId===c.id).length;
    const card=document.createElement('div'); card.className='char-card';
    card.innerHTML=`
      <div class="char-card-header">
        <div style="flex:1;">
          <div class="char-tag">${escHtml(c.tag||'')}</div>
          <div class="char-name${c.lost?' char-name-lost':''}">${escHtml(c.name||'ï¼ˆåå‰æœªè¨­å®šï¼‰')}${c.lost?'<span class="lost-badge">æ­»äº¡</span>':''}</div>
          <div class="char-meta">${escHtml(c.race?c.race+' / ':'')}${escHtml(c.job||'')}${c.age?' Â· '+escHtml(c.age)+'æ­³':''}</div>
        </div>
        <span class="char-role-count">${roleCount}ä»¶ã®ãƒ­ãƒ¼ãƒ«</span>
        <button class="btn btn-d btn-sm" style="margin-left:0.5rem;" onclick="event.stopPropagation();openDeleteCharModal('${c.id}')">å‰Šé™¤</button>
      </div>`;
    card.onclick=()=>openCharDetail(c.id);
    list.appendChild(card);
  });
}

function openCharDetail(id){
  currentCharId=id;
  const c=characters.find(c=>c.id===id);
  if(!c)return;
  const nameEl=document.getElementById('detail-char-name');
  nameEl.textContent=c.name||'ï¼ˆåå‰æœªè¨­å®šï¼‰';
  nameEl.className='char-detail-name'+(c.lost?' char-detail-name-lost':'');
  // æ­»äº¡ãƒãƒƒã‚¸
  const existBadge=document.getElementById('detail-lost-badge');
  if(existBadge)existBadge.remove();
  if(c.lost){
    const badge=document.createElement('span');
    badge.id='detail-lost-badge';
    badge.className='lost-badge';
    badge.textContent='æ­»äº¡';
    nameEl.after(badge);
  }
  document.getElementById('detail-char-sub').textContent=[c.tag,c.race,c.job].filter(Boolean).join(' / ');
  // æ­»äº¡/è˜‡ç”Ÿãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
  const lostBtn=document.getElementById('btn-lost-char');
  if(lostBtn){
    if(c.lost){
      lostBtn.textContent='è˜‡ç”Ÿ';
      lostBtn.className='btn btn-revive btn-sm';
    } else {
      lostBtn.textContent='æ­»äº¡';
      lostBtn.className='btn btn-d btn-sm';
    }
    lostBtn.disabled=false;
    lostBtn.style.opacity='1';
  }
  showView('char-detail-view');
  renderRoles();
}

function backToCharList(){currentCharId=null;showView('char-list-view');renderCharList();}
function backToCharDetail(){showView('char-detail-view');}

function showCharCreate(){
  editingCharId=null;
  document.getElementById('char-form-title').textContent='ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆ';
  clearCharForm();
  showView('char-form-view');
}

function showCharEdit(){
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  editingCharId=currentCharId;
  document.getElementById('char-form-title').textContent='ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†';
  fillCharForm(c);
  showView('char-form-view');
}

function showCharSheet(){
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  document.getElementById('sheet-preview-text').textContent=buildSheetText(c);
  showView('char-sheet-view');
}

function cancelCharForm(){
  if(editingCharId){openCharDetail(editingCharId);}
  else{showView('char-list-view');renderCharList();}
}

function clearCharForm(){
  ['sf-tag','sf-name','sf-age','sf-height','sf-weight','sf-guild','sf-overview'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const unk=document.getElementById('sf-age-unknown');if(unk){unk.checked=false;document.getElementById('sf-age').disabled=false;}
  ['sf-sex','sf-race'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('sf-job-primary').value='';
  document.getElementById('sf-job-secondary').value='';
  updateJobDisplay();
  ['warn-age','warn-body'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent='';});
  ['weapons','armors','items','magics'].forEach(id=>document.getElementById(`sf-${id}`).innerHTML='');
}

function fillCharForm(c){
  document.getElementById('sf-tag').value=c.tag||'';
  document.getElementById('sf-name').value=c.name||'';
  document.getElementById('sf-sex').value=c.sex||'';
  const ageUnknown=c.age==='ä¸æ˜';
  const unkCb=document.getElementById('sf-age-unknown');
  if(unkCb){unkCb.checked=ageUnknown;document.getElementById('sf-age').disabled=ageUnknown;document.getElementById('sf-age').classList.toggle('locked',ageUnknown);}
  document.getElementById('sf-age').value=ageUnknown?'':c.age||'';
  document.getElementById('sf-job-primary').value=c.jobPrimary||'';
  document.getElementById('sf-job-secondary').value=c.jobSecondary||'';
  updateJobDisplay();
  checkAgeWarn();checkBodyWarn();
  document.getElementById('sf-race').value=c.race||'';
  document.getElementById('sf-height').value=c.height||'';
  document.getElementById('sf-weight').value=c.weight||'';
  document.getElementById('sf-guild').value=c.guild||'';
  document.getElementById('sf-overview').value=c.overview||'';
  ['weapons','armors','items','magics'].forEach(k=>document.getElementById(`sf-${k}`).innerHTML='');
  (c.weapons||[]).forEach(w=>addDynamicItem('weapons','æ­¦å™¨å','è©³ç´°ï¼ˆä»»æ„ï¼‰',w.name,w.detail));
  (c.armors||[]).forEach(a=>addDynamicItem('armors','é˜²å…·å','è©³ç´°ï¼ˆä»»æ„ï¼‰',a.name,a.detail));
  (c.items||[]).forEach(i=>addDynamicItem('items','ã‚¢ã‚¤ãƒ†ãƒ å','è©³ç´°ï¼ˆä»»æ„ï¼‰',i.name,i.detail));
  (c.magics||[]).forEach(m=>addMagicItem(m.name,m.category,m.detail));
}

function addDynamicItem(type,namePh,detailPh,name='',detail=''){
  const area=document.getElementById(`sf-${type}`);
  const div=document.createElement('div'); div.className='dynamic-item';
  div.innerHTML=`
    <button class="dynamic-item-del" onclick="this.parentElement.remove()">âœ•</button>
    <input type="text" placeholder="${namePh}" value="${escAttr(name)}" style="margin-bottom:0.4rem;">
    <textarea rows="3" placeholder="${detailPh}" style="font-size:0.82rem;">${escAttr(detail)}</textarea>`;
  area.appendChild(div);
}

function addMagicItem(name='',category='',detail=''){
  const area=document.getElementById('sf-magics');
  const div=document.createElement('div'); div.className='dynamic-item';
  div.innerHTML=`
    <button class="dynamic-item-del" onclick="this.parentElement.remove()">âœ•</button>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.4rem;">
      <input type="text" placeholder="é­”æ³•å" value="${escAttr(name)}">
      <input type="text" placeholder="ã€Š åˆ†é¡ï¸°å±æ€§ ã€‹" value="${escAttr(category)}">
    </div>
    <textarea rows="3" placeholder="é­”æ³•ã®è©³ç´°ãƒ»åŠ¹æœ" style="font-size:0.82rem;">${escAttr(detail)}</textarea>`;
  area.appendChild(div);
}

function getDynamicItems(type){
  return [...document.querySelectorAll(`#sf-${type} .dynamic-item`)].map(d=>{
    const inputs=d.querySelectorAll('input');
    const ta=d.querySelector('textarea');
    if(type==='magics') return{name:inputs[0].value.trim(),category:inputs[1].value.trim(),detail:ta?.value.trim()||''};
    return{name:inputs[0].value.trim(),detail:ta?.value.trim()||''};
  }).filter(i=>i.name);
}

const JOB_INITIAL={
  'Ê€Éªá´…á´‡Ê€':'R',
  'á´‡É´á´„Êœá´€É´á´›á´‡Ê€':'E','á´Ê€á´€á´„ÊŸá´‡':'O',
  'á´„á´É´á´Šá´œÊ€á´‡Ê€':'C','á´¡á´€Ê€ÊŸá´á´„á´‹':'W','sá´€É¢á´‡':'S'
};
function buildJobValue(primary, secondary){
  if(!primary)return '';
  if(!secondary)return primary;
  const initial=JOB_INITIAL[secondary]||secondary.charAt(0);
  return primary+' - '+initial;
}
function checkAgeWarn(){
  const el=document.getElementById('warn-age');if(!el)return;
  const unk=document.getElementById('sf-age-unknown');
  if(unk?.checked){el.textContent='';return;}
  const val=parseInt(document.getElementById('sf-age').value);
  el.textContent=(val&&val>400)?'è­¦å‘Šï¼šå¹´é½¢ãŒä¸Šé™ï¼ˆ400æ­³ï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™':'';
}
function onAgeUnknown(){
  const unk=document.getElementById('sf-age-unknown');
  const inp=document.getElementById('sf-age');
  if(!unk||!inp)return;
  inp.classList.toggle('locked',unk.checked);
  inp.disabled=unk.checked;
  if(unk.checked)inp.value='';
  checkAgeWarn();
}
function checkBodyWarn(){
  const el=document.getElementById('warn-body');if(!el)return;
  const h=parseFloat(document.getElementById('sf-height').value);
  const w=parseFloat(document.getElementById('sf-weight').value);
  const warns=[];
  if(h&&h>230)warns.push('èº«é•·ãŒä¸Šé™ï¼ˆ230cmï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™');
  if(w&&w>180)warns.push('ä½“é‡ãŒä¸Šé™ï¼ˆ180kgï¼‰ã‚’è¶…éã—ã¦ã„ã¾ã™');
  el.textContent=warns.length?'è­¦å‘Šï¼š'+warns.join(' / '):'';
}
function updateJobDisplay(){
  const p=document.getElementById('sf-job-primary').value;
  const s=document.getElementById('sf-job-secondary').value;
  const el=document.getElementById('sf-job-preview');
  if(!el)return;
  el.textContent=buildJobValue(p,s)||'';
}
function saveChar(){
  const name=document.getElementById('sf-name').value.trim();
  const tag=document.getElementById('sf-tag').value.trim();
  if(!name||!tag){alert('è­˜åˆ¥ã‚¿ã‚°ã¨åå‰ã¯å¿…é ˆã§ã™');return;}
  const c={
    id:editingCharId||'char_'+Date.now(),
    tag,name,
    sex:document.getElementById('sf-sex').value,
    age:(document.getElementById('sf-age-unknown').checked?'ä¸æ˜':document.getElementById('sf-age').value.trim()||''),
    jobPrimary:document.getElementById('sf-job-primary').value,
    jobSecondary:document.getElementById('sf-job-secondary').value,
    job:buildJobValue(document.getElementById('sf-job-primary').value,document.getElementById('sf-job-secondary').value),
    race:document.getElementById('sf-race').value,
    height:document.getElementById('sf-height').value.trim(),
    weight:document.getElementById('sf-weight').value.trim(),
    body:(()=>{const h=document.getElementById('sf-height').value.trim();const w=document.getElementById('sf-weight').value.trim();return [h?h+'cm':'',w?w+'kg':''].filter(Boolean).join(' / ');})(),
    guild:document.getElementById('sf-guild').value.trim(),
    overview:document.getElementById('sf-overview').value.trim(),
    weapons:getDynamicItems('weapons'),
    armors:getDynamicItems('armors'),
    items:getDynamicItems('items'),
    magics:getDynamicItems('magics'),
    createdAt:editingCharId?characters.find(c=>c.id===editingCharId)?.createdAt:Date.now()
  };
  if(editingCharId){const i=characters.findIndex(c=>c.id===editingCharId);if(i>=0)characters[i]=c;}
  else characters.push(c);
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  currentCharId=c.id;
  openCharDetail(c.id);
}

let _deleteTargetId=null;
function openLostModal(){
  if(!currentCharId)return;
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  if(c.lost){
    // è˜‡ç”Ÿãƒ¢ãƒ¼ãƒ€ãƒ«
    document.getElementById('modal-revive-title').textContent=`ã€Œ${c.name||'ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼'}ã€ã‚’è˜‡ç”Ÿã—ã¾ã™ã‹ï¼Ÿ`;
    openModal('modal-revive-char');
  } else {
    // æ­»äº¡ãƒ¢ãƒ¼ãƒ€ãƒ«
    document.getElementById('modal-lost-title').textContent=`ã€Œ${c.name||'ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼'}ã€ã‚’æ­»äº¡å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ`;
    openModal('modal-lost-char');
  }
}
function confirmLost(){
  if(!currentCharId)return;
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  c.lost=true;
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  closeModal('modal-lost-char');
  openCharDetail(currentCharId);
  renderCharList();
}
function confirmRevive(){
  if(!currentCharId)return;
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  c.lost=false;
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  closeModal('modal-revive-char');
  openCharDetail(currentCharId);
  renderCharList();
}
let _deleteFinalTimer=null;
function cancelDeleteFinal(){
  if(_deleteFinalTimer){clearTimeout(_deleteFinalTimer);_deleteFinalTimer=null;}
  closeModal('modal-delete-final');
}
function openDeleteCharModal(id){
  _deleteTargetId=id;
  const c=characters.find(c=>c.id===id);
  document.getElementById('modal-delete-title').textContent=`ã€Œ${c?.name||'ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼'}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
  openModal('modal-delete-char');
}
function openDeleteFinalModal(){
  closeModal('modal-delete-char');
  document.getElementById('delete-char-with-roles').checked=false;
  const btn=document.getElementById('btn-delete-final');
  btn.classList.remove('armed');
  btn.disabled=true;
  openModal('modal-delete-final');
  if(_deleteFinalTimer)clearTimeout(_deleteFinalTimer);
  _deleteFinalTimer=setTimeout(()=>{
    btn.disabled=false;
    btn.classList.add('armed');
  },3000);
}
function confirmDeleteChar(){
  if(!_deleteTargetId)return;
  if(_deleteFinalTimer){clearTimeout(_deleteFinalTimer);_deleteFinalTimer=null;}
  const withExport=document.getElementById('delete-char-with-roles').checked;
  characters=characters.filter(c=>c.id!==_deleteTargetId);
  roles=roles.filter(r=>r.charId!==_deleteTargetId);
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
  if(currentCharId===_deleteTargetId) currentCharId=null;
  _deleteTargetId=null;
  closeModal('modal-delete-final');
  showView('char-list-view');
  renderCharList();
  if(withExport) exportData();
}

// â•â• ã‚·ãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ â•â•
function buildSheetText(c){
  const L='â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ';
  const LL='â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”';
  let t=`${LL}\n${L}\n\n${L}\n${LL}\n\n\n`;
  t+=`   || É´ á´€ á´ á´‡ ||ã€€ã€ ${c.name||''} ã€Ÿ\n   ${L}\n   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
  t+=`|| s á´‡ x || ${c.sex||''}\n${L}\n\n`;
  t+=`|| á´€ É¢ á´‡ || ${c.age||''}\n${L}\n\n`;
  t+=`|| á´Š á´ Ê™ || ${c.job||''}\n${L}\n\n`;
  t+=`|| Ê€ á´€ á´„ á´‡ || ${c.race||''}\n${L}\n\n`;
  t+=`|| Ê™ á´ á´… Ê || ${c.body||''}\n${L}\n\n`;
  t+=`|| É¢ á´œ Éª ÊŸ á´… || ${c.guild||'âˆ’âˆ’âˆ’âˆ’'}\n${L.repeat(1)}â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ\n\n`;
  t+=`${L}â”ˆâ”ˆâ”ˆâ”ˆ\n\n${c.overview||''}\n\n${L}â”ˆâ”ˆâ”ˆâ”ˆ\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n\n`;
  if(c.weapons?.length){
    t+=`|| á´¡ á´‡ á´€ á´˜ á´ É´ ||\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
    c.weapons.forEach(w=>{t+=`âã€ ${w.name} ã€\n${L}\n${w.detail||''}\n${L}\n\n`;});
  }
  if(c.armors?.length){
    t+=`|| á´€ Ê€ á´ á´ Ê€ ||\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
    c.armors.forEach(a=>{t+=`âã€ ${a.name} ã€\n${L}\n${a.detail||''}\n${L}\n\n`;});
  }
  if(c.items?.length){
    t+=`|| Éª á´› á´‡ á´ ||\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
    c.items.forEach(i=>{t+=`âã€ ${i.name} ã€\n${L}\n${i.detail||''}\n${L}\n\n`;});
  }
  if(c.magics?.length){
    t+=`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n|| á´ á´€ É¢ Éª á´„ ||\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
    c.magics.forEach(m=>{t+=`âã€ ${m.name} ã€${m.category?'ã€Š '+m.category+' ã€‹':''}\n${L}\n${m.detail||''}\n${L}\n\n`;});
  }
  t+=`${LL}`;
  return t;
}

function copySheet(){
  const text=document.getElementById('sheet-preview-text').textContent;
  navigator.clipboard.writeText(text).then(()=>{
    const btn=document.querySelector('#char-sheet-view .btn-p');
    const o=btn.textContent; btn.textContent='âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆ'; setTimeout(()=>btn.textContent=o,1500);
  });
}

// â•â• ãƒ­ãƒ¼ãƒ«ç®¡ç† â•â•
function renderRoles(){
  if(!currentCharId)return;
  const q=(document.getElementById('role-search')?.value||'').toLowerCase();
  const filter=document.getElementById('role-filter-type')?.value||'';
  const list=document.getElementById('role-list');
  let filtered=roles.filter(r=>{
    if(r.charId!==currentCharId)return false;
    if(filter&&r.type!==filter)return false;
    if(q&&!r.body.toLowerCase().includes(q)&&!r.session?.toLowerCase().includes(q)&&!(r.tags||[]).some(t=>t.toLowerCase().includes(q)))return false;
    return true;
  }).sort((a,b)=>b.createdAt-a.createdAt);
  list.innerHTML=filtered.length?filtered.map(r=>roleCardHTML(r)).join(''):'<div class="empty"><div class="empty-icon">ğŸ“œ</div><div class="empty-text">ãƒ­ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
  if(filtered.length) filtered.forEach(r=>{const c=document.getElementById(`rc-${r.id}`);if(c)c.onclick=()=>toggleRoleDetail(r.id);});
  const sessions=[...new Set(roles.filter(r=>r.charId===currentCharId).map(r=>r.session).filter(Boolean))];
  const sdl=document.getElementById('session-datalist'); sdl.innerHTML=sessions.map(s=>`<option value="${escAttr(s)}">`).join('');
  const sl=document.getElementById('session-list'); sl.innerHTML=sessions.slice(0,10).map(s=>`<span class="tag-chip" style="cursor:pointer;" onclick="filterSession('${escAttr(s)}')">${escHtml(s)}</span>`).join('');
}

function roleCardHTML(r){
  const date=new Date(r.createdAt).toLocaleDateString('ja-JP');
  const tags=r.tags?.length?`<div class="role-tags">${r.tags.map(t=>`<span class="tag-chip">${escHtml(t)}</span>`).join('')}</div>`:'';
  return `<div class="role-card" id="rc-${r.id}"><div class="role-card-header"><span class="role-type-badge ${r.type==='opp'?'badge-opp':'badge-self'}">${r.type==='opp'?'ç›¸æ‰‹':'è‡ªåˆ†'}</span><span class="role-session">${escHtml(r.session||'ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³åãªã—ï¼‰')}</span><span class="role-date">${date}</span></div><div class="role-preview">${escHtml(r.body)}</div>${tags}</div>`;
}

function toggleRoleDetail(id){
  const ex=document.getElementById(`detail-${id}`);
  if(ex){ex.remove();document.getElementById(`rc-${id}`)?.classList.remove('selected');return;}
  document.getElementById(`rc-${id}`)?.classList.add('selected');
  const r=roles.find(r=>r.id===id); if(!r)return;
  const d=document.createElement('div'); d.className='detail-view'; d.id=`detail-${id}`;
  d.innerHTML=`<div class="detail-header"><span class="role-type-badge ${r.type==='opp'?'badge-opp':'badge-self'}">${r.type==='opp'?'ç›¸æ‰‹ã®ãƒ­ãƒ¼ãƒ«':'è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«'}</span><span style="font-size:0.75rem;color:var(--ink-dim);">${escHtml(r.session||'')}</span><button class="btn btn-d btn-sm" style="margin-left:auto;" onclick="deleteRole('${id}')">å‰Šé™¤</button></div><div class="detail-body">${escHtml(r.body)}</div>${r.memo?`<div class="detail-analysis"><div class="detail-analysis-label">ãƒ¡ãƒ¢</div><div class="detail-analysis-text">${escHtml(r.memo)}</div></div>`:''}${r.analysis?`<div class="detail-analysis"><div class="detail-analysis-label">åˆ†æçµæœ</div><div class="detail-analysis-text">${escHtml(r.analysis)}</div></div>`:''}`;
  document.getElementById(`rc-${id}`).after(d);
}

function filterSession(s){document.getElementById('role-search').value=s;renderRoles();}

function saveRole(){
  if(!currentCharId){alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const body=document.getElementById('nr-body').value.trim();
  if(!body){alert('ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const tagsRaw=document.getElementById('nr-tags').value.trim();
  roles.push({id:'r_'+Date.now(),charId:currentCharId,type:document.getElementById('nr-type').value,session:document.getElementById('nr-session').value.trim(),body,memo:document.getElementById('nr-memo').value.trim(),tags:tagsRaw?tagsRaw.split(',').map(t=>t.trim()).filter(Boolean):[],createdAt:Date.now()});
  localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
  closeModal('modal-new-role');
  ['nr-session','nr-body','nr-memo','nr-tags'].forEach(id=>document.getElementById(id).value='');
  renderRoles();
}

function deleteRole(id){
  if(!confirm('ã“ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  roles=roles.filter(r=>r.id!==id); localStorage.setItem(KEY_ROLES,JSON.stringify(roles)); renderRoles();
}

// â•â• ãƒ‡ãƒ¼ã‚¿ç®¡ç† â•â•
function copyApiKey(){
  if(!apiKey){alert('APIã‚­ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');return;}
  navigator.clipboard.writeText(apiKey).then(()=>{
    const btn=document.querySelector('#options-page .btn-g');
    if(btn){const o=btn.textContent;btn.textContent='âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆ';setTimeout(()=>btn.textContent=o,1500);}
  });
}
function onExportApiKeyToggle(){
  options.exportApiKey=document.getElementById('opt-export-apikey').checked;
  saveOptions();
  document.getElementById('apikey-export-warning').style.display=options.exportApiKey?'block':'none';
}
function exportData(){
  const data={exportedAt:new Date().toISOString(),characters,roles};
  if(options.exportApiKey&&apiKey) data.apiKey=apiKey;
  downloadJSON(data,`grimoire_data_${Date.now()}.json`);
}
function importData(){
  const input=document.getElementById('import-file');
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!confirm('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨çµ±åˆã—ã¾ã™ã‹ï¼Ÿ'))return;
        if(data.characters){const ex=new Set(characters.map(c=>c.id)); data.characters.forEach(c=>{if(!ex.has(c.id))characters.push(c);});}
        if(data.roles){const ex=new Set(roles.map(r=>r.id)); data.roles.forEach(r=>{if(!ex.has(r.id))roles.push(r);});}
        if(data.apiKey&&!apiKey){
          if(confirm('ãƒ•ã‚¡ã‚¤ãƒ«ã«APIã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')){
            apiKey=data.apiKey; localStorage.setItem(KEY_API,apiKey); unlockAnalyze();
          }
        }
        localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
        localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
        renderCharList();
        closeOptions();
        alert('èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ');
      }catch{alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    reader.readAsText(file); input.value='';
  };
  input.click();
}
function clearAllData(){
  if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿå–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'))return;
  if(!confirm('æœ¬å½“ã«æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ'))return;
  characters=[]; roles=[];
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters)); localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
  renderCharList();
}

// â•â• ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– â•â•
function renderDB(){
  const q=(document.getElementById('db-search')?.value||'').toLowerCase();
  const catId=document.getElementById('db-cat-filter')?.value||'';
  const area=document.getElementById('db-content'), noLoad=document.getElementById('db-not-loaded');
  if(!worldDB){noLoad.style.display='block';area.innerHTML='';return;}
  noLoad.style.display='none';
  let entries=worldDB.entries||[];
  if(catId)entries=entries.filter(e=>e.catId===catId);
  if(q)entries=entries.filter(e=>e.title?.toLowerCase().includes(q)||e.body?.toLowerCase().includes(q)||(e.tags||[]).some(t=>t.toLowerCase().includes(q)));
  if(!entries.length){area.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“š</div><div class="empty-text">è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>';return;}
  area.innerHTML='';
  entries.forEach(entry=>{
    const cat=(worldDB.categories||[]).find(c=>c.id===entry.catId);
    const card=document.createElement('div'); card.className='db-entry-card';
    card.innerHTML=`<div class="db-entry-title">${escHtml(entry.title)}</div><div class="db-entry-meta">${cat?escHtml(`${cat.icon||'ğŸ“„'} ${cat.name}`):'æœªåˆ†é¡'}</div><div class="db-entry-body" id="dbeb-${entry.id}">${escHtml(entry.body)}</div>`;
    card.onclick=()=>document.getElementById(`dbeb-${entry.id}`).classList.toggle('open');
    area.appendChild(card);
  });
}
function populateDBCatFilter(){
  const sel=document.getElementById('db-cat-filter'); sel.innerHTML='<option value="">ã™ã¹ã¦</option>';
  (worldDB?.categories||[]).forEach(cat=>{const o=document.createElement('option');o.value=cat.id;o.textContent=`${cat.icon||'ğŸ“„'} ${cat.name}`;sel.appendChild(o);});
}
function loadDB(){
  const input=document.getElementById('db-file');
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.categories||!data.entries){alert('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');return;}
        worldDB=data; localStorage.setItem(KEY_DB,JSON.stringify(worldDB));
        populateDBCatFilter(); renderDB(); updateDBInfo();
        closeOptions();
        alert(`${worldDB.name||'DB'} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆè¨˜äº‹${worldDB.entries.length}ä»¶ï¼‰`);
      }catch{alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    reader.readAsText(file); input.value='';
  };
  input.click();
}
function updateDBInfo(){const el=document.getElementById('db-current-info');if(!el)return;el.textContent=worldDB?`èª­è¾¼ä¸­: ${worldDB.name||'ï¼ˆåå‰ãªã—ï¼‰'} v${worldDB.version||'â€”'} Â· è¨˜äº‹${worldDB.entries?.length||0}ä»¶`:'èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“';}

// â•â• ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ â•â•
const KEY_ANN_READ = 'gm_announce_read'; // æ—¢èª­ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆæœ€çµ‚æ—¢èª­ã®createdAt or cachedAtï¼‰

async function fetchAnnounce(){
  const cache=localStorage.getItem(KEY_ANN);
  if(cache){try{announces=(JSON.parse(cache).announcements||[]);renderArchiveArea(false);}catch{}}
  if(!GIST_URL){renderArchiveArea(false);return;}
  try{
    const res=await fetch(GIST_URL+'?_='+Date.now());
    if(!res.ok)throw new Error();
    const data=await res.json();
    announces=data.announcements||[];
    localStorage.setItem(KEY_ANN,JSON.stringify({...data,cachedAt:Date.now()}));
    renderArchiveArea(false);
  }catch{renderArchiveArea(!cache);}
}

// æœªèª­ã‚«ã‚¦ãƒ³ãƒˆï¼šæ—¢èª­ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚ˆã‚Šæ–°ã—ã„createdAtã‚’æŒã¤ä»¶æ•°
function annUnreadCount(){
  const lastRead=parseInt(localStorage.getItem(KEY_ANN_READ)||'0');
  return announces.filter(a=>(a.createdAt||0)>lastRead).length;
}
function annMarkRead(){
  if(!announces.length)return;
  const latest=Math.max(...announces.map(a=>a.createdAt||0));
  localStorage.setItem(KEY_ANN_READ,String(latest));
}

// ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒšãƒ¼ã‚¸ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚¨ãƒªã‚¢ã‚’æç”»
function renderArchiveArea(offline=false){
  const area=document.getElementById('archive-announce-area');
  if(!area)return;

  if(offline){
    area.innerHTML='<div class="ann-status">ğŸ“¡ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™</div>';
    return;
  }

  if(!announces.length){
    area.innerHTML='<div class="ann-status">â€” ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ â€”</div>';
    return;
  }

  const unread=annUnreadCount();
  const pinned=announces.find(a=>a.pinned)||announces[0];
  const isUrgent=pinned.level==='urgent';

  // æ–°ç€ãƒãƒŠãƒ¼
  const bannerHtml=unread>0?`
  <div class="ann-banner${isUrgent?' urgent':''}" onclick="openAnnounceModal()">
    <div class="ann-banner-bg"></div>
    <div class="ann-banner-border"></div>
    <div class="ann-banner-inner">
      <div class="ann-banner-eyebrow">
        <span class="ann-badge-new">NEW</span>
        Announcement
        <span class="ann-banner-unread">${unread}ä»¶ã®æ–°ç€</span>
      </div>
      <div class="ann-banner-title">${escHtml(pinned.title)}</div>
      <div class="ann-banner-meta">${escHtml(pinned.date||'')}</div>
      <span class="ann-banner-more">ã™ã¹ã¦è¦‹ã‚‹ â–¶</span>
    </div>
  </div>`:'';

  // ã‚«ãƒ¼ãƒ‰ä¸€è¦§
  const cardsHtml=announces.map((a,i)=>`
    <div class="archive-announce-card ${a.level||'normal'}">
      <div class="archive-announce-card-header" onclick="toggleArchiveAnnounce(${i})">
        <div class="archive-announce-card-dot"></div>
        <span class="archive-announce-card-title">${escHtml(a.title)}</span>
        <span class="archive-announce-card-date">${escHtml(a.date||'')}</span>
        <span class="archive-announce-card-arrow" id="aaa-arrow-${i}">â–¶</span>
      </div>
      <div class="archive-announce-card-body" id="aaa-body-${i}">${escHtml(a.body||'')}</div>
    </div>`).join('');

  area.innerHTML=bannerHtml+cardsHtml;
}

function toggleArchiveAnnounce(i){
  document.getElementById(`aaa-body-${i}`).classList.toggle('open');
  document.getElementById(`aaa-arrow-${i}`).classList.toggle('open');
}

function openAnnounceModal(){
  annMarkRead();
  renderArchiveArea(false); // NEW ãƒãƒƒã‚¸ã‚’æ¶ˆã™
  const mc=document.getElementById('announce-modal-content');
  mc.innerHTML=announces.map(a=>`<div class="announce-modal-item"><div class="announce-modal-header"><span class="announce-modal-title">${escHtml(a.title)}</span><span class="level-badge level-${a.level||'normal'}">${{normal:'é€šå¸¸',important:'é‡è¦',urgent:'ç·Šæ€¥'}[a.level]||'é€šå¸¸'}</span><span class="announce-modal-date">${escHtml(a.date||'')}</span></div><div class="announce-modal-body">${escHtml(a.body||'')}</div></div>`).join('');
  openModal('modal-announce');
}

// â•â• åˆ†æ â•â•
async function registerApiKey(){
  const key=document.getElementById('api-key-input').value.trim();
  if(!key.startsWith('sk-')){alert('æ­£ã—ã„APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆsk- ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ï¼‰');return;}
  const btn=document.querySelector('#modal-api-setup .btn-p');
  const orig=btn.textContent; btn.textContent='ç¢ºèªä¸­â€¦'; btn.disabled=true;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01'},
      body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:1,messages:[{role:'user',content:'hi'}]})
    });
    if(res.status===401){alert('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');return;}
    if(res.status===403){alert('ã“ã®APIã‚­ãƒ¼ã«ã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');return;}
    // 200ã¾ãŸã¯ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç–é€šã§ãã¦ã„ã‚Œã°æœ‰åŠ¹ã¨ã¿ãªã™ï¼ˆ429=åˆ¶é™ã€500=ã‚µãƒ¼ãƒãƒ¼ç­‰ï¼‰
    if(res.status===200||res.status===429||res.status>=500){
      apiKey=key;localStorage.setItem(KEY_API,apiKey);
      closeModal('modal-api-setup');unlockAnalyze();
      alert('APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚åˆ†ææ©Ÿèƒ½ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸã€‚');
    } else {
      const e=await res.json().catch(()=>{});
      alert(`APIã‚­ãƒ¼ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${res.status}ï¼‰: ${e?.error?.message||''}`);
    }
  }catch(e){
    alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }finally{
    btn.textContent=orig; btn.disabled=false;
  }
}
function unlockAnalyze(){document.getElementById('analyze-locked').style.display='none';document.getElementById('analyze-unlocked').style.display='block';}
function buildAnalyzeCats(prefix){const area=document.getElementById(`${prefix}-cats`);DEFAULT_CATS.forEach(cat=>{const btn=document.createElement('button');btn.className='btn btn-g btn-sm';btn.textContent=cat;btn.onclick=()=>{if(checkedCats[prefix].has(cat)){checkedCats[prefix].delete(cat);btn.style.borderColor='';btn.style.color='';}else{checkedCats[prefix].add(cat);btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';}};area.appendChild(btn);});}
function buildAssistModes(){const area=document.getElementById('assist-modes');ASSIST_MODES.forEach(m=>{const btn=document.createElement('button');btn.className='btn btn-g btn-sm';btn.textContent=m.name;btn.onclick=()=>{if(checkedModes.has(m.id)){checkedModes.delete(m.id);btn.style.borderColor='';btn.style.color='';}else{checkedModes.add(m.id);btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';}};area.appendChild(btn);});}

async function doAnalyze(mode){
  if(!apiKey){openModal('modal-api-setup');return;}
  const btn=document.getElementById(`${mode==='assist'?'assist':mode}-btn`), result=document.getElementById(`${mode==='assist'?'assist':mode}-result`);
  const prompt=buildAnalyzePrompt(mode); if(!prompt){alert('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  btn.disabled=true; result.innerHTML=`<div style="padding:1.2rem;color:var(--ink-dim);font-size:0.8rem;">è§£æä¸­â€¦</div>`;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})});
    if(!res.ok){const e=await res.json().catch(()=>{});throw new Error(e?.error?.message||`HTTP ${res.status}`);}
    const data=await res.json(), text=data.content?.map(c=>c.text||'').join('')||'ï¼ˆå¿œç­”ãªã—ï¼‰';
    result.innerHTML=`<div class="detail-analysis" style="margin-top:1rem;"><div class="detail-analysis-label">è§£æçµæœ</div><div class="detail-analysis-text" id="ar-${mode}">${escHtml(text)}</div><div class="btn-row" style="margin-top:0.8rem;"><button class="btn btn-g btn-sm" onclick="copyText('ar-${mode}')">ã‚³ãƒ”ãƒ¼</button></div></div>`;
  }catch(e){result.innerHTML=`<div style="color:#c87070;font-size:0.78rem;margin-top:0.8rem;padding:0.8rem;border:1px solid rgba(139,32,32,0.3);border-radius:2px;">ã‚¨ãƒ©ãƒ¼: ${escHtml(e.message)}</div>`;if(e.message.includes('401')){apiKey='';localStorage.removeItem(KEY_API);document.getElementById('analyze-locked').style.display='block';document.getElementById('analyze-unlocked').style.display='none';}}
  finally{btn.disabled=false;}
}

function buildAnalyzePrompt(mode){
  if(mode==='opp'){const text=document.getElementById('opp-text').value.trim();if(!text)return null;const supp=document.getElementById('opp-supp').value.trim(),cats=[...checkedCats.opp];let p='ã‚ãªãŸã¯ä¸­ä¸–ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¸–ç•Œè¦³åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ­ãƒ¼ãƒ«æ–‡ã‚’ã€æŒ‡å®šã•ã‚ŒãŸåˆ†æã‚«ãƒ†ã‚´ãƒªã®è¦³ç‚¹ã‹ã‚‰è©³ç´°ã«åˆ†æã—ã¦ãã ã•ã„ã€‚\n\n';if(supp)p+=`ã€ä¸–ç•Œè¦³ãƒ»è¨­å®šè£œè¶³ã€‘\n${supp}\n\n`;p+=`ã€ç›¸æ‰‹ã®ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã€‘\n${text}\n\n`;if(cats.length)p+=`ã€åˆ†æã‚«ãƒ†ã‚´ãƒªã€‘\n${cats.join('ã€')}\n\n`;p+='å„ã‚«ãƒ†ã‚´ãƒªã«ã¤ã„ã¦ã€ãƒ­ãƒ¼ãƒ«æ–‡ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æƒ…å ±ãƒ»å«æ„ãƒ»ä¸–ç•Œè¦³çš„æ•´åˆæ€§ãƒ»æ³¨ç›®ã™ã¹ãè¦ç´ ã‚’é‹­ãåˆ†æã—ã¦ãã ã•ã„ã€‚';return p;}
  if(mode==='self'){const text=document.getElementById('self-text').value.trim();if(!text)return null;const supp=document.getElementById('self-supp').value.trim(),cats=[...checkedCats.self];let p='ã‚ãªãŸã¯ä¸­ä¸–ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¸–ç•Œè¦³åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«æ–‡ã‚’å„ã‚«ãƒ†ã‚´ãƒªã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã€å¼·ã¿ã¨èª²é¡Œã‚’å…¬å¹³ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚ãŠã¹ã£ã‹ã¯ä¸è¦ã§ã™ã€‚\n\n';if(supp)p+=`ã€ä¸–ç•Œè¦³ãƒ»è¨­å®šè£œè¶³ã€‘\n${supp}\n\n`;p+=`ã€è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«æœ¬æ–‡ã€‘\n${text}\n\n`;if(cats.length)p+=`ã€åˆ†æã‚«ãƒ†ã‚´ãƒªã€‘\n${cats.join('ã€')}\n\n`;p+='å„ã‚«ãƒ†ã‚´ãƒªã«ã¤ã„ã¦ã€ä¸–ç•Œè¦³çš„ãªç²¾åº¦ãƒ»è¡¨ç¾ã®è³ªãƒ»æ”¹å–„ã®ä½™åœ°ã‚’å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚';return p;}
  const ctx=document.getElementById('assist-ctx').value.trim();if(!ctx)return null;const chara=document.getElementById('assist-chara').value.trim(),modes=[...checkedModes].map(id=>ASSIST_MODES.find(m=>m.id===id)?.name).filter(Boolean);let p='ã‚ãªãŸã¯ä¸­ä¸–ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ãƒ­ãƒ¼ãƒ«ä½œæˆè£œåŠ©ã®å°‚é–€å®¶ã§ã™ã€‚\n\n';if(chara)p+=`ã€è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã€‘\n${chara}\n\n`;p+=`ã€ç¾åœ¨ã®çŠ¶æ³ãƒ»æ–‡è„ˆã€‘\n${ctx}\n\n`;if(modes.length)p+=`ã€è£œåŠ©ãƒ¢ãƒ¼ãƒ‰ã€‘\n${modes.join('ã€')}\n\n`;p+='å„ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸææ¡ˆãƒ»è‰æ¡ˆã‚’ä¸–ç•Œè¦³ã¨æ•´åˆçš„ãªè¡¨ç¾ã§å…·ä½“çš„ã«æç¤ºã—ã¦ãã ã•ã„ã€‚';return p;
}

// â•â• ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â•â•
function downloadJSON(obj,name){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);}
function copyText(id){const el=document.getElementById(id);if(!el)return;navigator.clipboard.writeText(el.textContent).then(()=>{const b=el.parentElement?.querySelector('button');if(b){const o=b.textContent;b.textContent='âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆ';setTimeout(()=>b.textContent=o,1500);}});}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escAttr(s){return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚«ãƒãƒ³ãƒãƒƒãƒ—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bagOpen=false;
function toggleBag(){
  bagOpen=!bagOpen;
  document.getElementById('bag-btn').classList.toggle('open',bagOpen);
  document.getElementById('bag-menu').classList.toggle('open',bagOpen);
}
function openBagTool(tool){
  bagOpen=false;
  document.getElementById('bag-btn').classList.remove('open');
  document.getElementById('bag-menu').classList.remove('open');
  openModal(`modal-${tool}`);
  if(tool==='memo') initMemoFlat();
  if(tool==='mind'||tool==='memo') setTimeout(initMindmap,50);
}

// â”€â”€ é›»å“ â”€â”€
let calcBuf='0', calcPrev='', calcOperator='', calcNewNum=true;
function calcDisplay(){document.getElementById('calc-val').textContent=calcBuf;}
function calcNum(n){
  if(calcNewNum){calcBuf=n;calcNewNum=false;}
  else calcBuf=calcBuf==='0'?n:calcBuf+n;
  calcDisplay();
}
function calcDot(){
  if(calcNewNum){calcBuf='0.';calcNewNum=false;}
  else if(!calcBuf.includes('.'))calcBuf+='.';
  calcDisplay();
}
function calcOp(op){
  if(calcOperator&&!calcNewNum)calcEqual();
  calcPrev=calcBuf;calcOperator=op;calcNewNum=true;
  const sym={'+':'ï¼‹','-':'âˆ’','*':'Ã—','/':'Ã·'};
  document.getElementById('calc-expr').textContent=`${calcPrev} ${sym[op]||op}`;
}
function calcEqual(){
  if(!calcOperator)return;
  const a=parseFloat(calcPrev),b=parseFloat(calcBuf);
  let r;
  if(calcOperator==='+')r=a+b;
  else if(calcOperator==='-')r=a-b;
  else if(calcOperator==='*')r=a*b;
  else if(calcOperator==='/')r=b!==0?a/b:'Error';
  const sym={'+':'ï¼‹','-':'âˆ’','*':'Ã—','/':'Ã·'};
  document.getElementById('calc-expr').textContent=`${calcPrev} ${sym[calcOperator]||calcOperator} ${calcBuf} =`;
  calcBuf=r==='Error'?'Error':String(parseFloat(r.toFixed(10)));
  calcOperator='';calcNewNum=true;calcDisplay();
}
function calcClear(){calcBuf='0';calcPrev='';calcOperator='';calcNewNum=true;document.getElementById('calc-expr').textContent='';calcDisplay();}
function calcBack(){
  if(calcNewNum)return;
  calcBuf=calcBuf.length>1?calcBuf.slice(0,-1):'0';
  if(calcBuf==='-')calcBuf='0';
  calcDisplay();
}

let mmFullscreen=false;
function mmToggleFullscreen(){
  mmFullscreen=!mmFullscreen;
  const modal=document.querySelector('#modal-memo .bag-modal');
  const canvas=document.getElementById('mindmap-canvas');
  const overlay=document.getElementById('modal-memo');
  if(mmFullscreen){
    modal.style.maxWidth='100vw';
    modal.style.maxHeight='100vh';
    modal.style.width='100vw';
    modal.style.height='100vh';
    modal.style.borderRadius='0';
    overlay.style.padding='0';
    canvas.style.height='calc(100vh - 120px)';
  } else {
    modal.style.maxWidth='520px';
    modal.style.maxHeight='85vh';
    modal.style.width='100%';
    modal.style.height='';
    modal.style.borderRadius='';
    overlay.style.padding='1rem';
    canvas.style.height='340px';
  }
  setTimeout(()=>{resizeMmCanvas();renderMindmap();},50);
}
function calcPercent(){calcBuf=String(parseFloat(calcBuf)/100);calcDisplay();}

// â”€â”€ ãƒ¡ãƒ¢å¸³ â”€â”€
const MEMO_KEY='gm_memo_flat';
function initMemoFlat(){
  const saved=localStorage.getItem(MEMO_KEY)||'';
  document.getElementById('memo-flat-text').value=saved;
  document.getElementById('memo-flat-text').oninput=()=>localStorage.setItem(MEMO_KEY,document.getElementById('memo-flat-text').value);
}
function switchMemoTab(tab){
  document.getElementById('memo-flat-panel').style.display=tab==='flat'?'block':'none';
  document.getElementById('memo-mind-panel').style.display=tab==='mind'?'block':'none';
  document.getElementById('memo-tab-flat').classList.toggle('active',tab==='flat');
  document.getElementById('memo-tab-mind').classList.toggle('active',tab==='mind');
  if(tab==='mind')setTimeout(()=>{initMindmap();renderMindmap();},50);
}
function clearFlatMemo(){if(confirm('ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){document.getElementById('memo-flat-text').value='';localStorage.removeItem(MEMO_KEY);}}
function copyFlatMemo(){navigator.clipboard.writeText(document.getElementById('memo-flat-text').value).then(()=>{const b=document.querySelector('#memo-flat-panel .btn-g:last-child');const o=b.textContent;b.textContent='âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆ';setTimeout(()=>b.textContent=o,1500);});}

// â”€â”€ ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ— â”€â”€
const MM_KEY='gm_mindmap';
let mmNodes=[],mmEdges=[],mmSelectedId=null,mmNextId=1;
let mmCanvas=null,mmCtx=null,mmDragging=null,mmDragOX=0,mmDragOY=0;

function initMindmap(){
  mmCanvas=document.getElementById('mindmap-canvas');
  if(!mmCanvas)return;
  const saved=localStorage.getItem(MM_KEY);
  if(saved){try{const d=JSON.parse(saved);mmNodes=d.nodes||[];mmEdges=d.edges||[];mmNextId=d.nextId||mmNodes.length+1;}catch{mmNodes=[];mmEdges=[];}}
  if(!mmNodes.length){mmNodes=[{id:1,x:mmCanvas.offsetWidth/2||160,y:120,text:'ä¸­å¿ƒ',root:true}];mmNextId=2;}
  resizeMmCanvas();
  mmCanvas.onmousedown=mmCanvas.ontouchstart=mmPointerDown;
  mmCanvas.onmousemove=mmCanvas.ontouchmove=mmPointerMove;
  mmCanvas.onmouseup=mmCanvas.ontouchend=mmPointerUp;
  window.addEventListener('resize',resizeMmCanvas);
  renderMindmap();
}
function resizeMmCanvas(){
  if(!mmCanvas)return;
  mmCanvas.width=mmCanvas.offsetWidth;
  mmCanvas.height=mmCanvas.offsetHeight||340;
  renderMindmap();
}
function saveMindmap(){localStorage.setItem(MM_KEY,JSON.stringify({nodes:mmNodes,edges:mmEdges,nextId:mmNextId}));}
function renderMindmap(){
  if(!mmCanvas||!mmCtx){mmCtx=mmCanvas?.getContext('2d');if(!mmCtx)return;}
  const c=mmCtx,w=mmCanvas.width,h=mmCanvas.height;
  c.clearRect(0,0,w,h);
  // ã‚¨ãƒƒã‚¸
  mmEdges.forEach(e=>{
    const a=mmNodes.find(n=>n.id===e.from),b=mmNodes.find(n=>n.id===e.to);
    if(!a||!b)return;
    c.beginPath();c.moveTo(a.x,a.y);c.lineTo(b.x,b.y);
    c.strokeStyle='rgba(184,115,51,0.4)';c.lineWidth=1.5;c.stroke();
  });
  // ãƒãƒ¼ãƒ‰
  mmNodes.forEach(n=>{
    const r=n.root?42:34,sel=n.id===mmSelectedId;
    c.beginPath();c.ellipse(n.x,n.y,r,20,0,0,Math.PI*2);
    c.fillStyle=n.root?'rgba(184,115,51,0.2)':sel?'rgba(184,115,51,0.15)':'rgba(28,24,20,0.85)';
    c.fill();
    c.strokeStyle=sel?'rgba(184,115,51,0.9)':n.root?'rgba(184,115,51,0.6)':'rgba(184,115,51,0.3)';
    c.lineWidth=sel?2:1;c.stroke();
    c.fillStyle=n.root?'#c8b89a':'#a89880';
    c.font=`${n.root?'600 ':' '}${n.root?13:11}px Noto Serif JP,serif`;
    c.textAlign='center';c.textBaseline='middle';
    c.fillText(n.text.length>8?n.text.slice(0,8)+'â€¦':n.text,n.x,n.y);
  });
}
function mmGetNode(x,y){return mmNodes.slice().reverse().find(n=>{const dx=n.x-x,dy=n.y-y,r=n.root?42:34;return dx*dx/(r*r)+dy*dy/400<=1;});}
function mmPointerDown(e){
  e.preventDefault();
  const rect=mmCanvas.getBoundingClientRect();
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  const x=cx-rect.left,y=cy-rect.top;
  const n=mmGetNode(x,y);
  if(n){mmSelectedId=n.id;mmDragging=n;mmDragOX=x-n.x;mmDragOY=y-n.y;}
  else mmSelectedId=null;
  renderMindmap();
}
function mmPointerMove(e){
  if(!mmDragging)return;
  e.preventDefault();
  const rect=mmCanvas.getBoundingClientRect();
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  mmDragging.x=cx-rect.left-mmDragOX;
  mmDragging.y=cy-rect.top-mmDragOY;
  renderMindmap();
}
function mmPointerUp(){if(mmDragging){saveMindmap();}mmDragging=null;}
function mmAddChild(){
  if(!mmSelectedId){alert('ãƒãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const parent=mmNodes.find(n=>n.id===mmSelectedId);
  const text=prompt('ãƒãƒ¼ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆ','');
  if(!text)return;
  const angle=Math.random()*Math.PI*2;
  const dist=100+Math.random()*40;
  const newNode={id:mmNextId++,x:parent.x+Math.cos(angle)*dist,y:parent.y+Math.sin(angle)*dist,text};
  mmNodes.push(newNode);
  mmEdges.push({from:parent.id,to:newNode.id});
  mmSelectedId=newNode.id;
  saveMindmap();renderMindmap();
}
function mmDeleteNode(){
  if(!mmSelectedId)return;
  const n=mmNodes.find(n=>n.id===mmSelectedId);
  if(n?.root){alert('ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');return;}
  if(!confirm('ã“ã®ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  mmNodes=mmNodes.filter(n=>n.id!==mmSelectedId);
  mmEdges=mmEdges.filter(e=>e.from!==mmSelectedId&&e.to!==mmSelectedId);
  mmSelectedId=null;saveMindmap();renderMindmap();
}
function mmEditNode(){
  if(!mmSelectedId){alert('ãƒãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const n=mmNodes.find(n=>n.id===mmSelectedId);
  const text=prompt('ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†',n.text);
  if(text===null)return;
  n.text=text||n.text;saveMindmap();renderMindmap();
}
function mmClear(){
  if(!confirm('ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ'))return;
  mmNodes=[{id:1,x:mmCanvas.width/2,y:120,text:'ä¸­å¿ƒ',root:true}];
  mmEdges=[];mmNextId=2;mmSelectedId=null;saveMindmap();renderMindmap();
}

// â”€â”€ ãƒ€ã‚¤ã‚¹ â”€â”€
const KEY_DICE_ANIM='gm_dice_anim';
let diceAnimMode=localStorage.getItem(KEY_DICE_ANIM)||'shake';
let diceHistory=[];

function setDiceAnim(mode){
  diceAnimMode=mode;
  localStorage.setItem(KEY_DICE_ANIM,mode);
  const labels={shake:'ã‚·ã‚§ã‚¤ã‚¯',spin:'ã‚¹ãƒ”ãƒ³',off:'OFF'};
  document.getElementById('dice-anim-current').textContent=labels[mode]||mode;
  ['shake','spin','off'].forEach(m=>{
    const btn=document.getElementById(`dice-anim-${m}`);
    if(btn)btn.className=`btn btn-sm ${m===mode?'btn-p':'btn-g'}`;
  });
}

function rollDice(faces){
  if(isNaN(faces)||faces<2){alert('æ­£ã—ã„é¢æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const result=Math.floor(Math.random()*faces)+1;
  const el=document.getElementById('dice-result');

  // ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  const clickedBtn=event?.currentTarget;
  if(clickedBtn&&diceAnimMode!=='off'){
    const icon=clickedBtn.querySelector('.dice-icon');
    if(icon){
      icon.classList.remove(`dice-icon-anim-${diceAnimMode}`);
      void icon.offsetWidth;
      icon.classList.add(`dice-icon-anim-${diceAnimMode}`);
      setTimeout(()=>icon.classList.remove(`dice-icon-anim-${diceAnimMode}`),800);
    }
  }

  // çµæœã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  el.classList.remove('dice-result-roll-shake','dice-result-roll-spin','dice-result-roll-off');
  void el.offsetWidth;
  if(diceAnimMode==='shake'){
    el.classList.add('dice-result-roll-shake');
  } else if(diceAnimMode==='spin'){
    // ã‚¹ãƒ”ãƒ³ä¸­ã¯æ•°å­—ã‚’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
    let count=0;
    const total=20;
    const interval=setInterval(()=>{
      el.textContent=Math.floor(Math.random()*faces)+1;
      count++;
      if(count>=total){clearInterval(interval);el.textContent=result;}
    },55);
    el.classList.add('dice-result-roll-spin');
  } else {
    el.textContent=result;
    el.classList.add('dice-result-roll-off');
  }

  if(diceAnimMode!=='spin') el.textContent=result;
  document.getElementById('dice-result-label').textContent=`D${faces}`;
  diceHistory.unshift(`D${faces}: ${result}`);
  if(diceHistory.length>10)diceHistory.pop();
  document.getElementById('dice-history').innerHTML=diceHistory.map(h=>`<span style="margin-right:0.8rem;">${h}</span>`).join('');
}

// â”€â”€ ã‚«ãƒãƒ³ãƒœã‚¿ãƒ³è¡¨ç¤º â”€â”€
function showBagBtn(){document.getElementById('bag-btn').classList.add('visible');}

// â•â• èµ·å‹• â•â•
(function init(){
  characters=JSON.parse(localStorage.getItem(KEY_CHARS)||'[]');
  roles=JSON.parse(localStorage.getItem(KEY_ROLES)||'[]');
  worldDB=JSON.parse(localStorage.getItem(KEY_DB)||'null');
  apiKey=localStorage.getItem(KEY_API)||'';
  loadOptions();
  buildAnalyzeCats('opp'); buildAnalyzeCats('self'); buildAssistModes();
  if(worldDB)populateDBCatFilter();
  if(apiKey)unlockAnalyze();
  showView('char-list-view');
})();
</script>
</body>
</html>
