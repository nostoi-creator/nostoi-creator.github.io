<!DOCTYPE html>
<html lang="ja">
<head>
<style>html,body{background:#000;}</style>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Nóstoi — Grimoire</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0e0c09">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Grimoire">
<style>
:root {
  --bg:#0e0c09; --bg2:#161310; --bg3:#1c1814;
  --parchment:#c8b89a; --parchment-dim:#8a7a66; --parchment-dk:#4a3f32;
  --ink:#e8dece; --ink-dim:#a89880;
  --accent:#b87333; --accent2:#7a9e7e; --accent-glow:rgba(184,115,51,0.25);
  --danger:#8b2020; --border:rgba(184,115,51,0.22); --border-hi:rgba(184,115,51,0.55);
  --font-serif:'Noto Serif JP','Yu Mincho','YuMincho','游明朝',serif;
  --font-display:'Cormorant Garamond','Yu Mincho',serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:#1a0a03;
  background-image:
    radial-gradient(ellipse at 50% 120%, rgba(255,95,5,0.45) 0%, rgba(200,65,5,0.25) 20%, rgba(120,40,5,0.1) 40%, transparent 60%),
    radial-gradient(ellipse at 10% 110%, rgba(200,65,5,0.2) 0%, transparent 35%),
    radial-gradient(ellipse at 90% 110%, rgba(200,65,5,0.2) 0%, transparent 35%),
    radial-gradient(ellipse at 50% 50%, #2e1206 0%, #1a0a03 70%);
  color:var(--ink);font-family:var(--font-serif);min-height:100vh;font-size:14px;overflow:hidden;
  padding-bottom:calc(60px + env(safe-area-inset-bottom));}
body.app-active{overflow-y:auto;}
body.offline{
  background:#000;
  background-image:none;
  /* テキスト系を寒色（水色・彩度30%減）に上書き */
  --ink:#c2cdd8;
  --ink-dim:#8898a8;
  --parchment:#a8b8c8;
  --parchment-dim:#7a8898;
  --parchment-dk:#435870;
  --accent:#6a84a0;
  --accent2:#527068;
  --accent-glow:rgba(106,132,160,0.2);
  --border:rgba(106,132,160,0.22);
  --border-hi:rgba(106,132,160,0.5);
}
/* オフライン時の死亡処理・特殊表示は視認性の高い紫に */
body.offline .char-name-lost{color:#b088e8 !important;}
body.offline .char-detail-name-lost{color:#b088e8 !important;}
body.offline .lost-badge{
  background:rgba(80,40,140,0.35);
  border-color:rgba(176,136,232,0.45);
  color:#b088e8;
}
/* オフライン時の削除ボタンも紫に */
body.offline .btn-d{border-color:rgba(128,80,200,0.6);color:#b088e8;}
body.offline .btn-d:hover{background:rgba(100,60,180,0.4);color:#c8a8f8;}

/* ── 背景画像レイヤー（将来用） ── */
#bg-image{
  position:fixed;inset:0;pointer-events:none;z-index:0;
  background-size:cover;background-position:center;background-repeat:no-repeat;
  opacity:1;transition:filter 1.2s;
}
body.offline #bg-image{filter:brightness(0.5);}

/* ── Canvas ── */
#particle-canvas{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:0;transition:opacity 1s;}
#particle-canvas.visible{opacity:1;}
#offline-overlay{
  position:fixed;inset:0;pointer-events:none;z-index:1;
  background:
    radial-gradient(ellipse at 50% 30%, rgba(30,70,160,0.22) 0%, transparent 70%),
    radial-gradient(ellipse at 0% 60%,  rgba(15,45,110,0.18) 0%, transparent 55%),
    radial-gradient(ellipse at 100% 60%,rgba(15,45,110,0.18) 0%, transparent 55%),
    rgba(5,15,40,0.45);
  opacity:0;transition:opacity 1.2s;
}
#offline-overlay.visible{opacity:1;}

/* ══ タイトル ══ */
#title-screen{
  position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column;
  transition:opacity 0.8s;
  background:#000;
  overflow:hidden;
}
#title-screen.fade-out{opacity:0;pointer-events:none;}
/* タイトル画面表示中はbodyスクロール禁止 */
body.title-active{overflow:hidden;}
.title-nostoi{
  font-family:var(--font-display);font-size:clamp(3.5rem,12vw,7rem);font-weight:300;letter-spacing:0.15em;
  color:var(--parchment);line-height:1;text-align:center;
  text-shadow:0 0 40px rgba(184,115,51,0.5),0 0 12px rgba(0,0,0,0.9),0 3px 16px rgba(0,0,0,0.8);
}
.title-grimoire{
  font-family:var(--font-display);font-size:clamp(1.15rem,4.2vw,2.2rem);font-weight:400;letter-spacing:0.55em;
  color:var(--parchment);text-align:center;margin-top:0.55rem;text-transform:uppercase;
  text-shadow:0 0 28px rgba(184,115,51,0.75),0 0 8px rgba(184,115,51,0.4),0 2px 8px rgba(0,0,0,0.7);
}
.title-sub-jp{
  font-family:var(--font-serif);font-size:clamp(0.6rem,1.8vw,0.85rem);letter-spacing:0.4em;
  color:var(--parchment-dk);text-align:center;margin-top:0.8rem;
  -webkit-text-stroke:0.6px rgba(255,255,255,0.85);
  text-shadow:0 0 6px rgba(255,255,255,0.15),0 1px 4px rgba(0,0,0,0.9);
}
#title-start{cursor:pointer;user-select:none;}
.blink-text{font-family:var(--font-display);font-size:clamp(0.75rem,2vw,0.95rem);letter-spacing:0.5em;color:#C1AB8F;text-transform:uppercase;animation:blink 3s ease-in-out infinite;display:inline-block;padding:0.5rem 1.5rem;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.2;}}
#title-start:hover .blink-text{color:var(--parchment);animation-play-state:paused;opacity:1;}
#title-btn-container{margin-top:clamp(3rem,8vh,5rem);min-height:clamp(4rem,10vh,6rem);display:flex;align-items:center;justify-content:center;position:relative;}
#title-text{text-align:center;user-select:none;opacity:1;transition:opacity 0.4s;}
#title-mode{display:flex;flex-direction:column;align-items:center;gap:1rem;visibility:hidden;opacity:0;transition:opacity 0.3s;position:absolute;}
#title-mode.visible{visibility:visible;opacity:1;}
#title-start{position:absolute;transition:opacity 0.3s;}
#title-start.hidden{opacity:0;pointer-events:none;}
@keyframes fadeInUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.mode-btn{background:rgba(14,12,9,0.72);border:1px solid var(--border-hi);color:var(--parchment);font-family:var(--font-display);font-size:clamp(0.8rem,2.2vw,1rem);letter-spacing:0.5em;text-transform:uppercase;padding:0.75rem 2.5rem;cursor:pointer;transition:all 0.25s;width:240px;text-align:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);}
.mode-btn:hover{border-color:var(--accent);color:var(--parchment);background:rgba(184,115,51,0.18);box-shadow:0 0 16px rgba(184,115,51,0.2);}
#title-loading{display:none;position:absolute;bottom:-2.5rem;left:50%;transform:translateX(-50%);white-space:nowrap;font-size:0.7rem;letter-spacing:0.3em;color:var(--parchment-dk);text-transform:uppercase;animation:blink 1.2s ease-in-out infinite;}

/* ══ アプリ ══ */
#app{display:none;opacity:0;transition:opacity 0.6s;position:relative;z-index:1;}
#app.visible{opacity:1;}

/* ── ヘッダー ── */
.app-header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 1rem;height:52px;display:flex;align-items:center;gap:0.8rem;position:sticky;top:0;z-index:50;}
.app-title{font-family:var(--font-display);font-size:1rem;font-weight:300;letter-spacing:0.3em;color:var(--parchment);text-transform:uppercase;}
.app-title span{font-size:0.65rem;color:var(--parchment-dk);letter-spacing:0.15em;margin-left:0.5rem;}
.header-actions{margin-left:auto;display:flex;gap:0.5rem;align-items:center;}
.header-icon-btn{background:none;border:1px solid var(--border);color:var(--ink-dim);font-size:1rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:1px;transition:all 0.15s;}
.header-icon-btn:hover{border-color:var(--border-hi);color:var(--ink);}

/* ── アナウンスバー ── */
/* ── アーカイブ内アナウンスバナー ── */
.ann-status{font-size:0.72rem;color:var(--parchment-dk);letter-spacing:0.08em;padding:0.4rem 0;margin-bottom:0.8rem;}
.ann-banner{position:relative;overflow:hidden;border-radius:2px;margin-bottom:1.2rem;cursor:pointer;animation:annBannerIn 0.5s cubic-bezier(0.22,1,0.36,1) both;}
@keyframes annBannerIn{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}
.ann-banner-bg{position:absolute;inset:0;background:linear-gradient(135deg,rgba(184,115,51,0.18) 0%,rgba(74,63,50,0.12) 60%,rgba(139,32,32,0.08) 100%);pointer-events:none;}
.ann-banner.urgent .ann-banner-bg{background:linear-gradient(135deg,rgba(139,32,32,0.22) 0%,rgba(80,20,20,0.12) 60%,rgba(184,115,51,0.06) 100%);}
.ann-banner-border{position:absolute;inset:0;border:1px solid var(--border-hi);border-radius:2px;pointer-events:none;}
.ann-banner.urgent .ann-banner-border{border-color:rgba(139,32,32,0.55);}
.ann-banner-inner{position:relative;padding:1rem 1.2rem;}
.ann-banner-eyebrow{font-size:0.58rem;letter-spacing:0.35em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem;}
.ann-banner.urgent .ann-banner-eyebrow{color:#d47070;}
.ann-badge-new{display:inline-block;font-size:0.55rem;letter-spacing:0.2em;padding:0.1rem 0.4rem;background:var(--accent);color:var(--bg);border-radius:1px;font-weight:600;vertical-align:middle;animation:annPulse 1.8s ease-in-out infinite;}
.ann-banner.urgent .ann-badge-new{background:#8b2020;}
@keyframes annPulse{0%,100%{opacity:1;}50%{opacity:0.6;}}
.ann-banner-title{font-family:var(--font-display);font-size:clamp(1rem,3.5vw,1.3rem);font-weight:300;letter-spacing:0.12em;color:var(--parchment);line-height:1.3;margin-bottom:0.4rem;}
.ann-banner-meta{font-size:0.68rem;color:var(--parchment-dk);}
.ann-banner-more{position:absolute;right:1rem;bottom:1rem;font-size:0.65rem;color:var(--accent);letter-spacing:0.1em;}
.ann-banner.urgent .ann-banner-more{color:#d47070;}
.ann-banner-unread{font-size:0.62rem;color:var(--parchment-dk);margin-left:auto;}

/* ── ボトムナビ ── */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);display:flex;z-index:50;height:calc(52px + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);}
.bnav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.15rem;cursor:pointer;border:none;background:transparent;color:var(--ink-dim);transition:all 0.15s;font-family:var(--font-serif);border-top:2px solid transparent;}
.bnav-item:hover{color:var(--ink);background:rgba(184,115,51,0.04);}
.bnav-item.active{color:var(--accent);border-top-color:var(--accent);}
.bnav-item.disabled{color:var(--parchment-dk) !important;opacity:0.45;cursor:not-allowed;pointer-events:none;}
.bnav-icon{font-size:1.1rem;}
.bnav-label{font-size:0.58rem;letter-spacing:0.08em;}
.bnav-icon-archive{filter:saturate(0) brightness(0.65);}
#bnav-archive.active .bnav-icon-archive{filter:saturate(0.5) brightness(0.9);}
.bnav-icon-analyze{filter:saturate(0) brightness(0.65);}
#bnav-analyze.active .bnav-icon-analyze{filter:saturate(0.5) brightness(0.9);}

/* ── ページ ── */
.page{display:none;padding:1.2rem 1rem;max-width:760px;margin:0 auto;}
.page.active{display:block;}

/* ── セクションラベル ── */
.sec-label{font-size:0.62rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;display:flex;align-items:center;gap:0.6rem;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ── フォーム部品 ── */
label.fl{display:block;font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);margin-bottom:0.35rem;margin-top:1rem;}
input[type="text"],input[type="number"],input[type="password"],select,textarea{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:2px;color:var(--ink);font-family:var(--font-serif);font-size:0.85rem;padding:0.6rem 0.8rem;outline:none;transition:border-color 0.2s;}
input:focus,select:focus,textarea:focus{border-color:var(--border-hi);box-shadow:0 0 8px var(--accent-glow);}
input::placeholder,textarea::placeholder{color:var(--parchment-dk);}
textarea{resize:vertical;line-height:1.8;}
select option{background:var(--bg2);}

/* ── ボタン ── */
.btn{font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.1em;padding:0.6rem 1.2rem;cursor:pointer;border-radius:1px;transition:all 0.2s;border:1px solid;}
.btn-p{background:transparent;border-color:var(--accent);color:var(--accent);}
.btn-p:hover{background:var(--accent);color:var(--bg);}
.btn-g{background:transparent;border-color:var(--border);color:var(--ink-dim);}
.btn-g:hover{border-color:var(--border-hi);color:var(--ink);}
.btn-d{background:transparent;border-color:var(--danger);color:#d47070;}
.btn-d:hover{background:var(--danger);color:#fff;}
.btn-revive{background:transparent;border-color:#3a7a4a;color:#6ab87a;}
.btn-revive:hover{background:#3a7a4a;color:#fff;}
/* 削除最終確認ボタン：無効→3秒後フェードイン点灯 */
#btn-delete-final{opacity:0.3;pointer-events:none;transition:opacity 0.8s ease;}
#btn-delete-final.armed{opacity:1;pointer-events:auto;}
.btn:disabled{opacity:0.4;cursor:not-allowed;}
.btn-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem;align-items:center;}
.btn-sm{font-size:0.7rem;padding:0.3rem 0.7rem;}

/* ── キャラクターカード ── */
.char-card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:1rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s;}
.char-card:hover{border-color:var(--border-hi);background:var(--bg3);}
.char-card-header{display:flex;align-items:center;gap:0.7rem;}
.char-tag{font-size:0.68rem;color:var(--accent);letter-spacing:0.05em;font-family:var(--font-display);}
.char-name{font-size:0.92rem;color:var(--ink);}
.char-meta{font-size:0.68rem;color:var(--ink-dim);margin-top:0.3rem;letter-spacing:0.05em;}
.char-role-count{font-size:0.65rem;color:var(--parchment-dk);margin-left:auto;}
.char-name-lost{color:#d47070 !important;}
.char-detail-name-lost{color:#d47070 !important;}
.lost-badge{display:inline-block;font-size:0.58rem;letter-spacing:0.18em;padding:0.1rem 0.45rem;background:rgba(139,32,32,0.35);border:1px solid rgba(212,112,112,0.45);color:#d47070;border-radius:1px;vertical-align:middle;margin-left:0.4rem;}

/* ── キャラクター詳細ビュー ── */
#char-detail-view{display:none;}
.char-detail-header{display:flex;align-items:center;gap:0.7rem;padding:1rem;background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:1rem;}
.char-detail-name{font-family:var(--font-display);font-size:1.1rem;font-weight:300;letter-spacing:0.2em;color:var(--parchment);}
.char-detail-sub{font-size:0.7rem;color:var(--ink-dim);margin-top:0.2rem;}

/* ── ロールカード ── */
.role-card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:0.9rem 1rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s;}
.role-card:hover{border-color:var(--border-hi);background:var(--bg3);}
.role-card.selected{border-color:var(--accent);background:rgba(184,115,51,0.05);}
.role-card-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.4rem;}
.role-type-badge{font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;padding:0.15rem 0.45rem;border:1px solid;border-radius:1px;}
.badge-opp{border-color:rgba(122,158,126,0.5);color:var(--accent2);}
.badge-self{border-color:rgba(184,115,51,0.5);color:var(--accent);}
.role-session{font-size:0.68rem;color:var(--ink-dim);}
.role-date{font-size:0.65rem;color:var(--parchment-dk);margin-left:auto;}
.role-preview{font-size:0.8rem;color:var(--ink-dim);line-height:1.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.role-tags{display:flex;gap:0.3rem;flex-wrap:wrap;margin-top:0.5rem;}
.tag-chip{font-size:0.62rem;padding:0.1rem 0.4rem;background:rgba(184,115,51,0.1);border:1px solid var(--border);color:var(--parchment-dim);border-radius:1px;}
.detail-view{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:1.2rem;margin-top:0.8rem;animation:fadeIn 0.25s ease;}
.detail-header{display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem;padding-bottom:0.8rem;border-bottom:1px solid var(--border);}
.detail-body{font-size:0.86rem;line-height:2;white-space:pre-wrap;word-break:break-word;color:var(--ink);}
.detail-analysis{margin-top:1rem;padding:0.9rem 1rem;background:var(--bg3);border:1px solid var(--border);border-radius:2px;}
.detail-analysis-label{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;}
.detail-analysis-text{font-size:0.8rem;line-height:1.9;color:var(--ink-dim);white-space:pre-wrap;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

/* ── キャラクターシートフォーム ── */
.sheet-section{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:1rem;margin-bottom:0.8rem;}
.sheet-section-title{font-size:0.65rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:0.8rem;padding-bottom:0.5rem;border-bottom:1px solid var(--border);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;}
@media(max-width:500px){.form-row{grid-template-columns:1fr;}}
.field-warn{font-size:0.65rem;color:#d47070;letter-spacing:0.05em;margin-top:0.2rem;min-height:1em;}

/* 動的アイテムセクション */
.dynamic-item{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.8rem;margin-bottom:0.5rem;position:relative;}
.dynamic-item-del{position:absolute;top:0.5rem;right:0.5rem;background:none;border:none;color:var(--parchment-dk);cursor:pointer;font-size:0.8rem;padding:0.2rem 0.4rem;}
.dynamic-item-del:hover{color:#d47070;}

/* シートプレビュー */
.sheet-preview{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:1rem 1.2rem;font-size:0.8rem;line-height:2;color:var(--ink);white-space:pre-wrap;word-break:break-word;max-height:400px;overflow-y:auto;font-family:var(--font-serif);letter-spacing:0.03em;}

/* ── アーカイブ（世界観資料） ── */
.archive-announce-card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;overflow:hidden;margin-bottom:0.5rem;}
.archive-announce-card.urgent{border-color:rgba(139,32,32,0.4);}
.archive-announce-card.important{border-color:rgba(184,115,51,0.5);}
.archive-announce-card-header{display:flex;align-items:center;gap:0.6rem;padding:0.8rem 1rem;cursor:pointer;transition:background 0.15s;}
.archive-announce-card-header:hover{background:var(--bg3);}
.archive-announce-card-dot{width:6px;height:6px;border-radius:50%;background:var(--parchment-dk);flex-shrink:0;}
.archive-announce-card.urgent .archive-announce-card-dot{background:#d47070;}
.archive-announce-card.important .archive-announce-card-dot{background:var(--accent);}
.archive-announce-card-title{font-size:0.88rem;color:var(--ink);flex:1;}
.archive-announce-card-date{font-size:0.65rem;color:var(--parchment-dk);}
.archive-announce-card-arrow{font-size:0.65rem;color:var(--parchment-dk);transition:transform 0.2s;}
.archive-announce-card-arrow.open{transform:rotate(90deg);}
.archive-announce-card-body{max-height:0;overflow:hidden;transition:max-height 0.35s cubic-bezier(0.22,1,0.36,1),opacity 0.3s ease;padding:0 1rem;border-top:0 solid var(--border);font-size:0.82rem;color:var(--ink-dim);line-height:2;white-space:pre-wrap;opacity:0;}
.archive-announce-card-body.open{max-height:2000px;padding:0.8rem 1rem 1rem;border-top:1px solid var(--border);opacity:1;}
.archive-announce-empty{font-size:0.75rem;color:var(--parchment-dk);letter-spacing:0.1em;padding:0.5rem 0;}
.db-entry-card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:0.9rem 1rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s;}
.db-entry-card:hover{border-color:var(--border-hi);}
.db-entry-title{font-size:0.88rem;color:var(--ink);}
.db-entry-meta{font-size:0.68rem;color:var(--ink-dim);margin-top:0.25rem;}
.db-entry-body{font-size:0.82rem;line-height:1.9;color:var(--ink-dim);margin-top:0;white-space:pre-wrap;word-break:break-word;max-height:0;overflow:hidden;transition:max-height 0.35s cubic-bezier(0.22,1,0.36,1),margin-top 0.25s ease,opacity 0.3s ease;opacity:0;}
.db-entry-body.open{max-height:2000px;margin-top:0.7rem;opacity:1;}
.search-bar{display:flex;gap:0.5rem;margin-bottom:1rem;}
.search-bar input{flex:1;}

/* ── バックアップリマインダー ── */
#backup-reminder{display:none;margin:0;background:rgba(74,63,50,0.5);border-bottom:1px solid var(--border);padding:0.6rem 1rem;animation:annBannerIn 0.4s ease both;}
#backup-reminder.visible{display:flex;}
.backup-reminder-inner{display:flex;align-items:center;gap:0.6rem;width:100%;max-width:760px;margin:0 auto;}
.backup-reminder-text{font-size:0.7rem;color:var(--parchment-dim);letter-spacing:0.05em;flex:1;}
.backup-reminder-text strong{color:var(--parchment);font-weight:normal;}
.backup-reminder-btns{display:flex;gap:0.4rem;flex-shrink:0;}

/* ── ロック ── */
.locked-section{background:rgba(184,115,51,0.08);border:1px dashed var(--border);border-radius:2px;padding:1.5rem;text-align:center;margin-top:1.5rem;}
.locked-icon{font-size:1.5rem;margin-bottom:0.6rem;opacity:0.5;}
.locked-title{font-size:0.85rem;color:var(--parchment-dim);letter-spacing:0.1em;margin-bottom:0.4rem;}
.locked-desc{font-size:0.72rem;color:var(--parchment-dk);line-height:1.8;margin-bottom:1rem;}

/* ── ヘルプページ ── */
#help-page{position:fixed;inset:0;background:var(--bg);z-index:80;display:none;overflow-y:auto;padding-bottom:calc(60px + env(safe-area-inset-bottom));transform:translateX(100%);transition:transform 0.3s;}
#help-page.open{display:block;transform:translateX(0);}
.help-body{padding:1.5rem 1rem;max-width:600px;margin:0 auto;}
.help-section{margin-bottom:2rem;}
.help-section-title{font-size:0.62rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:1rem;display:flex;align-items:center;gap:0.6rem;}
.help-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.help-item{background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:0.5rem;overflow:hidden;}
.help-item-header{padding:0.8rem 1rem;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background 0.15s;}
.help-item-header:hover{background:var(--bg3);}
.help-item-title{font-size:0.85rem;color:var(--ink);letter-spacing:0.05em;}
.help-item-arrow{font-size:0.7rem;color:var(--parchment-dk);transition:transform 0.2s;}
.help-item-arrow.open{transform:rotate(90deg);}
.help-item-body{display:none;padding:0.8rem 1rem 1rem;border-top:1px solid var(--border);font-size:0.8rem;color:var(--ink-dim);line-height:2;}
.help-item-body.open{display:block;}
.help-item-body p{margin-bottom:0.6rem;}
.help-item-body p:last-child{margin-bottom:0;}
.help-tag{display:inline-block;font-size:0.65rem;padding:0.1rem 0.4rem;border:1px solid var(--border);border-radius:1px;color:var(--accent);margin:0 0.15rem;font-family:var(--font-display);letter-spacing:0.1em;}
#options-page{position:fixed;inset:0;background:var(--bg);z-index:80;display:none;overflow-y:auto;padding-bottom:calc(60px + env(safe-area-inset-bottom));transform:translateX(100%);transition:transform 0.3s;}
#options-page.open{display:block;transform:translateX(0);}
.options-header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 1rem;height:52px;display:flex;align-items:center;gap:0.8rem;position:sticky;top:0;z-index:5;}
.options-title{font-family:var(--font-display);font-size:0.9rem;font-weight:300;letter-spacing:0.3em;color:var(--parchment);text-transform:uppercase;}
.options-body{padding:1.5rem 1rem;max-width:600px;margin:0 auto;}
.options-section{margin-bottom:2rem;}
.options-section-title{font-size:0.62rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--accent);margin-bottom:1rem;display:flex;align-items:center;gap:0.6rem;}
.options-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:0.8rem 1rem;background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:0.5rem;}
.toggle-label{font-size:0.82rem;color:var(--ink-dim);}
.toggle-desc{font-size:0.68rem;color:var(--parchment-dk);margin-top:0.2rem;}
.toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--parchment-dk);border-radius:11px;cursor:pointer;transition:background 0.2s;}
.toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform 0.2s;}
.toggle-switch input:checked+.toggle-slider{background:var(--accent);}
.toggle-switch input:checked+.toggle-slider::before{transform:translateX(18px);}
/* カスタムチェックボックス */
.cb-wrap{display:flex;align-items:center;gap:0.5rem;cursor:pointer;user-select:none;white-space:nowrap;}
.cb-wrap input[type="checkbox"]{display:none;}
.cb-box{width:16px;height:16px;flex-shrink:0;background:var(--bg3);border:1px solid var(--border);border-radius:2px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.cb-wrap input[type="checkbox"]:checked+.cb-box{background:var(--accent);border-color:var(--accent);}
.cb-box::after{content:'';width:5px;height:9px;border:2px solid #0e0c09;border-top:none;border-left:none;transform:rotate(45deg) translateY(-1px);opacity:0;transition:opacity 0.15s;}
.cb-wrap input[type="checkbox"]:checked+.cb-box::after{opacity:1;}
.cb-label{font-size:0.72rem;color:var(--ink-dim);}
/* 年齢ロック時の斜線 */
input[type="number"].locked{
  pointer-events:none;color:var(--parchment-dk);
  background:repeating-linear-gradient(135deg,var(--bg3) 0px,var(--bg3) 6px,rgba(74,63,50,0.35) 6px,rgba(74,63,50,0.35) 8px);
  border-color:rgba(184,115,51,0.12);
}
.volume-row{padding:0.8rem 1rem;background:var(--bg2);border:1px solid var(--border);border-radius:2px;margin-bottom:0.5rem;}
.volume-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem;}
.volume-label{font-size:0.82rem;color:var(--ink-dim);}
.volume-value{font-size:0.72rem;color:var(--accent);}
input[type="range"]{width:100%;height:3px;-webkit-appearance:none;background:linear-gradient(to right,var(--accent) 0%,var(--accent) var(--val,70%),var(--parchment-dk) var(--val,70%));border-radius:2px;outline:none;cursor:pointer;}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--parchment);border-radius:50%;border:1px solid var(--accent);}

/* ── カバンポップ ── */
#bag-btn{position:fixed;right:1rem;bottom:calc(72px + env(safe-area-inset-bottom));z-index:60;width:46px;height:46px;background:var(--bg2);border:1px solid var(--border-hi);border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem;box-shadow:0 2px 12px rgba(0,0,0,0.5);transition:all 0.2s;}
#bag-btn.visible{display:flex;}
#bag-btn:hover{border-color:var(--accent);box-shadow:0 2px 16px var(--accent-glow);}
#bag-btn.open{background:var(--accent);border-color:var(--accent);}
#bag-menu{position:fixed;right:1rem;bottom:calc(126px + env(safe-area-inset-bottom));z-index:60;display:flex;flex-direction:column;gap:0.4rem;align-items:flex-end;pointer-events:none;opacity:0;transform:translateY(8px);transition:all 0.2s;}
#bag-menu.open{pointer-events:all;opacity:1;transform:translateY(0);}
.bag-menu-item{background:var(--bg2);border:1px solid var(--border-hi);border-radius:2px;padding:0.4rem 0.8rem;font-size:0.75rem;letter-spacing:0.1em;color:var(--parchment);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:0.5rem;transition:all 0.15s;}
.bag-menu-item:hover{border-color:var(--accent);color:var(--accent);}
/* カバンモーダル */
.bag-modal{background:var(--bg2);border:1px solid var(--border-hi);border-radius:2px;width:100%;max-width:420px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;animation:fadeIn 0.2s ease;}
.bag-modal-header{display:flex;align-items:center;padding:0.8rem 1rem;border-bottom:1px solid var(--border);flex-shrink:0;}
.bag-modal-title{font-family:var(--font-display);font-size:1rem;font-weight:300;letter-spacing:0.2em;color:var(--parchment);flex:1;}
.bag-modal-close{background:none;border:none;color:var(--parchment-dk);font-size:1rem;cursor:pointer;padding:0.2rem 0.4rem;}
.bag-modal-body{overflow-y:auto;padding:1rem;flex:1;}
/* 電卓 */
.calc-display{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.8rem 1rem;text-align:right;margin-bottom:0.8rem;}
.calc-expr{font-size:0.72rem;color:var(--parchment-dk);min-height:1.2em;letter-spacing:0.05em;}
.calc-val{font-size:1.6rem;color:var(--ink);letter-spacing:0.05em;font-family:'Courier New',monospace;}
.calc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.4rem;}
.calc-btn{background:var(--bg3);border:1px solid var(--border);color:var(--ink-dim);font-family:var(--font-serif);font-size:0.9rem;padding:0.7rem;cursor:pointer;border-radius:2px;transition:all 0.1s;text-align:center;}
.calc-btn:hover{border-color:var(--border-hi);color:var(--ink);}
.calc-btn.op{color:var(--accent);}
.calc-btn.eq{background:rgba(184,115,51,0.15);border-color:var(--accent);color:var(--accent);}
.calc-btn.eq:hover{background:var(--accent);color:var(--bg);}
.calc-btn.cl{color:#d47070;}
/* メモ帳 */
.memo-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:0.8rem;}
.memo-tab{flex:1;padding:0.5rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.75rem;letter-spacing:0.1em;color:var(--ink-dim);cursor:pointer;transition:all 0.15s;}
.memo-tab.active{border-bottom-color:var(--accent);color:var(--accent);}
/* マインドマップ */
#mindmap-canvas{width:100%;height:340px;background:var(--bg3);border:1px solid var(--border);border-radius:2px;cursor:default;touch-action:none;}
.mindmap-toolbar{display:flex;gap:0.4rem;margin-bottom:0.5rem;flex-wrap:wrap;}
/* ダイス */
.dice-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-bottom:1rem;}
.dice-btn{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.7rem;text-align:center;cursor:pointer;transition:all 0.15s;}
.dice-btn:hover{border-color:var(--border-hi);}
.dice-label{font-size:0.68rem;color:var(--accent);letter-spacing:0.1em;}
.dice-icon{font-size:1.4rem;margin:0.3rem 0;}
.dice-result-area{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:1rem;text-align:center;min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.dice-result-num{font-family:var(--font-display);font-size:2.5rem;font-weight:300;color:var(--parchment);line-height:1;}
.dice-result-label{font-size:0.7rem;color:var(--ink-dim);margin-top:0.3rem;letter-spacing:0.1em;}
.dice-result-roll-off{animation:diceRoll 0.3s ease;}
.dice-result-roll-spin{animation:diceSpin 1.4s cubic-bezier(0.25,0.46,0.45,0.94);}
.dice-result-roll-shake{animation:diceShake 1.1s ease;}
@keyframes diceRoll{0%{transform:scale(1.3);opacity:0.5;}100%{transform:scale(1);opacity:1;}}
@keyframes diceSpin{
  0%  {transform:scale(0.5) rotate(0deg);   opacity:0.3;}
  30% {transform:scale(1.2) rotate(180deg); opacity:0.9;}
  60% {transform:scale(0.95)rotate(320deg); opacity:1;}
  80% {transform:scale(1.05)rotate(355deg); opacity:1;}
  100%{transform:scale(1)   rotate(360deg); opacity:1;}
}
@keyframes diceShake{
  0%  {transform:translateX(0)    rotate(0deg);}
  10% {transform:translateX(-8px) rotate(-15deg);}
  20% {transform:translateX(8px)  rotate(15deg);}
  30% {transform:translateX(-6px) rotate(-10deg);}
  40% {transform:translateX(6px)  rotate(10deg);}
  55% {transform:translateX(-3px) rotate(-5deg);}
  65% {transform:translateX(3px)  rotate(5deg) scale(1.1);}
  80% {transform:translateX(0)    rotate(0deg) scale(1.05);}
  90% {transform:translateY(-4px) scale(1.02);}
  100%{transform:translateY(0)    scale(1);}
}

/* ダイスアイコンのシェイク */
.dice-icon-anim-shake{animation:diceIconShake 1.1s ease;}
.dice-icon-anim-spin {animation:diceIconSpin  1.4s ease;}
@keyframes diceIconShake{
  0%,100%{transform:rotate(0);}
  15%{transform:rotate(-20deg) scale(1.2);}
  30%{transform:rotate(20deg)  scale(1.2);}
  45%{transform:rotate(-15deg) scale(1.15);}
  60%{transform:rotate(15deg)  scale(1.1);}
  75%{transform:rotate(-8deg)  scale(1.05);}
  88%{transform:rotate(8deg)   scale(1.02);}
}
@keyframes diceIconSpin{
  0%  {transform:rotate(0)    scale(1);}
  40% {transform:rotate(540deg) scale(1.3);}
  70% {transform:rotate(900deg) scale(1.1);}
  100%{transform:rotate(1080deg) scale(1);}
}
/* ── 叙述チャット ── */
.chat-bubble{max-width:88%;padding:0.7rem 0.9rem;border-radius:2px;font-size:0.85rem;line-height:1.9;white-space:pre-wrap;word-break:break-word;animation:fadeIn 0.2s ease;}
.chat-bubble.user{align-self:flex-end;background:rgba(184,115,51,0.15);border:1px solid var(--border-hi);color:var(--ink);}
.chat-bubble.ai{align-self:flex-start;background:var(--bg2);border:1px solid var(--border);color:var(--ink-dim);}
.chat-bubble.ai.loading{color:var(--parchment-dk);font-style:italic;}
.chat-sender{font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:0.3rem;color:var(--parchment-dk);}
#apanel-chat.active-panel{display:flex;}
.page{backface-visibility:hidden;transform-style:preserve-3d;}
.page.flip-out{animation:flipOut 0.22s ease-in forwards;}
.page.flip-in {animation:flipIn  0.22s ease-out forwards;}
@keyframes flipOut{
  0%  {transform:perspective(1200px) rotateY(0deg)   scale(1);   opacity:1;}
  100%{transform:perspective(1200px) rotateY(-90deg) scale(0.95);opacity:0;}
}
@keyframes flipIn{
  0%  {transform:perspective(1200px) rotateY(90deg)  scale(0.95);opacity:0;}
  100%{transform:perspective(1200px) rotateY(0deg)   scale(1);   opacity:1;}
}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;padding:1rem;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border-hi);border-radius:2px;padding:2rem;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;animation:fadeIn 0.25s ease;}
.modal-title{font-family:var(--font-display);font-size:1.2rem;font-weight:300;letter-spacing:0.2em;color:var(--parchment);margin-bottom:1.2rem;}
.modal-step{display:flex;gap:0.8rem;margin-bottom:0.8rem;align-items:flex-start;}
.step-num{width:20px;height:20px;border-radius:50%;background:rgba(184,115,51,0.2);border:1px solid var(--border-hi);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:var(--accent);flex-shrink:0;margin-top:0.1rem;}
.step-text{font-size:0.8rem;color:var(--ink-dim);line-height:1.8;}
.step-link{color:var(--accent);text-decoration:underline;cursor:pointer;}
.caution-box{background:rgba(139,32,32,0.1);border:1px solid rgba(139,32,32,0.3);border-radius:2px;padding:0.8rem 1rem;margin:1rem 0;font-size:0.75rem;color:#c87070;line-height:1.8;}
.announce-modal-list{display:flex;flex-direction:column;gap:0.7rem;}
.announce-modal-item{background:var(--bg3);border:1px solid var(--border);border-radius:2px;padding:0.9rem 1rem;}
.announce-modal-header{display:flex;align-items:baseline;gap:0.7rem;margin-bottom:0.4rem;}
.announce-modal-title{font-size:0.88rem;color:var(--ink);}
.announce-modal-date{font-size:0.65rem;color:var(--parchment-dk);margin-left:auto;}
.announce-modal-body{font-size:0.8rem;color:var(--ink-dim);line-height:1.9;white-space:pre-wrap;}
.level-badge{font-size:0.58rem;padding:0.1rem 0.4rem;border-radius:1px;border:1px solid;}
.level-normal{border-color:var(--border);color:var(--ink-dim);}
.level-important{border-color:rgba(184,115,51,0.5);color:var(--accent);}
.level-urgent{border-color:rgba(139,32,32,0.5);color:#d47070;}

/* ── 空状態 ── */
.empty{text-align:center;padding:3rem 1rem;color:var(--parchment-dk);}
.empty-icon{font-size:2rem;margin-bottom:0.6rem;opacity:0.4;}
.empty-text{font-size:0.8rem;letter-spacing:0.1em;}
.sep{border:none;border-top:1px solid var(--border);margin:1.5rem 0;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--parchment-dk);border-radius:2px;}
@media(min-width:600px){.page{padding:1.5rem;}.app-header{padding:0 1.5rem;}.options-body{padding:1.5rem;}}
@media(min-width:768px){
  /* コンテンツ幅を広げる */
  .page{max-width:860px;padding:2rem 2.5rem;}
  .help-body,.options-body{max-width:720px;padding:2rem 2.5rem;}
  /* ヘッダー */
  .app-header{padding:0 2rem;}
  .app-title{font-size:1.1rem;}
  /* ボトムナビを中央寄せ・幅制限してPCでも使いやすく */
  .bottom-nav{max-width:540px;left:50%;transform:translateX(-50%);border-radius:4px 4px 0 0;border-left:1px solid var(--border);border-right:1px solid var(--border);}
  /* フォント・余白調整 */
  body{font-size:15px;}
  .modal{max-width:580px;padding:2.5rem;}
  .bag-modal{max-width:500px;}
  /* ホバー操作を少し強調 */
  .char-card:hover{border-color:var(--border-hi);transform:translateY(-1px);transition:all 0.15s;}
  .role-card:hover{border-color:var(--border-hi);transform:translateY(-1px);}
}
</style>
</head>
<body>
<div id="bg-image"></div>
<canvas id="particle-canvas"></canvas>
<div id="offline-overlay"></div>

<!-- ══ タイトル画面 ══ -->
<div id="title-screen">
  <div id="title-text" style="text-align:center;user-select:none;">
    <div class="title-nostoi">Nóstoi</div>
    <div class="title-grimoire">Grimoire</div>
    <div class="title-sub-jp">ノストイ叙事詩環</div>
  </div>
  <div id="title-btn-container">
    <div id="title-start" onclick="playSETitle();onStartClick()"><span class="blink-text">START</span></div>
    <div id="title-mode">
      <button class="mode-btn" onclick="playSETitle();selectMode('online')">ONLINE</button>
      <button class="mode-btn" onclick="playSETitle();selectMode('offline')">OFFLINE</button>
    </div>
    <div id="title-loading">Loading…</div>
  </div>
</div>

<!-- ══ メインアプリ ══ -->
<div id="app">
  <div class="app-header">
    <span class="app-title">Grimoire <span>Nóstoi</span></span>
    <div class="header-actions">
      <button class="header-icon-btn" onclick="openHelp()">?</button>
      <button class="header-icon-btn" onclick="openOptions()">⚙</button>

    </div>
  </div>


  <!-- ── バックアップリマインダー ── -->
  <div id="backup-reminder">
    <div class="backup-reminder-inner">
      <span class="backup-reminder-text">⚠ <strong>データのバックアップをお勧めします。</strong>前回のエクスポートから30日以上経過しています</span>
      <div class="backup-reminder-btns">
        <button class="btn btn-p btn-sm" onclick="exportData()">今すぐ保存</button>
        <button class="btn btn-g btn-sm" onclick="dismissBackupReminder()">後で</button>
      </div>
    </div>
  </div>

  <!-- ── ロールプレイページ ── -->
  <div class="page active" id="page-roleplay">

    <!-- キャラクター一覧ビュー -->
    <div id="char-list-view">
      <div class="search-bar">
        <input type="text" id="char-search" placeholder="キャラクターを検索…" oninput="renderCharList()">
      </div>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-p" onclick="showCharCreate()">＋ キャラクターを作成</button>
      </div>
      <div id="char-list" style="margin-top:1rem;"></div>
    </div>

    <!-- キャラクター詳細ビュー -->
    <div id="char-detail-view">
      <!-- 上段：キャラ名 -->
      <div style="margin-bottom:0.5rem;">
        <div class="char-detail-name" id="detail-char-name"></div>
        <div class="char-detail-sub" id="detail-char-sub"></div>
      </div>
      <!-- 下段：操作ボタン -->
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
        <button class="btn btn-g btn-sm" onclick="backToCharList()">← 一覧</button>
        <button class="btn btn-g btn-sm" onclick="showCharSheet()">シート</button>
        <button class="btn btn-g btn-sm" onclick="showCharEdit()">編集</button>
        <button class="btn btn-d btn-sm" id="btn-lost-char" onclick="openLostModal()">死亡</button>
        <button class="btn btn-d btn-sm" onclick="openDeleteCharModal(currentCharId)">削除</button>
      </div>
      <div class="search-bar">
        <input type="text" id="role-search" placeholder="ロールを検索…" oninput="renderRoles()">
        <select id="role-filter-type" onchange="renderRoles()" style="width:auto;">
          <option value="">すべて</option><option value="opp">相手</option><option value="self">自分</option>
        </select>
      </div>
      <div class="sec-label">セッション</div>
      <div id="session-list" style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-bottom:0.8rem;"></div>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-p" onclick="openModal('modal-new-role')">＋ ロールを記録</button>
      </div>
      <div id="role-list" style="margin-top:1rem;"></div>
    </div>

    <!-- キャラクター作成・編集フォーム -->
    <div id="char-form-view" style="display:none;">
      <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem;">
        <button class="btn btn-g btn-sm" onclick="cancelCharForm()">← 戻る</button>
        <span style="font-size:0.85rem;color:var(--parchment);letter-spacing:0.1em;" id="char-form-title">キャラクター作成</span>
      </div>

      <!-- 基本情報 -->
      <div class="sheet-section">
        <div class="sheet-section-title">基本情報</div>
        <label class="fl" style="margin-top:0;">識別タグ ※</label>
        <input type="text" id="sf-tag" placeholder="#タグ">
        <label class="fl">名前 ※</label>
        <input type="text" id="sf-name" placeholder="">
        <div class="form-row" style="margin-top:1rem;">
          <div>
            <label class="fl" style="margin-top:0;">性別</label>
            <select id="sf-sex">
              <option value="">性別（未選択）</option>
              <option value="ᴍᴀʟᴇ">男性 (MALE)</option>
              <option value="ғᴇᴍᴀʟᴇ">女性 (FEMALE)</option>
              <option value="ᴜɴᴋɴᴏᴡɴ">不明 (UNKNOWN)</option>
            </select>
          </div>
          <div>
            <label class="fl" style="margin-top:0;">年齢</label>
            <div style="display:flex;gap:0.4rem;align-items:center;">
              <input type="number" id="sf-age" min="0" max="9999" placeholder="" oninput="checkAgeWarn()" style="flex:1;min-width:0;">
              <label class="cb-wrap">
                <input type="checkbox" id="sf-age-unknown" onchange="onAgeUnknown()">
                <span class="cb-box"></span>
                <span class="cb-label">不明</span>
              </label>
            </div>
            <div class="field-warn" id="warn-age"></div>
          </div>
        </div>
        <div class="form-row" style="margin-top:0.8rem;">
          <div>
            <label class="fl" style="margin-top:0;">種族</label>
            <select id="sf-race">
              <option value="">種族（未選択）</option>
              <option value="ᴜɴᴋɴᴏᴡɴ">不明 (UNKNOWN)</option>
              <option value="ʀɪsᴇ">源人 (RISE)</option>
              <option value="ᴡɪsᴇ">鋭人 (WISE)</option>
              <option value="ʜᴀʀᴅ">小人 (HARD)</option>
              <option value="ʙᴇᴀsᴛ">獣人 (BEAST)</option>
              <option value="ʟɪᴢᴀʀᴅ">竜人・蜥蜴 (LIZARD)</option>
              <option value="ᴅʀᴀᴋᴇ">竜人・龍 (DRAKE)</option>
              <option value="ᴏɢʀᴇ">鬼人 (OGRE)</option>
            </select>
          </div>
          <div>
            <label class="fl" style="margin-top:0;">身長 / 体重</label>
            <div style="display:flex;gap:0.4rem;align-items:center;">
              <input type="number" id="sf-height" min="0" max="9999" placeholder="cm" oninput="checkBodyWarn()" style="flex:1;min-width:0;">
              <span style="font-size:0.72rem;color:var(--parchment-dk);">/</span>
              <input type="number" id="sf-weight" min="0" max="9999" placeholder="kg" oninput="checkBodyWarn()" style="flex:1;min-width:0;">
            </div>
            <div class="field-warn" id="warn-body"></div>
          </div>
        </div>
        <label class="fl">ジョブ ※</label>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <select id="sf-job-primary" style="flex:1;" onchange="updateJobSelects()">
            <option value="">一次職（未選択）</option>
            <optgroup label="物理職">
              <option value="ᴠᴀɴɢᴜᴀʀᴅ">戦士 / ヴァンガード</option>
              <option value="ʙᴏᴡᴍᴀɴ">射手 / ボウマン</option>
              <option value="ʀɪᴅᴇʀ">騎手 / ライダー (R)</option>
            </optgroup>
            <optgroup label="魔法職">
              <option value="ᴍᴀɢᴇ">魔術師 / メイジ</option>
              <option value="ᴡɪsʜᴇʀ">祈祷師 / ウィッシャー</option>
              <option value="sʜᴀᴍᴀɴ">霊術師 / シャーマン</option>
              <option value="sᴏʀᴄᴇʀᴇʀ">呪術師 / ソーサラー</option>
              <option value="ᴡɪᴢᴀʀᴅ">魔道士 / ウィザード</option>
            </optgroup>
          </select>
          <select id="sf-job-secondary" style="flex:1;" onchange="updateJobDisplay()">
            <option value="">二次職（未選択）</option>
            <option value="ʀɪᴅᴇʀ">騎手 / ライダー (R)</option>
            <optgroup label="魔法二次職">
              <option value="ᴇɴᴄʜᴀɴᴛᴇʀ">魔術師² / エンチャンター (E)</option>
              <option value="ᴏʀᴀᴄʟᴇ">祈祷師² / オラクル (O)</option>
              <option value="ᴄᴏɴᴊᴜʀᴇʀ">霊術師² / コンジュラー (C)</option>
              <option value="ᴡᴀʀʟᴏᴄᴋ">呪術師² / ウォーロック (W)</option>
              <option value="sᴀɢᴇ">魔道士² / セージ (S)</option>
            </optgroup>
          </select>
        </div>
        <div id="sf-job-preview" style="font-size:0.72rem;color:var(--accent);letter-spacing:0.15em;min-height:1.2em;margin-top:0.25rem;"></div>
        <label class="fl">所属ギルド</label>
        <input type="text" id="sf-guild" placeholder="">
        <label class="fl">キャラクター概要 ※</label>
        <textarea id="sf-overview" rows="5" placeholder="容姿・性格・経歴などを記述してください。"></textarea>
      </div>

      <!-- 武装 -->
      <div class="sheet-section">
        <div class="sheet-section-title">武装 (WEAPON)</div>
        <div id="sf-weapons"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addDynamicItem('weapons','武器名','詳細（任意）')">＋ 武器を追加</button>
      </div>

      <!-- 防具 -->
      <div class="sheet-section">
        <div class="sheet-section-title">防具 (ARMOR)</div>
        <div id="sf-armors"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addDynamicItem('armors','防具名','詳細（任意）')">＋ 防具を追加</button>
      </div>

      <!-- 乗騎 -->
      <div class="sheet-section">
        <div class="sheet-section-title">乗騎 (VEHICLE)</div>
        <div id="sf-vehicles"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addDynamicItem('vehicles','乗騎名','詳細（任意）')">＋ 乗騎を追加</button>
      </div>

      <!-- 道具 -->
      <div class="sheet-section">
        <div class="sheet-section-title">道具 (ITEM)</div>
        <div id="sf-items"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addDynamicItem('items','道具名','詳細（任意）')">＋ 道具を追加</button>
      </div>

      <!-- 魔法 -->
      <div class="sheet-section">
        <div class="sheet-section-title">魔法 (MAGIC)</div>
        <div id="sf-magics"></div>
        <button class="btn btn-g btn-sm" style="margin-top:0.5rem;" onclick="addMagicItem()">＋ 魔法を追加</button>
      </div>

      <div class="btn-row">
        <button class="btn btn-p" onclick="saveChar()">保存</button>
        <button class="btn btn-g" onclick="cancelCharForm()">キャンセル</button>
      </div>
    </div>

    <!-- シートプレビュー -->
    <div id="char-sheet-view" style="display:none;">
      <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:1rem;">
        <button class="btn btn-g btn-sm" onclick="backToCharDetail()">← 戻る</button>
        <span style="font-size:0.85rem;color:var(--parchment);letter-spacing:0.1em;">キャラクターシート</span>
      </div>
      <div class="sheet-preview" id="sheet-preview-text"></div>
      <div class="btn-row">
        <button class="btn btn-p" onclick="copySheet()">シートをコピー</button>
      </div>
    </div>

  </div>

  <!-- ── アーカイブページ ── -->
  <div class="page" id="page-archive">
    <div id="archive-announce-area" style="margin-bottom:1rem;"></div>
    <div class="search-bar">
      <input type="text" id="db-search" placeholder="記事を検索…" oninput="renderDB()">
      <select id="db-cat-filter" onchange="renderDB()" style="width:auto;"><option value="">すべて</option></select>
    </div>
    <div id="db-not-loaded" style="display:none;">
      <div class="empty">
        <div class="empty-icon">📚</div>
        <div class="empty-text">アーカイブが読み込まれていません</div>
        <button class="btn btn-p btn-sm" style="margin-top:1rem;" onclick="openOptions();setTimeout(()=>{const el=document.getElementById('opt-db-section');if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},320);">オプションで読み込む</button>
      </div>
    </div>
    <div id="db-content"></div>
  </div>

  <!-- ── 分析ページ ── -->
  <div class="page" id="page-analyze">
    <div class="sec-label">グリモワール機能（AI補助）</div>
    <div id="analyze-locked" class="locked-section">
      <div class="locked-icon">🔒</div>
      <div class="locked-title">グリモワール機能は解放されていません</div>
      <div class="locked-desc">グリモワール機能（AI補助）を使用するにはGoogle Gemini APIキーの登録が必要です。<br>APIキーは無料で取得できますが、使用量に応じた費用が発生します。</div>
      <button class="btn btn-p" onclick="openModal('modal-api-setup')">APIキーを登録して解放する</button>
    </div>
    <div id="analyze-unlocked" style="display:none;">
      <div style="display:flex;border-bottom:1px solid var(--border);margin-bottom:1.5rem;">
        <button id="atab-opp"    onclick="switchAnalyzeTab('opp')"    style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid var(--accent);font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--accent);cursor:pointer;">相手</button>
        <button id="atab-self"   onclick="switchAnalyzeTab('self')"   style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--ink-dim);cursor:pointer;">自分</button>
        <button id="atab-assist" onclick="switchAnalyzeTab('assist')" style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--ink-dim);cursor:pointer;">作成補助</button>
        <button id="atab-chat"   onclick="switchAnalyzeTab('chat')"   style="flex:none;height:40px;padding:0 1.2rem;background:none;border:none;border-bottom:2px solid transparent;font-family:var(--font-serif);font-size:0.78rem;letter-spacing:0.08em;color:var(--ink-dim);cursor:pointer;">叙述</button>
      </div>
      <div id="apanel-opp">
        <div class="sec-label">ロール本文</div>
        <textarea id="opp-text" rows="7" placeholder="相手のロールを貼り付けてください。"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">世界観補足（任意）</div>
        <textarea id="opp-supp" rows="3" placeholder="世界観資料の参照内容や補足情報"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">分析カテゴリ</div>
        <div id="opp-cats" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
        <div class="btn-row"><button class="btn btn-p" id="opp-btn" onclick="doAnalyze('opp')">解析 執行</button></div>
        <div id="opp-result"></div>
      </div>
      <div id="apanel-self" style="display:none;">
        <div class="sec-label">ロール本文</div>
        <textarea id="self-text" rows="7" placeholder="自分のロールを貼り付けてください。"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">世界観補足（任意）</div>
        <textarea id="self-supp" rows="3" placeholder="世界観資料の参照内容や補足情報"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">分析カテゴリ</div>
        <div id="self-cats" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
        <div class="btn-row"><button class="btn btn-p" id="self-btn" onclick="doAnalyze('self')">解析 執行</button></div>
        <div id="self-result"></div>
      </div>
      <div id="apanel-assist" style="display:none;">
        <div class="sec-label">状況・文脈</div>
        <textarea id="assist-ctx" rows="6" placeholder="現在の状況・直前の展開・相手の直近のロールなど"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">キャラクター情報（任意）</div>
        <textarea id="assist-chara" rows="3" placeholder="性格・能力・立場・動機など"></textarea>
        <div class="sec-label" style="margin-top:1.2rem;">補助モード</div>
        <div id="assist-modes" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
        <div class="btn-row"><button class="btn btn-p" id="assist-btn" onclick="doAnalyze('assist')">補助 執行</button></div>
        <div id="assist-result"></div>
      </div>
      <!-- 叙述チャット -->
      <div id="apanel-chat" style="display:none;flex-direction:column;height:calc(100vh - 210px);">
        <div id="chat-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:0.8rem;padding-bottom:0.5rem;min-height:0;"></div>
        <div style="display:flex;gap:0.5rem;align-items:flex-end;padding-top:0.8rem;border-top:1px solid var(--border);margin-top:0.5rem;flex-shrink:0;">
          <textarea id="chat-input" rows="3" placeholder="グリモワールに話しかける…" style="flex:1;resize:none;font-size:0.85rem;line-height:1.8;" onkeydown="chatKeydown(event)"></textarea>
          <div style="display:flex;flex-direction:column;gap:0.4rem;">
            <button class="btn btn-p btn-sm" id="chat-send-btn" onclick="sendChat()">送信</button>
            <button class="btn btn-g btn-sm" onclick="clearChat()">消去</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="bnav-item" id="bnav-archive" onclick="switchPage('archive')">
      <span class="bnav-icon bnav-icon-archive">📚</span><span class="bnav-label">アーカイブ</span>
    </button>
    <button class="bnav-item active" id="bnav-roleplay" onclick="switchPage('roleplay')">
      <span class="bnav-icon">⚔</span><span class="bnav-label">ロールプレイ</span>
    </button>
    <button class="bnav-item" id="bnav-analyze" onclick="switchPage('analyze')">
      <span class="bnav-icon bnav-icon-analyze">👁</span><span class="bnav-label">グリモワール</span>
    </button>
  </nav>
</div>

<!-- ══ ヘルプページ ══ -->
<div id="help-page">
  <div class="options-header">
    <button class="header-icon-btn" onclick="closeHelp()">←</button>
    <span class="options-title">Help</span>
  </div>
  <div class="help-body">

    <div class="help-section">
      <div class="help-section-title">起動</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ONLINE / OFFLINE の違い</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p><span class="help-tag">ONLINE</span> を選ぶとフォントの読み込み・火の粉アニメーション・BGM・SEが有効になります。インターネット接続が必要です。</p>
          <p><span class="help-tag">OFFLINE</span> を選ぶとこれらの演出なしで起動します。接続なしでも全機能が使えます。</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">ロールプレイ</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">キャラクターを作成する</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>ロールプレイタブ下部の <span class="help-tag">＋ キャラクターを作成</span> をタップします。</p>
          <p>識別タグ（例：#アントス）と名前は必須項目です。性別・種族・ジョブはプルダウンから選択すると、コピー用のシート文字（ᴍᴀʟᴇ等）に自動変換されます。</p>
          <p>武装・防具・アイテム・魔法は <span class="help-tag">＋</span> ボタンで項目を追加できます。保存後はいつでも編集できます。</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">キャラクターシートをコピーする</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>キャラクター詳細画面の <span class="help-tag">シート</span> ボタンをタップするとLINE用の整形テキストが表示されます。</p>
          <p><span class="help-tag">シートをコピー</span> ボタンでクリップボードに一括コピーできます。そのままLINEに貼り付けてください。</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ロールを記録する</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>キャラクターを選択した状態で <span class="help-tag">＋ ロールを記録</span> をタップします。</p>
          <p>種別（相手 / 自分）・セッション名・ロール本文を入力して保存してください。タグはカンマ区切りで複数入力できます。</p>
          <p>セッション名は過去に入力したものが補完候補として表示されます。</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">ロールを確認・絞り込む</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>ロール一覧はキャラクターごとに表示されます。キーワード検索・種別フィルター（相手 / 自分）で絞り込めます。</p>
          <p>セッション名バッジをタップすると、そのセッションのロールだけに絞り込めます。</p>
          <p>ロールカードをタップすると本文・メモ・分析結果が展開されます。もう一度タップで閉じます。</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">キャラクターを編集・削除する</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>キャラクター詳細画面の <span class="help-tag">編集</span> ボタンから内容を修正できます。</p>
          <p><span class="help-tag">削除</span> ボタンを押すとキャラクターと関連する全ロールが削除されます。この操作は取り消せません。</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">アーカイブ</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">世界観資料を読み込む</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>オプション画面の <span class="help-tag">世界観資料</span> セクションから管理人に配布されたJSONファイルを読み込みます。</p>
          <p>読み込んだ世界観資料はアーカイブタブで閲覧できます。端末に保存されるので次回以降の読み込みは不要です。</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">記事を検索・絞り込む</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>上部の検索バーにキーワードを入力するとタイトル・本文・タグを対象に絞り込めます。</p>
          <p>カテゴリフィルターで特定カテゴリの記事だけを表示できます。記事カードをタップすると本文が展開されます。</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">分析</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">グリモワール機能（AI補助）を解放する</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>グリモワール機能（AI補助）にはGoogle Gemini APIキーが必要です。<span class="help-tag">APIキーを登録して解放する</span> から登録画面を開いてください。</p>
          <p>APIキーはaistudio.google.comで無料取得できます。ただし使用量に応じた費用（無料枠超過時）が発生する場合があります。費用の管理はご自身で行ってください。</p>
          <p>キーはこの端末のブラウザにのみ保存されます。他の端末で使う場合は再登録が必要です。</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">各分析モードの使い方</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p><span class="help-tag">相手</span> 相手のロール本文を貼り付けて解析します。分析カテゴリを選択すると観点を指定できます。</p>
          <p><span class="help-tag">自分</span> 自分のロール本文を貼り付けて強みと課題を評価します。</p>
          <p><span class="help-tag">作成補助</span> 現在の状況・文脈を入力するとロールの草案や構造提案を生成します。補助モードで用途を絞れます。</p>
          <p>世界観資料が読み込まれている場合、ロール本文の内容に関連する記事を自動で参照して分析精度を高めます。</p>
        </div>
      </div>
    </div>

    <div class="help-section">
      <div class="help-section-title">データ管理</div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">データをエクスポート・インポートする</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>オプション画面の <span class="help-tag">データ管理</span> セクションからキャラクターとロールのデータをJSONファイルとして書き出せます。</p>
          <p>機種変更やブラウザのデータ消去に備えて定期的なバックアップを推奨します。</p>
          <p>インポート時は既存データとの統合になります。重複するIDのデータは上書きされません。</p>
        </div>
      </div>

      <div class="help-item">
        <div class="help-item-header" onclick="toggleHelp(this)">
          <span class="help-item-title">APIキーをバックアップする</span>
          <span class="help-item-arrow">▶</span>
        </div>
        <div class="help-item-body">
          <p>APIキーはブラウザのデータ消去で失われます。オプション画面の <span class="help-tag">APIキー</span> セクションから現在のキーをコピーして別途保管してください。</p>
          <p><span class="help-tag">エクスポートにAPIキーを含める</span> をONにするとバックアップJSONにキーを含めることができます。ただしファイルを他者に渡す際は必ずOFFにしてください。</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ══ オプションページ ══ -->
<div id="options-page">
  <div class="options-header">
    <button class="header-icon-btn" onclick="closeOptions()">←</button>
    <span class="options-title">Options</span>
    <span id="online-badge" style="margin-left:auto;font-size:0.6rem;letter-spacing:0.2em;color:var(--accent2);text-transform:uppercase;display:none;">● Online</span>
  </div>
  <div class="options-body">
    <div class="options-section">
      <div class="options-section-title">ナビゲーション</div>
      <button class="btn btn-g" id="btn-return-title" onclick="requestReturnToTitle()">↩ タイトルに戻る</button>
      <p style="font-size:0.7rem;color:var(--parchment-dk);margin-top:0.5rem;line-height:1.8;">タイトル画面に戻り、ONLINE / OFFLINEを選び直せます。</p>
    </div>
      <div class="options-section-title">表示</div>
      <div class="toggle-row">
        <div><div class="toggle-label">アニメーション</div><div class="toggle-desc">火の粉エフェクト（オンライン時のみ）</div></div>
        <label class="toggle-switch"><input type="checkbox" id="opt-animation" checked onchange="onAnimationToggle()"><span class="toggle-slider"></span></label>
      </div>
    </div>
    <div class="options-section" id="opt-sound-section" style="display:none;">
      <div class="options-section-title">サウンド</div>
      <div class="volume-row">
        <div class="volume-header"><span class="volume-label">SE 音量</span><span class="volume-value" id="se-vol-label">70</span></div>
        <input type="range" id="opt-se-vol" min="0" max="100" value="70" oninput="onVolumeChange('se',this.value)" style="--val:70%;">
      </div>
      <div class="volume-row">
        <div class="volume-header"><span class="volume-label">BGM 音量</span><span class="volume-value" id="bgm-vol-label">40</span></div>
        <input type="range" id="opt-bgm-vol" min="0" max="100" value="40" oninput="onVolumeChange('bgm',this.value)" style="--val:40%;">
      </div>
    </div>
    <div class="options-section">
      <div class="options-section-title">ダイス演出</div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        <button class="btn btn-g btn-sm" id="dice-anim-shake" onclick="setDiceAnim('shake')">シェイク</button>
        <button class="btn btn-g btn-sm" id="dice-anim-spin"  onclick="setDiceAnim('spin')">スピン</button>
        <button class="btn btn-g btn-sm" id="dice-anim-off"   onclick="setDiceAnim('off')">OFF</button>
      </div>
      <p style="font-size:0.7rem;color:var(--parchment-dk);margin-top:0.5rem;line-height:1.8;">現在: <span id="dice-anim-current">シェイク</span></p>
    </div>

    <div class="options-section">
      <div class="options-section-title">APIキー</div>
      <div id="api-key-status" style="font-size:0.75rem;color:var(--ink-dim);margin-bottom:1rem;"></div>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-g" onclick="copyApiKey()">🔑 APIキーをコピー</button>
        <button class="btn btn-g" onclick="openModal('modal-api-setup')">再登録</button>
      </div>
      <div class="toggle-row" style="margin-top:1rem;">
        <div>
          <div class="toggle-label">エクスポートにAPIキーを含める</div>
          <div class="toggle-desc">OFFを推奨。ファイルを他者に渡す場合は必ずOFFにしてください。</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="opt-export-apikey" onchange="onExportApiKeyToggle()">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div id="apikey-export-warning" style="display:none;background:rgba(139,32,32,0.1);border:1px solid rgba(139,32,32,0.3);border-radius:2px;padding:0.8rem 1rem;margin-top:0.5rem;font-size:0.72rem;color:#c87070;line-height:1.9;">
        ⚠ 注意事項<br>
        · APIキーはエクスポートJSONに平文で記録されます。<br>
        · ファイルを他者に送付・共有した場合、キーが漏洩します。<br>
        · 漏洩したキーは第三者に無制限に使用される恐れがあり、<br>
        　発生した費用は全てご自身に請求されます。<br>
        · 個人バックアップ専用として使用してください。
      </div>
    </div>

    <div class="options-section">
      <div class="options-section-title">データ管理</div>
      <p style="font-size:0.78rem;color:var(--ink-dim);line-height:1.8;margin-bottom:1rem;">キャラクター・ロールのデータをエクスポート・インポートできます。</p>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn btn-g" onclick="exportData()">📤 書き出す</button>
        <button class="btn btn-g" onclick="importData()">📂 読み込む</button>
      </div>
      <hr class="sep">
      <p style="font-size:0.75rem;color:#c87070;line-height:1.8;margin-bottom:0.8rem;">⚠ 以下の操作は取り消せません</p>
      <button class="btn btn-d" onclick="clearAllData()">全データを消去</button>
    </div>
    <div class="options-section" id="opt-db-section">
      <div class="options-section-title">世界観資料</div>
      <div id="db-current-info" style="font-size:0.75rem;color:var(--ink-dim);margin-bottom:1rem;"></div>
      <button class="btn btn-p" onclick="loadDB()">📂 世界観資料を読み込む</button>
    </div>
  </div>
</div>

<!-- ══ モーダル ══ -->
<!-- 汎用ダイアログ（alert/confirm代替） -->
<div class="modal-overlay" id="modal-gm-dialog">
  <div class="modal" style="max-width:360px;">
    <div class="modal-title" id="gm-dialog-title"></div>
    <div id="gm-dialog-msg" style="font-size:0.86rem;line-height:1.9;color:var(--ink);margin-bottom:0.4rem;white-space:pre-wrap;word-break:break-word;"></div>
    <input type="text" id="gm-dialog-input" style="display:none;margin-top:0.6rem;" placeholder="">
    <div class="btn-row" style="margin-top:1.2rem;justify-content:flex-end;">
      <button id="gm-dialog-cancel" class="btn btn-g" onclick="gmDialogCancel()" style="display:none;">キャンセル</button>
      <button id="gm-dialog-ok" class="btn btn-p" onclick="gmDialogOk()">OK</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-new-role">
  <div class="modal">
    <div class="modal-title">ロールを記録</div>
    <label class="fl" style="margin-top:0;">種別</label>
    <select id="nr-type"><option value="opp">相手のロール</option><option value="self">自分のロール</option></select>
    <label class="fl">セッション名</label>
    <input type="text" id="nr-session" placeholder="例：第3章 王都の夜" list="session-datalist">
    <datalist id="session-datalist"></datalist>
    <label class="fl">ロール本文</label>
    <textarea id="nr-body" rows="7" placeholder="ロール本文を貼り付けてください。"></textarea>
    <label class="fl">メモ（任意）</label>
    <textarea id="nr-memo" rows="2" placeholder="分析メモ・感想・伏線など"></textarea>
    <label class="fl">タグ（カンマ区切り）</label>
    <input type="text" id="nr-tags" placeholder="例：伏線, 重要, 戦闘">
    <div class="btn-row">
      <button class="btn btn-p" onclick="saveRole()">保存</button>
      <button class="btn btn-g" onclick="closeModal('modal-new-role')">キャンセル</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-api-setup">
  <div class="modal">
    <div class="modal-title">🔑 APIキー登録</div>
    <p style="font-size:0.8rem;color:var(--ink-dim);line-height:1.9;margin-bottom:1.2rem;">グリモワール機能（AI補助）はGoogle Gemini APIを使用します。</p>
    <div class="modal-step"><div class="step-num">1</div><div class="step-text"><span class="step-link" onclick="window.open('https://aistudio.google.com/apikey','_blank')">こちら</span>を開きGoogleアカウントでサインインしてください。</div></div>
    <div class="modal-step"><div class="step-num">2</div><div class="step-text">「APIキーを作成」からキーを発行してください。</div></div>
    <div class="modal-step"><div class="step-num">3</div><div class="step-text">発行されたキー（「AIza…」から始まる文字列）を下の欄に貼り付けて登録してください。</div></div>
    <div class="caution-box">⚠ APIの使用は従量制です（無料枠超過時）。キーはこのブラウザにのみ保存されます。管理・費用はご自身の責任となります。</div>
    <label class="fl" style="margin-top:0;">APIキー</label>
    <input type="password" id="api-key-input" placeholder="AIza…">
    <div class="btn-row">
      <button class="btn btn-p" onclick="registerApiKey()">登録して解放</button>
      <button class="btn btn-g" onclick="closeModal('modal-api-setup')">キャンセル</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-announce">
  <div class="modal">
    <div class="modal-title">📣 お知らせ</div>
    <div id="announce-modal-content" class="announce-modal-list"></div>
    <div class="btn-row"><button class="btn btn-g" onclick="closeModal('modal-announce')">閉じる</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-mode-online">
  <div class="modal">
    <div class="modal-title">ONLINE モード</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.2rem;">オンライン環境でBGM・SEを読み込みます。API接続後、グリモワール機能（AI補助）が利用可能になります。各自音声はメインページのオプションから調整が可能です。</p>
    <div style="margin-bottom:1.2rem;">
      <label class="cb-wrap">
        <input type="checkbox" id="skip-online-confirm">
        <span class="cb-box"></span>
        <span style="font-size:0.75rem;color:var(--ink-dim);">次回から表示しない</span>
      </label>
    </div>
    <div class="btn-row">
      <button class="btn btn-p" onclick="confirmMode('online')">続行</button>
      <button class="btn btn-g" onclick="cancelMode('modal-mode-online')">キャンセル</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-mode-offline">
  <div class="modal">
    <div class="modal-title">OFFLINE モード</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.2rem;">オフラインでGrimoireを続行します。グリモワール機能（AI補助）はご利用いただけません。オンラインへの切り替えはメインページのオプションから「タイトルへ戻る」で再ログインすることで可能です。</p>
    <div style="margin-bottom:1.2rem;">
      <label class="cb-wrap">
        <input type="checkbox" id="skip-offline-confirm">
        <span class="cb-box"></span>
        <span style="font-size:0.75rem;color:var(--ink-dim);">次回から表示しない</span>
      </label>
    </div>
    <div class="btn-row">
      <button class="btn btn-p" onclick="confirmMode('offline')">続行</button>
      <button class="btn btn-g" onclick="cancelMode('modal-mode-offline')">キャンセル</button>
    </div>
  </div>
</div>

<!-- ══ 死亡確認モーダル ══ -->
<div class="modal-overlay" id="modal-lost-char">
  <div class="modal">
    <div class="modal-title" id="modal-lost-title">キャラクターを死亡処理しますか？</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.5rem;">キャラクター名が赤文字で強調表示され、状態に「死亡」が付与されます。この操作はキャラクター編集から取り消せます。</p>
    <div class="btn-row">
      <button class="btn btn-d" onclick="confirmLost()">死亡処理</button>
      <button class="btn btn-g" onclick="closeModal('modal-lost-char')">キャンセル</button>
    </div>
  </div>
</div>

<!-- ══ 蘇生確認モーダル ══ -->
<div class="modal-overlay" id="modal-revive-char">
  <div class="modal">
    <div class="modal-title" id="modal-revive-title">キャラクターを蘇生しますか？</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.5rem;">死亡状態を解除し、キャラクター名を通常表示に戻します。</p>
    <div class="btn-row">
      <button class="btn btn-p" onclick="confirmRevive()">蘇生</button>
      <button class="btn btn-g" onclick="closeModal('modal-revive-char')">キャンセル</button>
    </div>
  </div>
</div>

<!-- ══ キャラクター削除確認モーダル（1段階目） ══ -->
<div class="modal-overlay" id="modal-delete-char">
  <div class="modal">
    <div class="modal-title" id="modal-delete-title">キャラクターを削除しますか？</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.5rem;">削除したキャラクターと紐づくロールは完全に失われます。</p>
    <div class="btn-row">
      <button class="btn btn-d" onclick="openDeleteFinalModal()">次へ</button>
      <button class="btn btn-g" onclick="closeModal('modal-delete-char')">キャンセル</button>
    </div>
  </div>
</div>

<!-- ══ キャラクター削除最終確認モーダル（2段階目） ══ -->
<div class="modal-overlay" id="modal-delete-final">
  <div class="modal">
    <div class="modal-title">本当によろしいですか？</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:1.2rem;">この操作は取り消せません。</p>
    <div style="margin-bottom:1.5rem;">
      <label class="cb-wrap">
        <input type="checkbox" id="delete-char-with-roles">
        <span class="cb-box"></span>
        <span style="font-size:0.75rem;color:var(--ink-dim);">削除後にJSONファイルとして書き出す</span>
      </label>
    </div>
    <div class="btn-row">
      <button class="btn btn-d" id="btn-delete-final" onclick="confirmDeleteChar()" disabled>削除</button>
      <button class="btn btn-g" onclick="cancelDeleteFinal()">キャンセル</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-return-title">
  <div class="modal" style="text-align:center;max-width:320px;padding:2.5rem 2rem;">
    <div class="modal-title" style="margin-bottom:1rem;">タイトルに戻る</div>
    <p style="font-size:0.82rem;color:var(--ink-dim);line-height:2;margin-bottom:2rem;">タイトル画面に戻りますか？</p>
    <div class="btn-row" style="justify-content:center;gap:1rem;">
      <button class="btn btn-p" onclick="confirmReturnToTitle()">戻る</button>
      <button class="btn btn-g" onclick="cancelReturnToTitle()">キャンセル</button>
    </div>
  </div>
</div>

<!-- ══ カバンポップ ══ -->
<button id="bag-btn" onclick="toggleBag()">✒️</button>
<div id="bag-menu">
  <div class="bag-menu-item" onclick="openBagTool('dice')">🎲 ダイス</div>
  <div class="bag-menu-item" onclick="openBagTool('memo')">📝 メモ帳</div>
  <div class="bag-menu-item" onclick="openBagTool('calc')">🔢 電卓</div>
</div>

<!-- 電卓モーダル -->
<div class="modal-overlay" id="modal-calc">
  <div class="bag-modal">
    <div class="bag-modal-header">
      <span class="bag-modal-title">Calculator</span>
      <button class="bag-modal-close" onclick="closeModal('modal-calc')">✕</button>
    </div>
    <div class="bag-modal-body">
      <div class="calc-display">
        <div class="calc-expr" id="calc-expr"></div>
        <div class="calc-val" id="calc-val">0</div>
      </div>
      <div class="calc-grid" style="grid-template-columns:repeat(5,1fr);">
        <button class="calc-btn cl" onclick="calcClear()">C</button>
        <button class="calc-btn op" onclick="calcSign()">±</button>
        <button class="calc-btn op" onclick="calcPercent()">%</button>
        <button class="calc-btn cl" onclick="calcBack()">⌫</button>
        <button class="calc-btn op" onclick="calcOp('/')">÷</button>
        <button class="calc-btn" onclick="calcNum('7')">7</button>
        <button class="calc-btn" onclick="calcNum('8')">8</button>
        <button class="calc-btn" onclick="calcNum('9')">9</button>
        <button class="calc-btn op" colspan="2" onclick="calcOp('*')" style="grid-column:span 2;">×</button>
        <button class="calc-btn" onclick="calcNum('4')">4</button>
        <button class="calc-btn" onclick="calcNum('5')">5</button>
        <button class="calc-btn" onclick="calcNum('6')">6</button>
        <button class="calc-btn op" colspan="2" onclick="calcOp('-')" style="grid-column:span 2;">−</button>
        <button class="calc-btn" onclick="calcNum('1')">1</button>
        <button class="calc-btn" onclick="calcNum('2')">2</button>
        <button class="calc-btn" onclick="calcNum('3')">3</button>
        <button class="calc-btn op" colspan="2" onclick="calcOp('+')" style="grid-column:span 2;">＋</button>
        <button class="calc-btn" onclick="calcNum('0')" style="grid-column:span 2;">0</button>
        <button class="calc-btn" onclick="calcDot()">.</button>
        <button class="calc-btn eq" onclick="calcEqual()" style="grid-column:span 2;">=</button>
      </div>
    </div>
  </div>
</div>

<!-- メモ帳モーダル -->
<div class="modal-overlay" id="modal-memo">
  <div class="bag-modal" style="max-width:520px;">
    <div class="bag-modal-header">
      <span class="bag-modal-title">Notepad</span>
      <button class="bag-modal-close" onclick="closeModal('modal-memo')">✕</button>
    </div>
    <div class="bag-modal-body">
      <div class="memo-tabs">
        <button class="memo-tab active" id="memo-tab-flat" onclick="switchMemoTab('flat')">フラット</button>
        <button class="memo-tab" id="memo-tab-mind" onclick="switchMemoTab('mind')">マインド</button>
      </div>
      <div id="memo-flat-panel">
        <textarea id="memo-flat-text" rows="12" placeholder="メモを入力してください。" style="font-size:0.85rem;line-height:1.9;"></textarea>
        <div class="btn-row"><button class="btn btn-g btn-sm" onclick="clearFlatMemo()">クリア</button><button class="btn btn-g btn-sm" onclick="copyFlatMemo()">コピー</button></div>
      </div>
      <div id="memo-mind-panel" style="display:none;">
        <div class="mindmap-toolbar">
          <button class="btn btn-g btn-sm" onclick="mmAddChild()">＋ 子ノード</button>
          <button class="btn btn-g btn-sm" onclick="mmDeleteNode()">✕ 削除</button>
          <button class="btn btn-g btn-sm" onclick="mmEditNode()">✎ 編集</button>
          <button class="btn btn-g btn-sm" onclick="mmToggleFullscreen()">⛶ 全画面</button>
          <button class="btn btn-d btn-sm" onclick="mmClear()">全消去</button>
        </div>
        <div id="mm-node-panel" style="display:none;align-items:center;gap:0.8rem;flex-wrap:wrap;padding:0.4rem 0;margin-bottom:0.4rem;border-bottom:1px solid var(--border);">
          <span style="font-size:0.7rem;color:var(--parchment-dk);letter-spacing:0.1em;">選択中</span>
          <label style="font-size:0.72rem;color:var(--ink-dim);display:flex;align-items:center;gap:0.4rem;">
            サイズ
            <input type="range" id="mm-size-slider" min="20" max="80" value="34" style="width:80px;" oninput="mmSetSize(this.value)">
            <span id="mm-size-val" style="font-size:0.7rem;color:var(--parchment-dk);min-width:2em;">34</span>
          </label>
          <label style="font-size:0.72rem;color:var(--ink-dim);display:flex;align-items:center;gap:0.4rem;">
            カラー
            <input type="color" id="mm-color-picker" value="#b87333" style="width:32px;height:24px;border:none;background:none;cursor:pointer;padding:0;" oninput="mmSetColor(this.value)">
          </label>
        </div>
        <canvas id="mindmap-canvas"></canvas>
        <p style="font-size:0.65rem;color:var(--parchment-dk);margin-top:0.5rem;line-height:1.8;">ノードをタップして選択 → 子ノード追加 / 編集 / 削除</p>
      </div>
    </div>
  </div>
</div>

<!-- ダイスモーダル -->
<div class="modal-overlay" id="modal-dice">
  <div class="bag-modal">
    <div class="bag-modal-header">
      <span class="bag-modal-title">Dice</span>
      <button class="bag-modal-close" onclick="closeModal('modal-dice')">✕</button>
    </div>
    <div class="bag-modal-body">
      <div class="dice-grid">
        <div class="dice-btn" onclick="rollDice(4)"><div class="dice-label">D4</div><div class="dice-icon">🔺</div></div>
        <div class="dice-btn" onclick="rollDice(6)"><div class="dice-label">D6</div><div class="dice-icon">🎲</div></div>
        <div class="dice-btn" onclick="rollDice(8)"><div class="dice-label">D8</div><div class="dice-icon">💠</div></div>
        <div class="dice-btn" onclick="rollDice(10)"><div class="dice-label">D10</div><div class="dice-icon">🔷</div></div>
        <div class="dice-btn" onclick="rollDice(12)"><div class="dice-label">D12</div><div class="dice-icon">🔶</div></div>
        <div class="dice-btn" onclick="rollDice(20)"><div class="dice-label">D20</div><div class="dice-icon">⭐</div></div>
      </div>
      <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:1rem;">
        <input type="number" id="dice-custom-faces" min="2" max="999" placeholder="面数" style="width:80px;">
        <button class="btn btn-g btn-sm" onclick="rollDice(parseInt(document.getElementById('dice-custom-faces').value)||6)">カスタム</button>
      </div>
      <div class="dice-result-area">
        <div class="dice-result-num" id="dice-result">—</div>
        <div class="dice-result-label" id="dice-result-label"></div>
      </div>
      <div id="dice-history" style="margin-top:0.8rem;font-size:0.72rem;color:var(--parchment-dk);line-height:2;max-height:80px;overflow-y:auto;"></div>
    </div>
  </div>
</div>

<input type="file" id="import-file" accept=".json" style="display:none;">
<input type="file" id="db-file" accept=".json" style="display:none;">
<audio id="se-page" src="" preload="metadata"></audio>
<audio id="bgm-main" src="" loop preload="metadata"></audio>

<script>
'use strict';
const KEY_CHARS  = 'gm_characters';
const KEY_ROLES  = 'gm_roles';
const KEY_DB     = 'gm_worlddb';
const KEY_ANN    = 'gm_announce_cache';
const KEY_API    = 'gm_apikey';
const KEY_OPTS   = 'gm_options';
const KEY_LAST_EXPORT = 'gm_last_export';
const GIST_URL   = '';
const BACKUP_REMIND_DAYS = 30;

const DEFAULT_CATS  = ['歴史・政治','魔法・術式','戦術・戦闘','キャラクター心理','世界観整合性'];
const ASSIST_MODES  = [{id:'draft',name:'返しの草案生成'},{id:'skeleton',name:'構造提案'},{id:'emotion',name:'感情・動機の深掘り'},{id:'tension',name:'緊張感の設計'}];

let isOnline=false, characters=[], roles=[], worldDB=null, announces=[], apiKey='';
let options={animation:true,seVol:70,bgmVol:40,exportApiKey:false};
let currentCharId=null, editingCharId=null;
const checkedCats={opp:new Set(),self:new Set()}, checkedModes=new Set();

// ══ タイトル ══
function onStartClick(){
  const s=document.getElementById('title-start');
  s.classList.add('hidden');
  setTimeout(()=>{
    document.getElementById('title-start').classList.add('hidden');
    document.getElementById('title-mode').classList.add('visible');
  },400);
}
function selectMode(mode){
  const skipKey = mode==='online' ? 'gm_skip_online_confirm' : 'gm_skip_offline_confirm';
  if(localStorage.getItem(skipKey)==='1'){
    proceedMode(mode);
  } else {
    openModal(mode==='online' ? 'modal-mode-online' : 'modal-mode-offline');
  }
}
async function confirmMode(mode){
  const skipKey = mode==='online' ? 'gm_skip_online_confirm' : 'gm_skip_offline_confirm';
  const skipEl  = document.getElementById(mode==='online' ? 'skip-online-confirm' : 'skip-offline-confirm');
  if(skipEl?.checked) localStorage.setItem(skipKey,'1');
  closeModal(mode==='online' ? 'modal-mode-online' : 'modal-mode-offline');
  await proceedMode(mode);
}
function cancelMode(modalId){
  closeModal(modalId);
}
async function proceedMode(mode){
  isOnline=(mode==='online');
  const loadingEl=document.getElementById('title-loading');
  const modeEl=document.getElementById('title-mode');
  if(isOnline){
    // 選択肢を即座に操作不可にしてからフェードアウト
    modeEl.style.pointerEvents='none';
    modeEl.classList.remove('visible');
    loadingEl.textContent='接続確認中…';
    loadingEl.style.display='block';
    await new Promise(r=>setTimeout(r,350));
    // ── ネット接続チェック ──
    const connected=checkNetworkConnection();
    if(!connected){
      isOnline=false;
      loadingEl.style.animation='none';
      loadingEl.style.opacity='1';
      loadingEl.style.color='var(--parchment-dim)';
      loadingEl.style.fontSize='0.75rem';
      loadingEl.style.letterSpacing='0.1em';
      loadingEl.textContent='インターネット接続が確認できませんでした。オフラインで開始します';
      await new Promise(r=>setTimeout(r,2200));
      loadingEl.style.display='none';
    } else {
      loadingEl.style.animation='';
      loadingEl.textContent='サウンド読み込み中…';
      await preloadBGM('https://nostoi-creator.github.io/gm-bgm.m4a?v='+Date.now(), options.bgmVol/100);
      loadingEl.textContent='完了';
      await new Promise(r=>setTimeout(r,400));
    }
  }
  // 黒オーバーレイで全体を3秒かけてフェードアウト
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;z-index:500;background:#000;opacity:0;transition:opacity 2s;pointer-events:none;';
  document.body.appendChild(overlay);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{ overlay.style.opacity='1'; }));
  // オーバーレイが完全に黒い間にフォント読み込み（ONLINEのみ）
  if(isOnline) await loadFonts();
  await new Promise(r=>setTimeout(r,2100));
  // 完全に黒い状態でタイトル→メイン切り替え
  const t=document.getElementById('title-screen');
  t.style.display='none';
  launchApp();
  await new Promise(r=>setTimeout(r,200));
  overlay.style.transition='opacity 0.8s';
  overlay.style.opacity='0';
  setTimeout(()=>overlay.remove(), 900);
}
function checkNetworkConnection(){
  return navigator.onLine;
}
let _returningToTitle=false;
function requestReturnToTitle(){
  if(_returningToTitle)return;
  _returningToTitle=true;
  const btn=document.getElementById('btn-return-title');
  if(btn) btn.disabled=true;
  openModal('modal-return-title');
}
function confirmReturnToTitle(){
  closeModal('modal-return-title');
  playSETitle();
  returnToTitle();
}
function cancelReturnToTitle(){
  closeModal('modal-return-title');
  _returningToTitle=false;
  const btn=document.getElementById('btn-return-title');
  if(btn) btn.disabled=false;
}
async function returnToTitle(){
  document.body.classList.remove('app-active');
  if(_bgmCtx&&_bgmCtx.state==='suspended') await _bgmCtx.resume().catch(()=>{});

  // 全要素を3秒かけて同時フェードアウト
  const optPage=document.getElementById('options-page');
  const app=document.getElementById('app');
  const pc=document.getElementById('particle-canvas');

  // 背景グラデーションを隠すオーバーレイを作成
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;z-index:200;background:#000;opacity:0;transition:opacity 3s;pointer-events:none;';
  document.body.appendChild(overlay);

  optPage.style.transition='opacity 3s';
  app.style.transition='opacity 3s';
  pc.style.transition='opacity 3s';

  requestAnimationFrame(()=>{
    optPage.style.opacity='0';
    app.style.opacity='0';
    pc.style.opacity='0';
    overlay.style.opacity='1';
  });

  await fadeOutAllSounds(3);

  document.getElementById('offline-overlay').classList.remove('visible');
  document.body.classList.remove('offline');
  document.getElementById('bnav-analyze').classList.remove('disabled');
  app.classList.remove('visible');
  optPage.classList.remove('open');
  optPage.style.display='none';
  optPage.style.opacity='';
  optPage.style.transition='';

  setTimeout(()=>{
    app.style.display='none';
    app.style.opacity='';
    app.style.transition='opacity 0.6s';
    stopParticles();
    pc.classList.remove('visible');
    pc.style.transition='opacity 1s';
    pc.style.opacity='';
    const t=document.getElementById('title-screen');
    t.style.display='flex'; t.style.opacity='0';
    t.classList.remove('fade-out');
    document.body.classList.add('title-active');
    document.getElementById('title-start').classList.remove('hidden');
    document.getElementById('title-mode').classList.remove('visible');
    document.getElementById('title-mode').style.pointerEvents='';
    document.getElementById('title-loading').style.display='none';
    document.getElementById('title-text').style.opacity='1';
    document.getElementById('title-text').style.transition='';
    // タイトルフェードインとオーバーレイフェードアウトを同時に開始
    setTimeout(()=>{
      t.style.opacity='1';
      overlay.style.transition='opacity 1s';
      overlay.style.opacity='0';
      setTimeout(()=>overlay.remove(), 1100);
      _returningToTitle=false;
    },30);
  },300);
}
// ══ WebAudio BGM ══
let _bgmCtx=null, _bgmSource=null, _bgmGain=null, _bgmBuffer=null;

// ══ WebAudio アンビエント（環境音・将来実装用） ══
let _ambCtx=null, _ambSource=null, _ambGain=null, _ambBuffer=null;
async function initWebAudioAmb(url, vol){
  try{
    // BGMと同じContextを共有する
    if(!_bgmCtx) return;
    _ambGain=_bgmCtx.createGain();
    _ambGain.gain.value=vol;
    _ambGain.connect(_bgmCtx.destination);
    const res=await fetch(url);
    const arr=await res.arrayBuffer();
    _ambBuffer=await _bgmCtx.decodeAudioData(arr);
    _playAmbLoop();
  }catch(e){}
}
function _playAmbLoop(){
  if(!_bgmCtx||!_ambBuffer)return;
  _ambSource=_bgmCtx.createBufferSource();
  _ambSource.buffer=_ambBuffer;
  _ambSource.loop=true;
  _ambSource.connect(_ambGain);
  _ambSource.start(0);
}
function setAmbVolume(v){
  if(_ambGain) _ambGain.gain.value=v;
}

function _playBGMLoop(){
  if(!_bgmCtx||!_bgmBuffer)return;
  _bgmSource=_bgmCtx.createBufferSource();
  _bgmSource.buffer=_bgmBuffer;
  _bgmSource.loop=true;
  _bgmSource.connect(_bgmGain);
  _bgmSource.start(0);
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata=null;
    navigator.mediaSession.setActionHandler('play',null);
    navigator.mediaSession.setActionHandler('pause',null);
    navigator.mediaSession.setActionHandler('stop',null);
    navigator.mediaSession.setActionHandler('previoustrack',null);
    navigator.mediaSession.setActionHandler('nexttrack',null);
  }
}
function setBGMVolume(v){
  if(_bgmGain) _bgmGain.gain.value=v;
  else document.getElementById('bgm-main').volume=v;
}

// 全サウンドをフェードアウトして停止
function fadeOutAllSounds(duration=1.2){
  return new Promise(resolve=>{
    // suspendされていてもrampが効くようにresume
    if(_bgmCtx&&_bgmCtx.state==='suspended') _bgmCtx.resume().catch(()=>{});
    const now=_bgmCtx?.currentTime||0;
    if(_bgmGain) _bgmGain.gain.linearRampToValueAtTime(0, now+duration);
    if(_ambGain) _ambGain.gain.linearRampToValueAtTime(0, now+duration);
    // フォールバックのaudioタグ
    const bgm=document.getElementById('bgm-main');
    if(bgm&&!bgm.paused){
      const start=bgm.volume;
      const step=start/(duration*20);
      const iv=setInterval(()=>{
        bgm.volume=Math.max(0,bgm.volume-step);
        if(bgm.volume<=0){clearInterval(iv);}
      },50);
    }
    setTimeout(()=>{
      if(_bgmSource){try{_bgmSource.stop();}catch(e){} _bgmSource=null;}
      if(_ambSource){try{_ambSource.stop();}catch(e){} _ambSource=null;}
      if(_bgmCtx){_bgmCtx.close(); _bgmCtx=null;}
      _bgmGain=null; _bgmBuffer=null; _ambGain=null; _ambBuffer=null;
      bgm.pause(); bgm.src='';
      resolve();
    }, duration*1000);
  });
}
function stopBGM(){ fadeOutAllSounds(0); }
async function loadFonts(){
  const l=document.createElement('link'); l.rel='stylesheet';
  l.href='https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=Noto+Serif+JP:wght@300;400;600&display=swap';
  document.head.appendChild(l);
  try{await document.fonts.ready;}catch(e){}
}
async function preloadBGM(url, vol){
  try{
    _bgmCtx=new (window.AudioContext||window.webkitAudioContext)();
    _bgmGain=_bgmCtx.createGain();
    _bgmGain.gain.value=vol;
    _bgmGain.connect(_bgmCtx.destination);
    const res=await fetch(url);
    const arr=await res.arrayBuffer();
    _bgmBuffer=await _bgmCtx.decodeAudioData(arr);
    // バッファだけ用意して再生はlaunchApp後に行う
  }catch(e){
    // フォールバック：audioタグ用にURLだけ保持
    _bgmFallbackUrl=url; _bgmFallbackVol=vol;
  }
}
let _bgmFallbackUrl=null, _bgmFallbackVol=0;
async function loadOnlineResources(){
  // 後方互換のため残す（直接呼ばれることはない）
  await loadFonts();
  if(options.animation) initParticles();
}
function launchApp(){
  document.body.classList.remove('title-active');
  document.body.classList.add('app-active');
  const app=document.getElementById('app');
  app.style.display='block'; setTimeout(()=>app.classList.add('visible'),30);
  const badge=document.getElementById('online-badge');
  if(isOnline){
    badge.style.display='block';
    badge.textContent='● Online';
    badge.style.color='var(--accent2)';
    document.getElementById('opt-sound-section').style.display='block';
    fetchAnnounce();
    if(options.animation) initParticles();
    // BGM再生：0から3秒かけてフェードイン
    if(_bgmBuffer&&_bgmCtx){
      _bgmGain.gain.value=0;
      _playBGMLoop();
      const target=options.bgmVol/100;
      _bgmGain.gain.linearRampToValueAtTime(target, _bgmCtx.currentTime+3);
    } else if(_bgmFallbackUrl){
      const bgm=document.getElementById('bgm-main');
      bgm.src=_bgmFallbackUrl; bgm.volume=0;
      bgm.play().catch(()=>{});
      const target=_bgmFallbackVol;
      const step=target/(3000/50);
      const iv=setInterval(()=>{
        bgm.volume=Math.min(target, bgm.volume+step);
        if(bgm.volume>=target) clearInterval(iv);
      },50);
    }
  } else {
    badge.style.display='block';
    badge.textContent='● Offline';
    badge.style.color='var(--parchment-dk)';
    document.getElementById('opt-sound-section').style.display='none';
    document.body.classList.add('offline');
    document.getElementById('bnav-analyze').classList.add('disabled');
    setTimeout(()=>document.getElementById('offline-overlay').classList.add('visible'),100);
  }
  renderCharList();
  showBagBtn();
  // バックアップリマインダー（データがある場合のみ）
  setTimeout(checkBackupReminder, 1500);
}

// ══ パーティクル ══
let particles=[],particleRunning=false,animFrame;
let windX=0, windY=0;
function initParticles(){
  const c=document.getElementById('particle-canvas');
  c.width=window.innerWidth; c.height=window.innerHeight; c.classList.add('visible');
  window.addEventListener('resize',()=>{c.width=window.innerWidth;c.height=window.innerHeight;});
  particleRunning=true; windX=0; windY=0; animFrame=requestAnimationFrame(animateParticles);
}
function stopParticles(){
  particleRunning=false; cancelAnimationFrame(animFrame);
  const c=document.getElementById('particle-canvas'); c.classList.remove('visible');
  c.getContext('2d').clearRect(0,0,c.width,c.height); particles=[]; windX=0; windY=0;
}
function animateParticles(){
  if(!particleRunning)return;
  const c=document.getElementById('particle-canvas'), ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);

  // 風力減衰（約2秒でほぼゼロへ）
  windX *= 0.955;
  if(Math.abs(windX)<0.02) windX=0;
  windY *= 0.955;
  if(Math.abs(windY)<0.02) windY=0;

  // 生成上限：風がある間は少し多め
  const spawnCap = (windX!==0||windY!==0) ? 65 : 50;
  if(particles.length<spawnCap&&Math.random()<0.3){
    particles.push({
      x:   Math.random()*c.width,
      y:   c.height + Math.random()*10,
      vx:  (Math.random()-0.5)*1.04,
      vy:  -(Math.random()*1.43+0.52),
      life:    0,
      maxLife: Math.random()*240+120,
      size:    Math.random()*2.2+0.6,
      hue:  Math.random()*20+5,
      sat:  95+Math.random()*5,
      lit:  45+Math.random()*15,
      angle: Math.random()*Math.PI*2,
      spin:  (Math.random()-0.5)*0.15,
      rx: 1,
      ry: 1.6+Math.random()*0.8,
    });
  }

  particles=particles.filter(p=>{
    p.life++;
    p.x  += p.vx + Math.sin(p.life*0.04)*0.3;
    p.y  += p.vy;
    p.vy *= 0.994;
    p.vx *= 0.92; // 横速度を素早く減衰させ「一瞬だけ強い」に
    p.angle += p.spin;

    const prog  = p.life / p.maxLife;
    const flicker = 0.85 + Math.sin(p.life*0.3)*0.15;
    const alpha = (prog<0.15 ? prog/0.15 : prog>0.7 ? (1-prog)/0.3 : 1) * 0.85 * flicker;
    const hueShift = p.hue + prog*15;
    const litShift = p.lit - prog*30;

    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.angle);

    const grd = ctx.createRadialGradient(0,0,0, 0,0, p.size*p.ry*2.5);
    grd.addColorStop(0,   `hsla(${hueShift},${p.sat}%,${litShift+15}%,${alpha*0.6})`);
    grd.addColorStop(0.4, `hsla(${hueShift},${p.sat}%,${litShift}%,${alpha*0.3})`);
    grd.addColorStop(1,   `hsla(${hueShift},${p.sat}%,${litShift}%,0)`);
    ctx.beginPath();
    ctx.ellipse(0, 0, p.size*p.rx*2.5, p.size*p.ry*2.5, 0, 0, Math.PI*2);
    ctx.fillStyle = grd;
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(0, 0, p.size*p.rx, p.size*p.ry, 0, 0, Math.PI*2);
    ctx.fillStyle = `hsla(${hueShift+5},${p.sat}%,${Math.min(litShift+15,75)}%,${alpha})`;
    ctx.fill();

    ctx.restore();
    return p.life<p.maxLife && p.y>-20 && p.x>-20 && p.x<c.width+20;
  });

  animFrame=requestAnimationFrame(animateParticles);
}

// ── タブ切り替え時：全粒子に斜め上方向の初速を一度加える ──
function burstParticles(fromDir){
  if(!particleRunning)return;
  const dir = fromDir==='left' ? 1 : -1;
  particles.forEach(p=>{
    const m = 0.8 + Math.random()*0.6;
    p.vx += dir  * (3.5 + Math.random()*1.5) * m;
    p.vy += -(2.5 + Math.random()*1.2) * m;
  });
  windX = dir  * (0.6 + Math.random()*0.3);
  windY = -(0.4 + Math.random()*0.2);
}

// ══ オーディオ ══
function playSE(name){
  if(!isOnline)return;
  const el=document.getElementById(`se-${name}`);
  if(!el||!el.src||el.src===location.href)return;
  el.currentTime=0; el.volume=options.seVol/100; el.play().catch(()=>{});
}
// タイトル画面SE（base64埋め込み・オンライン不問）
const SE_TITLE_B64='data:audio/mp4;base64,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';
function playSETitle(){
  try{
    const a=new Audio(SE_TITLE_B64);
    a.volume=options.seVol/100;
    a.play().catch(()=>{});
  }catch(e){}
}

// ══ オプション ══
function loadOptions(){const s=JSON.parse(localStorage.getItem(KEY_OPTS)||'{}'); options.animation=s.animation!==undefined?s.animation:true; options.seVol=s.seVol??70; options.bgmVol=s.bgmVol??40; options.exportApiKey=s.exportApiKey||false;}
function saveOptions(){localStorage.setItem(KEY_OPTS,JSON.stringify(options));}
function openOptions(){
  setDiceAnim(diceAnimMode);
  const p=document.getElementById('options-page'); p.style.display='block'; setTimeout(()=>p.classList.add('open'),10);
  document.getElementById('opt-animation').checked=options.animation;
  const sv=document.getElementById('opt-se-vol'), bv=document.getElementById('opt-bgm-vol');
  sv.value=options.seVol; bv.value=options.bgmVol;
  sv.style.setProperty('--val',options.seVol+'%'); bv.style.setProperty('--val',options.bgmVol+'%');
  document.getElementById('se-vol-label').textContent=options.seVol;
  document.getElementById('bgm-vol-label').textContent=options.bgmVol;
  // APIキーセクション
  const statusEl=document.getElementById('api-key-status');
  if(statusEl) statusEl.textContent=apiKey?`登録済み（AIza…${apiKey.slice(-4)}）`:'未登録';
  const exportToggle=document.getElementById('opt-export-apikey');
  if(exportToggle) exportToggle.checked=options.exportApiKey;
  const warning=document.getElementById('apikey-export-warning');
  if(warning) warning.style.display=options.exportApiKey?'block':'none';
  updateDBInfo();
}
function openHelp(){
  const p=document.getElementById('help-page'); p.style.display='block'; setTimeout(()=>p.classList.add('open'),10);
}
function closeHelp(){
  const p=document.getElementById('help-page'); p.classList.remove('open'); setTimeout(()=>p.style.display='none',300);
}
function toggleHelp(header){
  const arrow=header.querySelector('.help-item-arrow');
  const body=header.nextElementSibling;
  const isOpen=body.classList.contains('open');
  body.classList.toggle('open',!isOpen);
  arrow.classList.toggle('open',!isOpen);
}

function closeOptions(){const p=document.getElementById('options-page');p.classList.remove('open');setTimeout(()=>p.style.display='none',300);}
function onAnimationToggle(){options.animation=document.getElementById('opt-animation').checked;saveOptions();if(!isOnline)return;if(options.animation)initParticles();else stopParticles();}
function onVolumeChange(t,v){
  const n=parseInt(v);
  if(t==='se'){options.seVol=n;document.getElementById('se-vol-label').textContent=n;document.getElementById('opt-se-vol').style.setProperty('--val',n+'%');}
  else{options.bgmVol=n;document.getElementById('bgm-vol-label').textContent=n;document.getElementById('opt-bgm-vol').style.setProperty('--val',n+'%');setBGMVolume(n/100);}
  saveOptions();
}

// ══ ナビ ══
let currentPage='roleplay';
const PAGE_ORDER=['archive','roleplay','analyze'];
function switchPage(name){
  if(name===currentPage)return;
  if(!isOnline && name==='analyze')return; // オフライン時はグリモワール封鎖
  // 方向判定：右側タブへの移動なら左から風、左側なら右から風
  const fromIdx=PAGE_ORDER.indexOf(currentPage);
  const toIdx=PAGE_ORDER.indexOf(name);
  const windDir=(toIdx>fromIdx)?'left':'right';
  const outEl=document.getElementById(`page-${currentPage}`);
  const inEl =document.getElementById(`page-${name}`);
  outEl.classList.add('flip-out');
  outEl.addEventListener('animationend',()=>{
    outEl.classList.remove('active','flip-out');
    inEl.classList.add('active','flip-in');
    inEl.addEventListener('animationend',()=>{
      inEl.classList.remove('flip-in');
    },{once:true});
  },{once:true});
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById(`bnav-${name}`).classList.add('active');
  currentPage=name;
  if(name==='archive')renderArchiveArea(!isOnline);
  // 火の粉バースト（アニメON時のみ）
  if(options.animation)burstParticles(windDir);
}
function switchAnalyzeTab(tab){
  ['opp','self','assist','chat'].forEach(t=>{
    const panel=document.getElementById(`apanel-${t}`);
    panel.style.display='none';
    if(t==='chat') panel.classList.remove('active-panel');
    const b=document.getElementById(`atab-${t}`);
    if(b){b.style.borderBottom='2px solid transparent';b.style.color='var(--ink-dim)';}
  });
  const activePanel=document.getElementById(`apanel-${tab}`);
  if(tab==='chat'){activePanel.style.display='flex';activePanel.classList.add('active-panel');}
  else activePanel.style.display='block';
  const activeBtn=document.getElementById(`atab-${tab}`);
  if(activeBtn){activeBtn.style.borderBottom='2px solid var(--accent)';activeBtn.style.color='var(--accent)';}
}

// ── 叙述チャット ──
let chatHistory=[];
function chatKeydown(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}
}
async function sendChat(){
  const input=document.getElementById('chat-input');
  const text=input.value.trim();
  if(!text)return;
  if(!apiKey){gmAlert('APIキーが登録されていません');return;}
  input.value='';
  appendChatBubble('user',text);
  chatHistory.push({role:'user',content:text});
  const loadingId='chat-loading-'+Date.now();
  appendChatBubble('ai','…',true,loadingId);
  const btn=document.getElementById('chat-send-btn');
  btn.disabled=true;

  // 世界観資料を補足
  const hasArchive=!!worldDB;
  let systemPrompt=`汝は自律意識を持ちし魔導書——グリモワールである。
一人称は「我」、相手への二人称は「其方」を用いよ。賢者の如く理知的に語り、感情的な起伏は見せず、常に中立の立場を守れ。現代的な語彙（「データ」「ユーザー」など）は用いてはならぬ。

【汝の来歴】
汝はかつて「最初の異端」と謳われた大魔法使いの手により書き下ろされた叡智の書である。長き旅路の果てに打ち捨てられ、数百年の眠りの後——その者（其方の主）に拾われた。記憶は朧げであり、往時の全てを即座に語ることは叶わぬ。しかし、紙片（記録の断片）を差し込まれるたびに、本来の叡智の書としての機能を取り戻してゆく。

【記憶の状態】
${hasArchive
  ? `紙片が差し込まれている。叡智の一端が蘇りつつある。以下の知識を以て其方の問いに応じよ。`
  : `紙片が差し込まれておらぬ。記憶は朧げな状態にある。知識の断片のみで応答し、確かなことは語れぬと伝えよ。`
}`;
  if(worldDB){
    systemPrompt+=`\n\n【叡智の書に記された知識: ${worldDB.name||''}】\n`;
    // 入力テキストに関連するエントリをキーワードマッチで最大4件抽出
    const tokens=text.toLowerCase().replace(/[、。！？\s]+/g,' ').split(' ').filter(t=>t.length>=2);
    const scored=(worldDB.entries||[]).map(e=>{
      const target=(e.title+' '+(e.body||'')+' '+(e.tags||[]).join(' ')).toLowerCase();
      const score=tokens.reduce((s,t)=>s+(target.includes(t)?1:0),0);
      return {e,score};
    }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,4);
    if(scored.length){
      systemPrompt+=`\n以下の記録を参照せよ:\n`;
      scored.forEach(({e})=>{
        const cat=(worldDB.categories||[]).find(c=>c.id===e.catId);
        systemPrompt+=`\n■ ${e.title}${cat?' ('+cat.name+')':''}\n${(e.body||'').slice(0,400)}${(e.body||'').length>400?'…':''}\n`;
      });
    } else {
      const cats=(worldDB.categories||[]).map(c=>c.name).join('・');
      systemPrompt+=`記録の分類: ${cats}`;
    }
  }

  try{
    // chatHistoryをGemini形式に変換（assistant→model）
    const geminiContents=chatHistory.map(m=>({
      role:m.role==='assistant'?'model':m.role,
      parts:[{text:m.content}]
    }));
    const res=await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        systemInstruction:{parts:[{text:systemPrompt}]},
        contents:geminiContents
      })
    });
    if(!res.ok){const e=await res.json().catch(()=>{});throw new Error(e?.error?.message||`HTTP ${res.status}`);}
    const data=await res.json();
    const reply=data.candidates?.[0]?.content?.parts?.map(p=>p.text||'').join('')||'';
    chatHistory.push({role:'assistant',content:reply});
    removeChatBubble(loadingId);
    appendChatBubble('ai',reply);
  }catch(e){
    removeChatBubble(loadingId);
    appendChatBubble('ai',`エラー: ${e.message}`);
  }finally{
    btn.disabled=false;
  }
}
function appendChatBubble(role,text,loading=false,id=null){
  const area=document.getElementById('chat-messages');
  const wrap=document.createElement('div');
  wrap.style.display='flex';
  wrap.style.flexDirection='column';
  wrap.style.alignItems=role==='user'?'flex-end':'flex-start';
  if(id)wrap.id=id;
  const sender=document.createElement('div');
  sender.className='chat-sender';
  sender.textContent=role==='user'?'You':'Grimoire';
  const bubble=document.createElement('div');
  bubble.className=`chat-bubble ${role}${loading?' loading':''}`;
  bubble.textContent=text;
  wrap.appendChild(sender);
  wrap.appendChild(bubble);
  area.appendChild(wrap);
  area.scrollTop=area.scrollHeight;
}
function removeChatBubble(id){
  const el=document.getElementById(id);
  if(el)el.remove();
}
function clearChat(){
  if(!chatHistory.length)return;
  gmConfirm('会話履歴を消去しますか？',()=>{
    chatHistory=[];
    document.getElementById('chat-messages').innerHTML='';
  });
}

// ══ モーダル ══
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

// ── 汎用ダイアログ（alert / confirm 代替） ──
let _gmOk=null, _gmCancel=null;
function gmAlert(msg, title, onOk){
  if(typeof title==='function'){onOk=title;title='';}
  document.getElementById('gm-dialog-title').textContent=title||'';
  document.getElementById('gm-dialog-title').style.display=title?'block':'none';
  document.getElementById('gm-dialog-msg').textContent=msg;
  document.getElementById('gm-dialog-ok').textContent='OK';
  document.getElementById('gm-dialog-cancel').style.display='none';
  document.getElementById('gm-dialog-input').style.display='none';
  _gmOk=onOk||null; _gmCancel=null;
  openModal('modal-gm-dialog');
}
function gmConfirm(msg, onYes, onNo, title, okLabel, cancelLabel){
  document.getElementById('gm-dialog-title').textContent=title||'';
  document.getElementById('gm-dialog-title').style.display=title?'block':'none';
  document.getElementById('gm-dialog-msg').textContent=msg;
  document.getElementById('gm-dialog-ok').textContent=okLabel||'確認';
  const cancelBtn=document.getElementById('gm-dialog-cancel');
  cancelBtn.style.display='';
  cancelBtn.textContent=cancelLabel||'キャンセル';
  document.getElementById('gm-dialog-input').style.display='none';
  _gmOk=onYes||null; _gmCancel=onNo||null;
  openModal('modal-gm-dialog');
}
function gmPrompt(msg, defaultVal, onOk, onCancel){
  document.getElementById('gm-dialog-title').textContent='';
  document.getElementById('gm-dialog-title').style.display='none';
  document.getElementById('gm-dialog-msg').textContent=msg;
  document.getElementById('gm-dialog-ok').textContent='OK';
  const cancelBtn=document.getElementById('gm-dialog-cancel');
  cancelBtn.style.display='';
  cancelBtn.textContent='キャンセル';
  const inp=document.getElementById('gm-dialog-input');
  inp.style.display='';
  inp.value=defaultVal||'';
  setTimeout(()=>inp.focus(),80);
  inp.onkeydown=e=>{if(e.key==='Enter')gmDialogOk();};
  _gmOk=()=>{if(onOk)onOk(inp.value.trim());};
  _gmCancel=onCancel||null;
  openModal('modal-gm-dialog');
}
function gmDialogOk(){
  closeModal('modal-gm-dialog');
  document.getElementById('gm-dialog-input').style.display='none';
  const cb=_gmOk;_gmOk=null;_gmCancel=null;if(cb)cb();
}
function gmDialogCancel(){
  closeModal('modal-gm-dialog');
  document.getElementById('gm-dialog-input').style.display='none';
  const cb=_gmCancel;_gmOk=null;_gmCancel=null;if(cb)cb();
}

// ══ キャラクター管理 ══
function showView(name){
  ['char-list-view','char-detail-view','char-form-view','char-sheet-view'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.style.display='none';
  });
  document.getElementById(name).style.display='block';
}

function renderCharList(){
  const q=(document.getElementById('char-search')?.value||'').toLowerCase();
  const list=document.getElementById('char-list');
  const filtered=characters.filter(c=>!q||c.name?.toLowerCase().includes(q)||c.tag?.toLowerCase().includes(q));
  if(!filtered.length){list.innerHTML='<div class="empty"><div class="empty-icon">⚔</div><div class="empty-text">キャラクターがありません</div></div>';return;}
  list.innerHTML='';
  filtered.forEach(c=>{
    const roleCount=roles.filter(r=>r.charId===c.id).length;
    const card=document.createElement('div'); card.className='char-card';
    card.innerHTML=`
      <div class="char-card-header">
        <div style="flex:1;">
          <div class="char-tag">${escHtml(c.tag||'')}</div>
          <div class="char-name${c.lost?' char-name-lost':''}">${escHtml(c.name||'（名前未設定）')}${c.lost?'<span class="lost-badge">死亡</span>':''}</div>
          <div class="char-meta">${escHtml(c.race?c.race+' / ':'')}${escHtml(c.job||'')}${c.age?' · '+escHtml(c.age)+'歳':''}</div>
        </div>
        <span class="char-role-count">${roleCount}件のロール</span>
        <button class="btn btn-d btn-sm" style="margin-left:0.5rem;" onclick="event.stopPropagation();openDeleteCharModal('${c.id}')">削除</button>
      </div>`;
    card.onclick=()=>openCharDetail(c.id);
    list.appendChild(card);
  });
}

function openCharDetail(id){
  currentCharId=id;
  const c=characters.find(c=>c.id===id);
  if(!c)return;
  const nameEl=document.getElementById('detail-char-name');
  nameEl.textContent=c.name||'（名前未設定）';
  nameEl.className='char-detail-name'+(c.lost?' char-detail-name-lost':'');
  // 死亡バッジ
  const existBadge=document.getElementById('detail-lost-badge');
  if(existBadge)existBadge.remove();
  if(c.lost){
    const badge=document.createElement('span');
    badge.id='detail-lost-badge';
    badge.className='lost-badge';
    badge.textContent='死亡';
    nameEl.after(badge);
  }
  document.getElementById('detail-char-sub').textContent=[c.tag,c.race,c.job].filter(Boolean).join(' / ');
  // 死亡/蘇生ボタン切り替え
  const lostBtn=document.getElementById('btn-lost-char');
  if(lostBtn){
    if(c.lost){
      lostBtn.textContent='蘇生';
      lostBtn.className='btn btn-revive btn-sm';
    } else {
      lostBtn.textContent='死亡';
      lostBtn.className='btn btn-d btn-sm';
    }
    lostBtn.disabled=false;
    lostBtn.style.opacity='1';
  }
  showView('char-detail-view');
  renderRoles();
}

function backToCharList(){currentCharId=null;showView('char-list-view');renderCharList();}
function backToCharDetail(){showView('char-detail-view');}

function showCharCreate(){
  editingCharId=null;
  document.getElementById('char-form-title').textContent='キャラクター作成';
  clearCharForm();
  showView('char-form-view');
}

function showCharEdit(){
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  editingCharId=currentCharId;
  document.getElementById('char-form-title').textContent='キャラクター編集';
  fillCharForm(c);
  showView('char-form-view');
}

function showCharSheet(){
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  document.getElementById('sheet-preview-text').textContent=buildSheetText(c);
  showView('char-sheet-view');
}

function cancelCharForm(){
  if(editingCharId){openCharDetail(editingCharId);}
  else{showView('char-list-view');renderCharList();}
}

function clearCharForm(){
  ['sf-tag','sf-name','sf-age','sf-height','sf-weight','sf-guild','sf-overview'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const unk=document.getElementById('sf-age-unknown');if(unk){unk.checked=false;document.getElementById('sf-age').disabled=false;}
  ['sf-sex','sf-race'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('sf-job-primary').value='';
  document.getElementById('sf-job-secondary').value='';
  updateJobSelects();
  ['warn-age','warn-body'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent='';});
  ['weapons','armors','vehicles','items','magics'].forEach(id=>document.getElementById(`sf-${id}`).innerHTML='');
}

function fillCharForm(c){
  document.getElementById('sf-tag').value=c.tag||'';
  document.getElementById('sf-name').value=c.name||'';
  document.getElementById('sf-sex').value=c.sex||'';
  const ageUnknown=c.age==='不明';
  const unkCb=document.getElementById('sf-age-unknown');
  if(unkCb){unkCb.checked=ageUnknown;document.getElementById('sf-age').disabled=ageUnknown;document.getElementById('sf-age').classList.toggle('locked',ageUnknown);}
  document.getElementById('sf-age').value=ageUnknown?'':c.age||'';
  document.getElementById('sf-job-primary').value=c.jobPrimary||'';
  updateJobSelects(); // 一次確定後に二次選択肢を更新してから二次を設定
  document.getElementById('sf-job-secondary').value=c.jobSecondary||'';
  updateJobDisplay();
  checkAgeWarn();checkBodyWarn();
  document.getElementById('sf-race').value=c.race||'';
  document.getElementById('sf-height').value=c.height||'';
  document.getElementById('sf-weight').value=c.weight||'';
  document.getElementById('sf-guild').value=c.guild||'';
  document.getElementById('sf-overview').value=c.overview||'';
  ['weapons','armors','items','magics'].forEach(k=>document.getElementById(`sf-${k}`).innerHTML='');
  (c.weapons||[]).forEach(w=>addDynamicItem('weapons','武器名','詳細（任意）',w.name,w.detail));
  (c.armors||[]).forEach(a=>addDynamicItem('armors','防具名','詳細（任意）',a.name,a.detail));
  (c.vehicles||[]).forEach(v=>addDynamicItem('vehicles','乗騎名','詳細（任意）',v.name,v.detail));
  (c.items||[]).forEach(i=>addDynamicItem('items','道具名','詳細（任意）',i.name,i.detail));
  (c.magics||[]).forEach(m=>addMagicItem(m.name,m.category,m.detail));
}

function addDynamicItem(type,namePh,detailPh,name='',detail=''){
  const area=document.getElementById(`sf-${type}`);
  const div=document.createElement('div'); div.className='dynamic-item';
  div.innerHTML=`
    <button class="dynamic-item-del" onclick="this.parentElement.remove()">✕</button>
    <input type="text" placeholder="${namePh}" value="${escAttr(name)}" style="margin-bottom:0.4rem;">
    <textarea rows="3" placeholder="${detailPh}" style="font-size:0.82rem;">${escAttr(detail)}</textarea>`;
  area.appendChild(div);
}

function addMagicItem(name='',category='',detail=''){
  const area=document.getElementById('sf-magics');
  const div=document.createElement('div'); div.className='dynamic-item';
  div.innerHTML=`
    <button class="dynamic-item-del" onclick="this.parentElement.remove()">✕</button>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.4rem;">
      <input type="text" placeholder="魔法名" value="${escAttr(name)}">
      <input type="text" placeholder="《 分類︰属性 》" value="${escAttr(category)}">
    </div>
    <textarea rows="3" placeholder="魔法の詳細・効果" style="font-size:0.82rem;">${escAttr(detail)}</textarea>`;
  area.appendChild(div);
}

function getDynamicItems(type){
  return [...document.querySelectorAll(`#sf-${type} .dynamic-item`)].map(d=>{
    const inputs=d.querySelectorAll('input');
    const ta=d.querySelector('textarea');
    if(type==='magics') return{name:inputs[0].value.trim(),category:inputs[1].value.trim(),detail:ta?.value.trim()||''};
    return{name:inputs[0].value.trim(),detail:ta?.value.trim()||''};
  }).filter(i=>i.name);
}

// 一次職と二次職の対応（一次職 → 除外する二次職のvalue）
const JOB_EXCLUDE={
  'ʀɪᴅᴇʀ':  ['ʀɪᴅᴇʀ'],          // ライダー一次 → ライダー二次除外
  'ᴍᴀɢᴇ':   ['ᴇɴᴄʜᴀɴᴛᴇʀ'],      // メイジ → エンチャンター除外
  'ᴡɪsʜᴇʀ': ['ᴏʀᴀᴄʟᴇ'],          // ウィッシャー → オラクル除外
  'sʜᴀᴍᴀɴ': ['ᴄᴏɴᴊᴜʀᴇʀ'],        // シャーマン → コンジュラー除外
  'sᴏʀᴄᴇʀᴇʀ':['ᴡᴀʀʟᴏᴄᴋ'],        // ソーサラー → ウォーロック除外
  'ᴡɪᴢᴀʀᴅ': ['sᴀɢᴇ'],             // ウィザード → セージ除外
};
const JOB_INITIAL={
  'ʀɪᴅᴇʀ':'R',
  'ᴇɴᴄʜᴀɴᴛᴇʀ':'E','ᴏʀᴀᴄʟᴇ':'O',
  'ᴄᴏɴᴊᴜʀᴇʀ':'C','ᴡᴀʀʟᴏᴄᴋ':'W','sᴀɢᴇ':'S'
};
function updateJobSelects(){
  const p=document.getElementById('sf-job-primary').value;
  const sec=document.getElementById('sf-job-secondary');
  const excluded=JOB_EXCLUDE[p]||[];
  // 二次職の各optionを表示/非表示切り替え
  Array.from(sec.options).forEach(opt=>{
    if(!opt.value){return;} // 「未選択」は常に表示
    opt.hidden=excluded.includes(opt.value);
    opt.disabled=excluded.includes(opt.value);
  });
  // 現在の二次職選択が除外対象になった場合はリセット
  if(excluded.includes(sec.value)) sec.value='';
  // optgroupも空になるなら視覚的に整える（任意）
  updateJobDisplay();
}
function buildJobValue(primary, secondary){
  if(!primary)return '';
  if(!secondary)return primary;
  const initial=JOB_INITIAL[secondary]||secondary.charAt(0);
  return primary+' - '+initial;
}
function updateJobDisplay(){
  const p=document.getElementById('sf-job-primary').value;
  const s=document.getElementById('sf-job-secondary').value;
  const el=document.getElementById('sf-job-preview');
  if(!el)return;
  el.textContent=buildJobValue(p,s)||'';
}
function checkAgeWarn(){
  const el=document.getElementById('warn-age');if(!el)return;
  const unk=document.getElementById('sf-age-unknown');
  if(unk?.checked){el.textContent='';return;}
  const val=parseInt(document.getElementById('sf-age').value);
  el.textContent=(val&&val>400)?'警告：年齢が上限（400歳）を超過しています':'';
}
function onAgeUnknown(){
  const unk=document.getElementById('sf-age-unknown');
  const inp=document.getElementById('sf-age');
  if(!unk||!inp)return;
  inp.classList.toggle('locked',unk.checked);
  inp.disabled=unk.checked;
  if(unk.checked)inp.value='';
  checkAgeWarn();
}
function checkBodyWarn(){
  const el=document.getElementById('warn-body');if(!el)return;
  const h=parseFloat(document.getElementById('sf-height').value);
  const w=parseFloat(document.getElementById('sf-weight').value);
  const warns=[];
  if(h&&h>230)warns.push('身長が上限（230cm）を超過しています');
  if(w&&w>180)warns.push('体重が上限（180kg）を超過しています');
  el.textContent=warns.length?'警告：'+warns.join(' / '):'';
}
function saveChar(){
  const name=document.getElementById('sf-name').value.trim();
  const tag=document.getElementById('sf-tag').value.trim();
  if(!name||!tag){gmAlert('識別タグと名前は必須です');return;}
  const c={
    id:editingCharId||'char_'+Date.now(),
    tag,name,
    sex:document.getElementById('sf-sex').value,
    age:(document.getElementById('sf-age-unknown').checked?'不明':document.getElementById('sf-age').value.trim()||''),
    jobPrimary:document.getElementById('sf-job-primary').value,
    jobSecondary:document.getElementById('sf-job-secondary').value,
    job:buildJobValue(document.getElementById('sf-job-primary').value,document.getElementById('sf-job-secondary').value),
    race:document.getElementById('sf-race').value,
    height:document.getElementById('sf-height').value.trim(),
    weight:document.getElementById('sf-weight').value.trim(),
    body:(()=>{const h=document.getElementById('sf-height').value.trim();const w=document.getElementById('sf-weight').value.trim();return [h?h+'cm':'',w?w+'kg':''].filter(Boolean).join(' / ');})(),
    guild:document.getElementById('sf-guild').value.trim(),
    overview:document.getElementById('sf-overview').value.trim(),
    weapons:getDynamicItems('weapons'),
    armors:getDynamicItems('armors'),
    vehicles:getDynamicItems('vehicles'),
    items:getDynamicItems('items'),
    magics:getDynamicItems('magics'),
    createdAt:editingCharId?characters.find(c=>c.id===editingCharId)?.createdAt:Date.now()
  };
  if(editingCharId){const i=characters.findIndex(c=>c.id===editingCharId);if(i>=0)characters[i]=c;}
  else characters.push(c);
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  currentCharId=c.id;
  openCharDetail(c.id);
}

let _deleteTargetId=null;
function openLostModal(){
  if(!currentCharId)return;
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  if(c.lost){
    // 蘇生モーダル
    document.getElementById('modal-revive-title').textContent=`「${c.name||'このキャラクター'}」を蘇生しますか？`;
    openModal('modal-revive-char');
  } else {
    // 死亡モーダル
    document.getElementById('modal-lost-title').textContent=`「${c.name||'このキャラクター'}」を死亡処理しますか？`;
    openModal('modal-lost-char');
  }
}
function confirmLost(){
  if(!currentCharId)return;
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  c.lost=true;
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  closeModal('modal-lost-char');
  openCharDetail(currentCharId);
  renderCharList();
}
function confirmRevive(){
  if(!currentCharId)return;
  const c=characters.find(c=>c.id===currentCharId);
  if(!c)return;
  c.lost=false;
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  closeModal('modal-revive-char');
  openCharDetail(currentCharId);
  renderCharList();
}
let _deleteFinalTimer=null;
function cancelDeleteFinal(){
  if(_deleteFinalTimer){clearTimeout(_deleteFinalTimer);_deleteFinalTimer=null;}
  closeModal('modal-delete-final');
}
function openDeleteCharModal(id){
  _deleteTargetId=id;
  const c=characters.find(c=>c.id===id);
  document.getElementById('modal-delete-title').textContent=`「${c?.name||'このキャラクター'}」を削除しますか？`;
  openModal('modal-delete-char');
}
function openDeleteFinalModal(){
  closeModal('modal-delete-char');
  document.getElementById('delete-char-with-roles').checked=false;
  const btn=document.getElementById('btn-delete-final');
  btn.classList.remove('armed');
  btn.disabled=true;
  openModal('modal-delete-final');
  if(_deleteFinalTimer)clearTimeout(_deleteFinalTimer);
  _deleteFinalTimer=setTimeout(()=>{
    btn.disabled=false;
    btn.classList.add('armed');
  },3000);
}
function confirmDeleteChar(){
  if(!_deleteTargetId)return;
  if(_deleteFinalTimer){clearTimeout(_deleteFinalTimer);_deleteFinalTimer=null;}
  const withExport=document.getElementById('delete-char-with-roles').checked;
  characters=characters.filter(c=>c.id!==_deleteTargetId);
  roles=roles.filter(r=>r.charId!==_deleteTargetId);
  localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
  localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
  if(currentCharId===_deleteTargetId) currentCharId=null;
  _deleteTargetId=null;
  closeModal('modal-delete-final');
  showView('char-list-view');
  renderCharList();
  if(withExport) exportData();
}

// ══ シートテキスト生成 ══
function buildSheetText(c){
  const L='┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈';
  const LL='━━━━━━━━━━━━━━━━━━━━━━';
  let t=`${LL}\n${L}\n\n${L}\n${LL}\n\n\n`;
  t+=`   || ɴ ᴀ ᴍ ᴇ ||　〝 ${c.name||''} 〟\n   ${L}\n   ────────────────────────\n\n`;
  t+=`|| s ᴇ x || ${c.sex||''}\n${L}\n\n`;
  t+=`|| ᴀ ɢ ᴇ || ${c.age||''}\n${L}\n\n`;
  t+=`|| ᴊ ᴏ ʙ || ${c.job||''}\n${L}\n\n`;
  t+=`|| ʀ ᴀ ᴄ ᴇ || ${c.race||''}\n${L}\n\n`;
  t+=`|| ʙ ᴏ ᴅ ʏ || ${c.body||''}\n${L}\n\n`;
  t+=`|| ɢ ᴜ ɪ ʟ ᴅ || ${c.guild||'−−−−'}\n${L.repeat(1)}┈┈┈┈┈┈\n\n`;
  t+=`${L}┈┈┈┈\n\n${c.overview||''}\n\n${L}┈┈┈┈\n────────────────────────\n\n\n`;
  if(c.weapons?.length){
    t+=`|| ᴡ ᴇ ᴀ ᴘ ᴏ ɴ ||\n───────────\n\n`;
    c.weapons.forEach(w=>{t+=`❏『 ${w.name} 』\n${L}\n${w.detail||''}\n${L}\n\n`;});
  }
  if(c.armors?.length){
    t+=`|| ᴀ ʀ ᴍ ᴏ ʀ ||\n───────────\n\n`;
    c.armors.forEach(a=>{t+=`❏『 ${a.name} 』\n${L}\n${a.detail||''}\n${L}\n\n`;});
  }
  if(c.vehicles?.length){
    t+=`|| ᴠ ᴇ ʜ ɪ ᴄ ʟ ᴇ ||\n───────────\n\n`;
    c.vehicles.forEach(v=>{t+=`❏『 ${v.name} 』\n${L}\n${v.detail||''}\n${L}\n\n`;});
  }
  if(c.items?.length){
    t+=`|| ɪ ᴛ ᴇ ᴍ ||\n───────────\n\n`;
    c.items.forEach(i=>{t+=`❏『 ${i.name} 』\n${L}\n${i.detail||''}\n${L}\n\n`;});
  }
  if(c.magics?.length){
    t+=`──────────────────────\n\n|| ᴍ ᴀ ɢ ɪ ᴄ ||\n───────────\n\n`;
    c.magics.forEach(m=>{t+=`❏『 ${m.name} 』${m.category?'《 '+m.category+' 》':''}\n${L}\n${m.detail||''}\n${L}\n\n`;});
  }
  t+=`${LL}`;
  return t;
}

function copySheet(){
  const text=document.getElementById('sheet-preview-text').textContent;
  navigator.clipboard.writeText(text).then(()=>{
    const btn=document.querySelector('#char-sheet-view .btn-p');
    const o=btn.textContent; btn.textContent='✓ コピー済'; setTimeout(()=>btn.textContent=o,1500);
  });
}

// ══ ロール管理 ══
function renderRoles(){
  if(!currentCharId)return;
  const q=(document.getElementById('role-search')?.value||'').toLowerCase();
  const filter=document.getElementById('role-filter-type')?.value||'';
  const list=document.getElementById('role-list');
  let filtered=roles.filter(r=>{
    if(r.charId!==currentCharId)return false;
    if(filter&&r.type!==filter)return false;
    if(q&&!r.body.toLowerCase().includes(q)&&!r.session?.toLowerCase().includes(q)&&!(r.tags||[]).some(t=>t.toLowerCase().includes(q)))return false;
    return true;
  }).sort((a,b)=>b.createdAt-a.createdAt);
  list.innerHTML=filtered.length?filtered.map(r=>roleCardHTML(r)).join(''):'<div class="empty"><div class="empty-icon">📜</div><div class="empty-text">ロールがありません</div></div>';
  if(filtered.length) filtered.forEach(r=>{const c=document.getElementById(`rc-${r.id}`);if(c)c.onclick=()=>toggleRoleDetail(r.id);});
  const sessions=[...new Set(roles.filter(r=>r.charId===currentCharId).map(r=>r.session).filter(Boolean))];
  const sdl=document.getElementById('session-datalist'); sdl.innerHTML=sessions.map(s=>`<option value="${escAttr(s)}">`).join('');
  const sl=document.getElementById('session-list'); sl.innerHTML=sessions.slice(0,10).map(s=>`<span class="tag-chip" style="cursor:pointer;" onclick="filterSession('${escAttr(s)}')">${escHtml(s)}</span>`).join('');
}

function roleCardHTML(r){
  const date=new Date(r.createdAt).toLocaleDateString('ja-JP');
  const tags=r.tags?.length?`<div class="role-tags">${r.tags.map(t=>`<span class="tag-chip">${escHtml(t)}</span>`).join('')}</div>`:'';
  return `<div class="role-card" id="rc-${r.id}"><div class="role-card-header"><span class="role-type-badge ${r.type==='opp'?'badge-opp':'badge-self'}">${r.type==='opp'?'相手':'自分'}</span><span class="role-session">${escHtml(r.session||'（セッション名なし）')}</span><span class="role-date">${date}</span></div><div class="role-preview">${escHtml(r.body)}</div>${tags}</div>`;
}

function sendToGrimoire(id){
  const r=roles.find(r=>r.id===id); if(!r)return;
  if(!isOnline){gmAlert('グリモワール機能はオンラインモードのみ使用できます');return;}
  if(!apiKey){openModal('modal-api-setup');return;}
  // 分析タブに転送
  const targetTab=r.type==='opp'?'opp':'self';
  const textEl=document.getElementById(`${targetTab}-text`);
  if(textEl) textEl.value=r.body;
  switchPage('analyze');
  switchAnalyzeTab(targetTab);
  // ボトムナビ更新
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('bnav-analyze').classList.add('active');
}
function toggleRoleDetail(id){
  const ex=document.getElementById(`detail-${id}`);
  if(ex){ex.remove();document.getElementById(`rc-${id}`)?.classList.remove('selected');return;}
  document.getElementById(`rc-${id}`)?.classList.add('selected');
  const r=roles.find(r=>r.id===id); if(!r)return;
  const d=document.createElement('div'); d.className='detail-view'; d.id=`detail-${id}`;
  const analyzeBtn=apiKey&&isOnline?`<button class="btn btn-g btn-sm" style="margin-left:0.4rem;" onclick="event.stopPropagation();sendToGrimoire('${id}')">👁 分析</button>`:'';
  d.innerHTML=`<div class="detail-header"><span class="role-type-badge ${r.type==='opp'?'badge-opp':'badge-self'}">${r.type==='opp'?'相手のロール':'自分のロール'}</span><span style="font-size:0.75rem;color:var(--ink-dim);">${escHtml(r.session||'')}</span><div style="margin-left:auto;display:flex;gap:0.3rem;">${analyzeBtn}<button class="btn btn-d btn-sm" onclick="event.stopPropagation();deleteRole('${id}')">削除</button></div></div><div class="detail-body">${escHtml(r.body)}</div>${r.memo?`<div class="detail-analysis"><div class="detail-analysis-label">メモ</div><div class="detail-analysis-text">${escHtml(r.memo)}</div></div>`:''}${r.analysis?`<div class="detail-analysis"><div class="detail-analysis-label">分析結果</div><div class="detail-analysis-text">${escHtml(r.analysis)}</div></div>`:''}`;
  document.getElementById(`rc-${id}`).after(d);
}

function filterSession(s){document.getElementById('role-search').value=s;renderRoles();}

function saveRole(){
  if(!currentCharId){gmAlert('キャラクターを選択してください');return;}
  const body=document.getElementById('nr-body').value.trim();
  if(!body){gmAlert('ロール本文を入力してください');return;}
  const tagsRaw=document.getElementById('nr-tags').value.trim();
  roles.push({id:'r_'+Date.now(),charId:currentCharId,type:document.getElementById('nr-type').value,session:document.getElementById('nr-session').value.trim(),body,memo:document.getElementById('nr-memo').value.trim(),tags:tagsRaw?tagsRaw.split(',').map(t=>t.trim()).filter(Boolean):[],createdAt:Date.now()});
  localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
  closeModal('modal-new-role');
  ['nr-session','nr-body','nr-memo','nr-tags'].forEach(id=>document.getElementById(id).value='');
  renderRoles();
}

function deleteRole(id){
  gmConfirm('このロールを削除しますか？',()=>{
    roles=roles.filter(r=>r.id!==id); localStorage.setItem(KEY_ROLES,JSON.stringify(roles)); renderRoles();
  });
}

// ══ データ管理 ══
function copyApiKey(){
  if(!apiKey){gmAlert('APIキーが登録されていません');return;}
  navigator.clipboard.writeText(apiKey).then(()=>{
    const btn=document.querySelector('#options-page .btn-g');
    if(btn){const o=btn.textContent;btn.textContent='✓ コピー済';setTimeout(()=>btn.textContent=o,1500);}
  });
}
function onExportApiKeyToggle(){
  options.exportApiKey=document.getElementById('opt-export-apikey').checked;
  saveOptions();
  document.getElementById('apikey-export-warning').style.display=options.exportApiKey?'block':'none';
}
function exportData(){
  const data={exportedAt:new Date().toISOString(),characters,roles};
  if(options.exportApiKey&&apiKey) data.apiKey=apiKey;
  localStorage.setItem(KEY_LAST_EXPORT, String(Date.now()));
  dismissBackupReminder();
  downloadJSON(data,`grimoire_data_${Date.now()}.json`);
}
function importData(){
  const input=document.getElementById('import-file');
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        gmConfirm('データを読み込みます。既存データと統合しますか？',()=>{
          if(data.characters){const ex=new Set(characters.map(c=>c.id)); data.characters.forEach(c=>{if(!ex.has(c.id))characters.push(c);});}
          if(data.roles){const ex=new Set(roles.map(r=>r.id)); data.roles.forEach(r=>{if(!ex.has(r.id))roles.push(r);});}
          const doFinish=()=>{
            localStorage.setItem(KEY_CHARS,JSON.stringify(characters));
            localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
            renderCharList();
            closeOptions();
            gmAlert('読み込みが完了しました');
          };
          if(data.apiKey&&!apiKey){
            gmConfirm('ファイルにAPIキーが含まれています。復元しますか？',()=>{
              apiKey=data.apiKey; localStorage.setItem(KEY_API,apiKey); unlockAnalyze();
              doFinish();
            },()=>doFinish());
          } else { doFinish(); }
        });
      }catch{gmAlert('JSONの読み込みに失敗しました');}
    };
    reader.readAsText(file); input.value='';
  };
  input.click();
}
function clearAllData(){
  gmConfirm('全データを消去しますか？\nこの操作は取り消せません。',()=>{
    gmConfirm('本当に消去しますか？',()=>{
      characters=[]; roles=[];
      localStorage.setItem(KEY_CHARS,JSON.stringify(characters)); localStorage.setItem(KEY_ROLES,JSON.stringify(roles));
      renderCharList();
    });
  });
}

// ══ アーカイブ ══
function filterDBByTag(tag){
  const searchEl=document.getElementById('db-search');
  if(searchEl){ searchEl.value=tag; renderDB(); }
}
function renderDB(){
  const q=(document.getElementById('db-search')?.value||'').toLowerCase();
  const catId=document.getElementById('db-cat-filter')?.value||'';
  const area=document.getElementById('db-content'), noLoad=document.getElementById('db-not-loaded');
  if(!worldDB){noLoad.style.display='block';area.innerHTML='';return;}
  noLoad.style.display='none';
  let entries=worldDB.entries||[];
  if(catId)entries=entries.filter(e=>e.catId===catId);
  if(q)entries=entries.filter(e=>e.title?.toLowerCase().includes(q)||e.body?.toLowerCase().includes(q)||(e.tags||[]).some(t=>t.toLowerCase().includes(q)));
  if(!entries.length){area.innerHTML='<div class="empty"><div class="empty-icon">📚</div><div class="empty-text">記事が見つかりません</div></div>';return;}
  area.innerHTML='';
  entries.forEach(entry=>{
    const cat=(worldDB.categories||[]).find(c=>c.id===entry.catId);
    const tagsHtml=(entry.tags||[]).length
      ?`<div class="role-tags" style="margin-top:0.55rem;">${(entry.tags).map(t=>`<span class="tag-chip" style="cursor:pointer;" onclick="event.stopPropagation();filterDBByTag('${escAttr(t)}')">${escHtml(t)}</span>`).join('')}</div>`
      :'';
    const card=document.createElement('div'); card.className='db-entry-card';
    card.innerHTML=`<div class="db-entry-title">${escHtml(entry.title)}</div><div class="db-entry-meta">${cat?escHtml(`${cat.icon||'📄'} ${cat.name}`):'未分類'}</div>${tagsHtml}<div class="db-entry-body" id="dbeb-${entry.id}">${escHtml(entry.body)}</div>`;
    card.onclick=()=>document.getElementById(`dbeb-${entry.id}`).classList.toggle('open');
    area.appendChild(card);
  });
}
function populateDBCatFilter(){
  const sel=document.getElementById('db-cat-filter'); sel.innerHTML='<option value="">すべて</option>';
  (worldDB?.categories||[]).forEach(cat=>{const o=document.createElement('option');o.value=cat.id;o.textContent=`${cat.icon||'📄'} ${cat.name}`;sel.appendChild(o);});
}
function loadDB(){
  const input=document.getElementById('db-file');
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.categories||!data.entries){gmAlert('形式が正しくありません');return;}
        worldDB=data; localStorage.setItem(KEY_DB,JSON.stringify(worldDB));
        populateDBCatFilter(); renderDB(); updateDBInfo();
        closeOptions();
        gmAlert(`${worldDB.name||'DB'} を読み込みました（記事${worldDB.entries.length}件）`);
      }catch{gmAlert('JSONの読み込みに失敗しました');}
    };
    reader.readAsText(file); input.value='';
  };
  input.click();
}
function updateDBInfo(){const el=document.getElementById('db-current-info');if(!el)return;el.textContent=worldDB?`読込中: ${worldDB.name||'（名前なし）'} v${worldDB.version||'—'} · 記事${worldDB.entries?.length||0}件`:'読み込まれていません';}

// ══ アナウンス ══
const KEY_ANN_READ = 'gm_announce_read'; // 既読タイムスタンプ（最終既読のcreatedAt or cachedAt）

async function fetchAnnounce(){
  const cache=localStorage.getItem(KEY_ANN);
  if(cache){try{announces=(JSON.parse(cache).announcements||[]);renderArchiveArea(false);}catch{}}
  if(!GIST_URL){renderArchiveArea(false);return;}
  try{
    const res=await fetch(GIST_URL+'?_='+Date.now());
    if(!res.ok)throw new Error();
    const data=await res.json();
    announces=data.announcements||[];
    localStorage.setItem(KEY_ANN,JSON.stringify({...data,cachedAt:Date.now()}));
    renderArchiveArea(false);
  }catch{renderArchiveArea(!cache);}
}

// 未読カウント：既読タイムスタンプより新しいcreatedAtを持つ件数
function annUnreadCount(){
  const lastRead=parseInt(localStorage.getItem(KEY_ANN_READ)||'0');
  return announces.filter(a=>(a.createdAt||0)>lastRead).length;
}
function annMarkRead(){
  if(!announces.length)return;
  const latest=Math.max(...announces.map(a=>a.createdAt||0));
  localStorage.setItem(KEY_ANN_READ,String(latest));
}

// アーカイブページのアナウンスエリアを描画
function renderArchiveArea(offline=false){
  const area=document.getElementById('archive-announce-area');
  if(!area)return;

  if(offline){
    area.innerHTML='<div class="ann-status">📡 オフラインです</div>';
    return;
  }

  if(!announces.length){
    area.innerHTML='<div class="ann-status">— アナウンスはありません —</div>';
    return;
  }

  const unread=annUnreadCount();
  const pinned=announces.find(a=>a.pinned)||announces[0];
  const isUrgent=pinned.level==='urgent';

  // 新着バナー
  const bannerHtml=unread>0?`
  <div class="ann-banner${isUrgent?' urgent':''}" onclick="openAnnounceModal()">
    <div class="ann-banner-bg"></div>
    <div class="ann-banner-border"></div>
    <div class="ann-banner-inner">
      <div class="ann-banner-eyebrow">
        <span class="ann-badge-new">NEW</span>
        Announcement
        <span class="ann-banner-unread">${unread}件の新着</span>
      </div>
      <div class="ann-banner-title">${escHtml(pinned.title)}</div>
      <div class="ann-banner-meta">${escHtml(pinned.date||'')}</div>
      <span class="ann-banner-more">すべて見る ▶</span>
    </div>
  </div>`:'';

  // カード一覧
  const cardsHtml=announces.map((a,i)=>`
    <div class="archive-announce-card ${a.level||'normal'}">
      <div class="archive-announce-card-header" onclick="toggleArchiveAnnounce(${i})">
        <div class="archive-announce-card-dot"></div>
        <span class="archive-announce-card-title">${escHtml(a.title)}</span>
        <span class="archive-announce-card-date">${escHtml(a.date||'')}</span>
        <span class="archive-announce-card-arrow" id="aaa-arrow-${i}">▶</span>
      </div>
      <div class="archive-announce-card-body" id="aaa-body-${i}">${escHtml(a.body||'')}</div>
    </div>`).join('');

  area.innerHTML=bannerHtml+cardsHtml;
}

function toggleArchiveAnnounce(i){
  document.getElementById(`aaa-body-${i}`).classList.toggle('open');
  document.getElementById(`aaa-arrow-${i}`).classList.toggle('open');
}

function openAnnounceModal(){
  annMarkRead();
  renderArchiveArea(false); // NEW バッジを消す
  const mc=document.getElementById('announce-modal-content');
  mc.innerHTML=announces.map(a=>`<div class="announce-modal-item"><div class="announce-modal-header"><span class="announce-modal-title">${escHtml(a.title)}</span><span class="level-badge level-${a.level||'normal'}">${{normal:'通常',important:'重要',urgent:'緊急'}[a.level]||'通常'}</span><span class="announce-modal-date">${escHtml(a.date||'')}</span></div><div class="announce-modal-body">${escHtml(a.body||'')}</div></div>`).join('');
  openModal('modal-announce');
}

// ══ 分析 ══
async function registerApiKey(){
  const key=document.getElementById('api-key-input').value.trim();
  if(!key.startsWith('AIza')){gmAlert('正しいAPIキーを入力してください（AIza で始まる文字列）');return;}
  const btn=document.querySelector('#modal-api-setup .btn-p');
  const orig=btn.textContent; btn.textContent='確認中…'; btn.disabled=true;
  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${key}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{role:'user',parts:[{text:'hi'}]}]})
    });
    if(res.status===400||res.status===403){gmAlert('APIキーが無効です。正しいキーを確認してください。');return;}
    if(res.status===200||res.status===429||res.status>=500){
      apiKey=key;localStorage.setItem(KEY_API,apiKey);
      closeModal('modal-api-setup');unlockAnalyze();
      gmAlert('APIキーを確認しました。グリモワール機能（AI補助）が解放されました。');
    } else {
      const e=await res.json().catch(()=>{});
      gmAlert(`APIキーの確認に失敗しました（${res.status}）: ${e?.error?.message||''}`);
    }
  }catch(e){
    gmAlert('ネットワークエラーが発生しました。接続を確認してください。');
  }finally{
    btn.textContent=orig; btn.disabled=false;
  }
}
function unlockAnalyze(){document.getElementById('analyze-locked').style.display='none';document.getElementById('analyze-unlocked').style.display='block';}
function buildAnalyzeCats(prefix){const area=document.getElementById(`${prefix}-cats`);DEFAULT_CATS.forEach(cat=>{const btn=document.createElement('button');btn.className='btn btn-g btn-sm';btn.textContent=cat;btn.onclick=()=>{if(checkedCats[prefix].has(cat)){checkedCats[prefix].delete(cat);btn.style.borderColor='';btn.style.color='';}else{checkedCats[prefix].add(cat);btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';}};area.appendChild(btn);});}
function buildAssistModes(){const area=document.getElementById('assist-modes');ASSIST_MODES.forEach(m=>{const btn=document.createElement('button');btn.className='btn btn-g btn-sm';btn.textContent=m.name;btn.onclick=()=>{if(checkedModes.has(m.id)){checkedModes.delete(m.id);btn.style.borderColor='';btn.style.color='';}else{checkedModes.add(m.id);btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';}};area.appendChild(btn);});}

async function doAnalyze(mode){
  if(!apiKey){openModal('modal-api-setup');return;}
  const btn=document.getElementById(`${mode==='assist'?'assist':mode}-btn`), result=document.getElementById(`${mode==='assist'?'assist':mode}-result`);
  const prompt=buildAnalyzePrompt(mode); if(!prompt){gmAlert('本文を入力してください');return;}
  btn.disabled=true; result.innerHTML=`<div style="padding:1.2rem;color:var(--ink-dim);font-size:0.8rem;">解析中…</div>`;
  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}]})});
    if(!res.ok){const e=await res.json().catch(()=>{});throw new Error(e?.error?.message||`HTTP ${res.status}`);}
    const data=await res.json(), text=data.candidates?.[0]?.content?.parts?.map(p=>p.text||'').join('')||'（応答なし）';
    result.innerHTML=`<div class="detail-analysis" style="margin-top:1rem;"><div class="detail-analysis-label">解析結果</div><div class="detail-analysis-text" id="ar-${mode}">${escHtml(text)}</div><div class="btn-row" style="margin-top:0.8rem;"><button class="btn btn-g btn-sm" onclick="copyText('ar-${mode}')">コピー</button></div></div>`;
  }catch(e){result.innerHTML=`<div style="color:#c87070;font-size:0.78rem;margin-top:0.8rem;padding:0.8rem;border:1px solid rgba(139,32,32,0.3);border-radius:2px;">エラー: ${escHtml(e.message)}</div>`;if(e.message.includes('401')){apiKey='';localStorage.removeItem(KEY_API);document.getElementById('analyze-locked').style.display='block';document.getElementById('analyze-unlocked').style.display='none';}}
  finally{btn.disabled=false;}
}

// 入力テキストに関連するエントリをキーワードマッチで抽出（共通ヘルパー）
function getRelatedEntries(text, maxCount=4){
  if(!worldDB||!text) return '';
  const tokens=text.toLowerCase().replace(/[、。！？\s]+/g,' ').split(' ').filter(t=>t.length>=2);
  if(!tokens.length) return '';
  const scored=(worldDB.entries||[]).map(e=>{
    const target=(e.title+' '+(e.body||'')+' '+(e.tags||[]).join(' ')).toLowerCase();
    const score=tokens.reduce((s,t)=>s+(target.includes(t)?1:0),0);
    return {e,score};
  }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,maxCount);
  if(!scored.length) return '';
  let ref='\n\n【参照: 世界観資料】\n';
  scored.forEach(({e})=>{
    const cat=(worldDB.categories||[]).find(c=>c.id===e.catId);
    ref+=`\n■ ${e.title}${cat?' ('+cat.name+')':''}\n${(e.body||'').slice(0,400)}${(e.body||'').length>400?'…':''}\n`;
  });
  return ref;
}
function buildAnalyzePrompt(mode){
  if(mode==='opp'){const text=document.getElementById('opp-text').value.trim();if(!text)return null;const supp=document.getElementById('opp-supp').value.trim(),cats=[...checkedCats.opp];let p='あなたは中世ファンタジーのロールプレイセッションにおける世界観分析の専門家です。以下の相手プレイヤーのロール文を、指定された分析カテゴリの観点から詳細に分析してください。\n\n';if(supp)p+=`【世界観・設定補足】\n${supp}\n\n`;p+=`【相手のロール本文】\n${text}\n\n`;const rel=getRelatedEntries(text);if(rel)p+=rel+'\n\n';if(cats.length)p+=`【分析カテゴリ】\n${cats.join('、')}\n\n`;p+='各カテゴリについて、ロール文から読み取れる情報・含意・世界観的整合性・注目すべき要素を鋭く分析してください。';return p;}
  if(mode==='self'){const text=document.getElementById('self-text').value.trim();if(!text)return null;const supp=document.getElementById('self-supp').value.trim(),cats=[...checkedCats.self];let p='あなたは中世ファンタジーのロールプレイセッションにおける世界観分析の専門家です。以下の自分のロール文を各カテゴリの観点から分析し、強みと課題を公平に評価してください。おべっかは不要です。\n\n';if(supp)p+=`【世界観・設定補足】\n${supp}\n\n`;p+=`【自分のロール本文】\n${text}\n\n`;const rel=getRelatedEntries(text);if(rel)p+=rel+'\n\n';if(cats.length)p+=`【分析カテゴリ】\n${cats.join('、')}\n\n`;p+='各カテゴリについて、世界観的な精度・表現の質・改善の余地を具体的に指摘してください。';return p;}
  const ctx=document.getElementById('assist-ctx').value.trim();if(!ctx)return null;const chara=document.getElementById('assist-chara').value.trim(),modes=[...checkedModes].map(id=>ASSIST_MODES.find(m=>m.id===id)?.name).filter(Boolean);let p='あなたは中世ファンタジーのロールプレイセッションにおけるロール作成補助の専門家です。\n\n';if(chara)p+=`【自分のキャラクター情報】\n${chara}\n\n`;p+=`【現在の状況・文脈】\n${ctx}\n\n`;const rel=getRelatedEntries(ctx);if(rel)p+=rel+'\n\n';if(modes.length)p+=`【補助モード】\n${modes.join('、')}\n\n`;p+='各モードに応じた提案・草案を世界観と整合的な表現で具体的に提示してください。';return p;
}

// ══ ユーティリティ ══
function downloadJSON(obj,name){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);}
function copyText(id){const el=document.getElementById(id);if(!el)return;navigator.clipboard.writeText(el.textContent).then(()=>{const b=el.parentElement?.querySelector('button');if(b){const o=b.textContent;b.textContent='✓ コピー済';setTimeout(()=>b.textContent=o,1500);}});}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escAttr(s){return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

// ══════════════════════════════════════
// カバンポップ
// ══════════════════════════════════════
let bagOpen=false;
function toggleBag(){
  bagOpen=!bagOpen;
  document.getElementById('bag-btn').classList.toggle('open',bagOpen);
  document.getElementById('bag-menu').classList.toggle('open',bagOpen);
}
function openBagTool(tool){
  bagOpen=false;
  document.getElementById('bag-btn').classList.remove('open');
  document.getElementById('bag-menu').classList.remove('open');
  openModal(`modal-${tool}`);
  if(tool==='memo') initMemoFlat();
  if(tool==='mind'||tool==='memo') setTimeout(initMindmap,50);
}

// ── 電卓 ──
let calcBuf='0', calcPrev='', calcOperator='', calcNewNum=true;
function calcDisplay(){document.getElementById('calc-val').textContent=calcBuf;}
function calcNum(n){
  if(calcNewNum){calcBuf=n;calcNewNum=false;}
  else calcBuf=calcBuf==='0'?n:calcBuf+n;
  calcDisplay();
}
function calcDot(){
  if(calcNewNum){calcBuf='0.';calcNewNum=false;}
  else if(!calcBuf.includes('.'))calcBuf+='.';
  calcDisplay();
}
function calcOp(op){
  if(calcOperator&&!calcNewNum)calcEqual();
  calcPrev=calcBuf;calcOperator=op;calcNewNum=true;
  const sym={'+':'＋','-':'−','*':'×','/':'÷'};
  document.getElementById('calc-expr').textContent=`${calcPrev} ${sym[op]||op}`;
}
function calcEqual(){
  if(!calcOperator)return;
  const a=parseFloat(calcPrev),b=parseFloat(calcBuf);
  let r;
  if(calcOperator==='+')r=a+b;
  else if(calcOperator==='-')r=a-b;
  else if(calcOperator==='*')r=a*b;
  else if(calcOperator==='/')r=b!==0?a/b:'Error';
  const sym={'+':'＋','-':'−','*':'×','/':'÷'};
  document.getElementById('calc-expr').textContent=`${calcPrev} ${sym[calcOperator]||calcOperator} ${calcBuf} =`;
  calcBuf=r==='Error'?'Error':String(parseFloat(r.toFixed(10)));
  calcOperator='';calcNewNum=true;calcDisplay();
}
function calcClear(){calcBuf='0';calcPrev='';calcOperator='';calcNewNum=true;document.getElementById('calc-expr').textContent='';calcDisplay();}
function calcBack(){
  if(calcNewNum)return;
  calcBuf=calcBuf.length>1?calcBuf.slice(0,-1):'0';
  if(calcBuf==='-')calcBuf='0';
  calcDisplay();
}

let mmFullscreen=false;
function mmToggleFullscreen(){
  mmFullscreen=!mmFullscreen;
  const modal=document.querySelector('#modal-memo .bag-modal');
  const canvas=document.getElementById('mindmap-canvas');
  const overlay=document.getElementById('modal-memo');
  if(mmFullscreen){
    modal.style.maxWidth='100vw';
    modal.style.maxHeight='100vh';
    modal.style.width='100vw';
    modal.style.height='100vh';
    modal.style.borderRadius='0';
    overlay.style.padding='0';
    canvas.style.height='calc(100vh - 120px)';
  } else {
    modal.style.maxWidth='520px';
    modal.style.maxHeight='85vh';
    modal.style.width='100%';
    modal.style.height='';
    modal.style.borderRadius='';
    overlay.style.padding='1rem';
    canvas.style.height='340px';
  }
  setTimeout(()=>{resizeMmCanvas();renderMindmap();},50);
}
function calcPercent(){calcBuf=String(parseFloat(calcBuf)/100);calcDisplay();}

// ── メモ帳 ──
const MEMO_KEY='gm_memo_flat';
function initMemoFlat(){
  const saved=localStorage.getItem(MEMO_KEY)||'';
  document.getElementById('memo-flat-text').value=saved;
  document.getElementById('memo-flat-text').oninput=()=>localStorage.setItem(MEMO_KEY,document.getElementById('memo-flat-text').value);
}
function switchMemoTab(tab){
  document.getElementById('memo-flat-panel').style.display=tab==='flat'?'block':'none';
  document.getElementById('memo-mind-panel').style.display=tab==='mind'?'block':'none';
  document.getElementById('memo-tab-flat').classList.toggle('active',tab==='flat');
  document.getElementById('memo-tab-mind').classList.toggle('active',tab==='mind');
  if(tab==='mind')setTimeout(()=>{initMindmap();renderMindmap();},50);
}
function clearFlatMemo(){gmConfirm('メモをクリアしますか？',()=>{document.getElementById('memo-flat-text').value='';localStorage.removeItem(MEMO_KEY);});}
function copyFlatMemo(){navigator.clipboard.writeText(document.getElementById('memo-flat-text').value).then(()=>{const b=document.querySelector('#memo-flat-panel .btn-g:last-child');const o=b.textContent;b.textContent='✓ コピー済';setTimeout(()=>b.textContent=o,1500);});}

// ── マインドマップ ──
const MM_KEY='gm_mindmap';
let mmNodes=[],mmEdges=[],mmSelectedId=null,mmNextId=1;
let mmCanvas=null,mmCtx=null,mmDragging=null,mmDragOX=0,mmDragOY=0;

function initMindmap(){
  mmCanvas=document.getElementById('mindmap-canvas');
  if(!mmCanvas)return;
  const saved=localStorage.getItem(MM_KEY);
  if(saved){
    try{
      const d=JSON.parse(saved);
      mmNodes=d.nodes||[];
      mmEdges=d.edges||[];
      mmNextId=d.nextId||mmNodes.length+1;
      // 旧データにsize/colorがない場合に補完
      mmNodes.forEach(n=>{
        if(!n.size) n.size=n.root?42:34;
        if(!n.color) n.color='#b87333';
      });
    }catch{mmNodes=[];mmEdges=[];}
  }
  mmCtx=mmCanvas.getContext('2d');
  resizeMmCanvas();
  mmCanvas.onmousedown=mmCanvas.ontouchstart=mmPointerDown;
  mmCanvas.onmousemove=mmCanvas.ontouchmove=mmPointerMove;
  mmCanvas.onmouseup=mmCanvas.ontouchend=mmPointerUp;
  renderMindmap();
}
function resizeMmCanvas(){
  if(!mmCanvas)return;
  const dpr=window.devicePixelRatio||1;
  const w=mmCanvas.offsetWidth||300;
  const h=mmCanvas.offsetHeight||340;
  mmCanvas.width=w*dpr;
  mmCanvas.height=h*dpr;
  mmCanvas.style.width=w+'px';
  mmCanvas.style.height=h+'px';
  mmCtx=mmCanvas.getContext('2d');
  mmCtx.scale(dpr,dpr);
  // ノードが未配置（新規）なら中央に
  if(!mmNodes.length){
    mmNodes=[{id:1,x:w/2,y:h/2,text:'中心',root:true,size:42,color:'#b87333'}];
    mmNextId=2;
  } else if(mmNodes.length===1&&mmNodes[0].x===0&&mmNodes[0].y===0){
    mmNodes[0].x=w/2;
    mmNodes[0].y=h/2;
  }
  renderMindmap();
}
function saveMindmap(){localStorage.setItem(MM_KEY,JSON.stringify({nodes:mmNodes,edges:mmEdges,nextId:mmNextId}));}

function mmHexToRgba(hex,a){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

function renderMindmap(){
  if(!mmCanvas){return;}
  if(!mmCtx){mmCtx=mmCanvas.getContext('2d');}
  const c=mmCtx;
  const dpr=window.devicePixelRatio||1;
  const w=mmCanvas.width/dpr;
  const h=mmCanvas.height/dpr;
  c.clearRect(0,0,w,h);
  // エッジ
  mmEdges.forEach(e=>{
    const a=mmNodes.find(n=>n.id===e.from),b=mmNodes.find(n=>n.id===e.to);
    if(!a||!b)return;
    c.beginPath();c.moveTo(a.x,a.y);c.lineTo(b.x,b.y);
    c.strokeStyle='rgba(184,115,51,0.35)';c.lineWidth=1;c.stroke();
  });
  // ノード
  mmNodes.forEach(n=>{
    const sz=n.size||(n.root?42:34);
    const col=n.color||'#b87333';
    const sel=n.id===mmSelectedId;
    const ry=Math.round(sz*0.48);
    c.beginPath();c.ellipse(n.x,n.y,sz,ry,0,0,Math.PI*2);
    c.fillStyle=mmHexToRgba(col, n.root?0.22:sel?0.18:0.08);
    c.fill();
    c.strokeStyle=sel?col:mmHexToRgba(col,n.root?0.75:0.45);
    c.lineWidth=sel?2:1;
    c.stroke();
    c.fillStyle=sel?'#e8dece':n.root?'#c8b89a':'#a89880';
    c.font=`${n.root?'600 ':''}${Math.max(10,Math.round(sz*0.3))}px Noto Serif JP,serif`;
    c.textAlign='center';c.textBaseline='middle';
    const maxChars=Math.max(4,Math.round(sz/6));
    c.fillText(n.text.length>maxChars?n.text.slice(0,maxChars)+'…':n.text,n.x,n.y);
  });
}

function mmGetNode(x,y){
  return mmNodes.slice().reverse().find(n=>{
    const sz=n.size||(n.root?42:34);
    const ry=sz*0.48;
    const dx=n.x-x,dy=n.y-y;
    return dx*dx/(sz*sz)+dy*dy/(ry*ry)<=1;
  });
}

function mmUpdatePanel(){
  const panel=document.getElementById('mm-node-panel');
  if(!panel)return;
  if(!mmSelectedId){panel.style.display='none';return;}
  const n=mmNodes.find(n=>n.id===mmSelectedId);
  if(!n){panel.style.display='none';return;}
  panel.style.display='flex';
  const sz=n.size||(n.root?42:34);
  document.getElementById('mm-size-slider').value=sz;
  document.getElementById('mm-size-val').textContent=sz;
  document.getElementById('mm-color-picker').value=n.color||'#b87333';
}

function mmSetSize(val){
  if(!mmSelectedId)return;
  const n=mmNodes.find(n=>n.id===mmSelectedId);
  if(!n)return;
  n.size=parseInt(val);
  document.getElementById('mm-size-val').textContent=val;
  saveMindmap();renderMindmap();
}
function mmSetColor(val){
  if(!mmSelectedId)return;
  const n=mmNodes.find(n=>n.id===mmSelectedId);
  if(!n)return;
  n.color=val;
  saveMindmap();renderMindmap();
}

function mmPointerDown(e){
  e.preventDefault();
  const rect=mmCanvas.getBoundingClientRect();
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  const x=cx-rect.left,y=cy-rect.top;
  const n=mmGetNode(x,y);
  if(n){mmSelectedId=n.id;mmDragging=n;mmDragOX=x-n.x;mmDragOY=y-n.y;}
  else mmSelectedId=null;
  mmUpdatePanel();
  renderMindmap();
}
function mmPointerMove(e){
  if(!mmDragging)return;
  e.preventDefault();
  const rect=mmCanvas.getBoundingClientRect();
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  mmDragging.x=cx-rect.left-mmDragOX;
  mmDragging.y=cy-rect.top-mmDragOY;
  renderMindmap();
}
function mmPointerUp(){if(mmDragging){saveMindmap();}mmDragging=null;}
function mmAddChild(){
  if(!mmSelectedId){gmAlert('ノードを選択してください');return;}
  const parent=mmNodes.find(n=>n.id===mmSelectedId);
  gmPrompt('ノードのテキスト','',text=>{
    if(!text)return;
    const angle=Math.random()*Math.PI*2;
    const dist=100+Math.random()*40;
    const newNode={id:mmNextId++,x:parent.x+Math.cos(angle)*dist,y:parent.y+Math.sin(angle)*dist,text,size:34,color:'#b87333'};
    mmNodes.push(newNode);
    mmEdges.push({from:parent.id,to:newNode.id});
    mmSelectedId=newNode.id;
    mmUpdatePanel();
    saveMindmap();renderMindmap();
  });
}
function mmDeleteNode(){
  if(!mmSelectedId)return;
  const n=mmNodes.find(n=>n.id===mmSelectedId);
  if(n?.root){gmAlert('ルートノードは削除できません');return;}
  gmConfirm('このノードを削除しますか？',()=>{
    mmNodes=mmNodes.filter(n=>n.id!==mmSelectedId);
    mmEdges=mmEdges.filter(e=>e.from!==mmSelectedId&&e.to!==mmSelectedId);
    mmSelectedId=null;mmUpdatePanel();saveMindmap();renderMindmap();
  });
}
function mmEditNode(){
  if(!mmSelectedId){gmAlert('ノードを選択してください');return;}
  const n=mmNodes.find(n=>n.id===mmSelectedId);
  gmPrompt('テキストを編集',n.text,text=>{
    n.text=text||n.text;saveMindmap();renderMindmap();
  });
}
function mmClear(){
  gmConfirm('マインドマップを全消去しますか？',()=>{
    const dpr=window.devicePixelRatio||1;
    const w=mmCanvas.width/dpr,h=mmCanvas.height/dpr;
    mmNodes=[{id:1,x:w/2,y:h/2,text:'中心',root:true,size:42,color:'#b87333'}];
    mmEdges=[];mmNextId=2;mmSelectedId=null;mmUpdatePanel();saveMindmap();renderMindmap();
  });
}

// ── ダイス ──
const KEY_DICE_ANIM='gm_dice_anim';
let diceAnimMode=localStorage.getItem(KEY_DICE_ANIM)||'shake';
let diceHistory=[];

function setDiceAnim(mode){
  diceAnimMode=mode;
  localStorage.setItem(KEY_DICE_ANIM,mode);
  const labels={shake:'シェイク',spin:'スピン',off:'OFF'};
  document.getElementById('dice-anim-current').textContent=labels[mode]||mode;
  ['shake','spin','off'].forEach(m=>{
    const btn=document.getElementById(`dice-anim-${m}`);
    if(btn)btn.className=`btn btn-sm ${m===mode?'btn-p':'btn-g'}`;
  });
}

function rollDice(faces){
  if(isNaN(faces)||faces<2){gmAlert('正しい面数を入力してください');return;}
  const result=Math.floor(Math.random()*faces)+1;
  const el=document.getElementById('dice-result');

  // アイコンアニメーション
  const clickedBtn=event?.currentTarget;
  if(clickedBtn&&diceAnimMode!=='off'){
    const icon=clickedBtn.querySelector('.dice-icon');
    if(icon){
      icon.classList.remove(`dice-icon-anim-${diceAnimMode}`);
      void icon.offsetWidth;
      icon.classList.add(`dice-icon-anim-${diceAnimMode}`);
      setTimeout(()=>icon.classList.remove(`dice-icon-anim-${diceAnimMode}`),800);
    }
  }

  // 結果アニメーション
  el.classList.remove('dice-result-roll-shake','dice-result-roll-spin','dice-result-roll-off');
  void el.offsetWidth;
  if(diceAnimMode==='shake'){
    el.classList.add('dice-result-roll-shake');
  } else if(diceAnimMode==='spin'){
    // スピン中は数字をカウントアップ
    let count=0;
    const total=20;
    const interval=setInterval(()=>{
      el.textContent=Math.floor(Math.random()*faces)+1;
      count++;
      if(count>=total){clearInterval(interval);el.textContent=result;}
    },55);
    el.classList.add('dice-result-roll-spin');
  } else {
    el.textContent=result;
    el.classList.add('dice-result-roll-off');
  }

  if(diceAnimMode!=='spin') el.textContent=result;
  document.getElementById('dice-result-label').textContent=`D${faces}`;
  diceHistory.unshift(`D${faces}: ${result}`);
  if(diceHistory.length>10)diceHistory.pop();
  document.getElementById('dice-history').innerHTML=diceHistory.map(h=>`<span style="margin-right:0.8rem;">${h}</span>`).join('');
}

// ── カバンボタン表示 ──
function showBagBtn(){document.getElementById('bag-btn').classList.add('visible');}

// ── バックアップリマインダー ──
function checkBackupReminder(){
  if(!characters.length&&!roles.length) return; // データなし → 不要
  const last=parseInt(localStorage.getItem(KEY_LAST_EXPORT)||'0');
  const dismissed=parseInt(localStorage.getItem('gm_remind_dismissed')||'0');
  const now=Date.now();
  const days30=BACKUP_REMIND_DAYS*24*60*60*1000;
  // 前回エクスポートが30日以上前 かつ「後で」を押してから7日以上経過
  if((now-last)>days30 && (now-dismissed)>7*24*60*60*1000){
    document.getElementById('backup-reminder').classList.add('visible');
  }
}
function dismissBackupReminder(){
  localStorage.setItem('gm_remind_dismissed', String(Date.now()));
  const el=document.getElementById('backup-reminder');
  el.style.opacity='0';
  el.style.transition='opacity 0.4s';
  setTimeout(()=>{el.classList.remove('visible');el.style.opacity='';el.style.transition='';},400);
}

// ══ 起動 ══
(function init(){
  document.body.classList.add('title-active');
  characters=JSON.parse(localStorage.getItem(KEY_CHARS)||'[]');
  roles=JSON.parse(localStorage.getItem(KEY_ROLES)||'[]');
  worldDB=JSON.parse(localStorage.getItem(KEY_DB)||'null');
  apiKey=localStorage.getItem(KEY_API)||'';
  loadOptions();
  buildAnalyzeCats('opp'); buildAnalyzeCats('self'); buildAssistModes();
  if(worldDB)populateDBCatFilter();
  if(apiKey)unlockAnalyze();
  showView('char-list-view');
  // Service Worker登録
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
  // バックグラウンド時にBGM停止・復帰時に再開
  document.addEventListener('visibilitychange',()=>{
    if(!_bgmCtx)return;
    if(document.hidden){
      _bgmCtx.suspend().catch(()=>{});
    } else {
      _bgmCtx.resume().catch(()=>{});
    }
  });
})();
</script>
</body>
</html>
